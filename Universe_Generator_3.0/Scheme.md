# Scheme — полная схема фреймворка Yggdrasil (Universe Generator 3.0)

**Назначение:** единый документ **архитектуры всего фреймворка** — от фундамента до вселенной. Scheme задаёт *как* всё устроено и материализовано: конфигурация, уровни, цикл мира, state, контракты и связь с документацией. Он не есть сама реализация (код/рантайм), а **идея материализации** — полная и детальная схема, на которой строится канон и код.

**Философия — якорь.** [Philosophy.md](Philosophy.md) — **единственный идеологический ориентир** проекта. Философия **полностью завершена** и **не подлежит изменению**; она задаёт *зачем* и *почему*. Scheme и канон должны ей **соответствовать**; при противоречии пересматриваются схема и реализация, а не философия. Данный документ опирается на всю философию проекта и на документацию канона (WorldGenerator_2.0 и docs/).

**Язык:** русский.

**Движок 0.3.0:** система работает с **гиперграфом**; на каждом уровне иерархии структура представлена и исполняется как гиперграф (обычный граф — частный случай при гиперрёбрах размера 2).

---

## 1. Новый канон на основе старого

**Новый канон** строится **не с нуля**, а **на основе старого**. Старый канон — **WorldGenerator_2.0**: два начала, блок/узел, уровни, цикл мира, state, Среда, вселенная, агенты, сериализация и т.д. служат **фундаментом**. Новый канон — **Universe Generator 3.0**: [Scheme.md](Scheme.md) (этот файл) и связанная документация в [docs/](docs/). Все решения по схеме и реализации должны **соответствовать философии**; при противоречии сначала пересматривается схема или канон в рамках философских принципов.

**Якорь** нового канона — **Philosophy.md**. Референс архитектуры — папка [../WorldGenerator_2.0/](../WorldGenerator_2.0/).

---

## 2. Основание: два начала и фундамент

Вся система держится на **двух началах** и их **синтезе** (см. Philosophy, Часть II–III).

| Начало | Сущность в проекте | Смысл |
|--------|--------------------|--------|
| **Материальное** | **Abstract Base Block** (блок) | Хранит и несёт: параметры, тензоры, данные, конфигурацию, состояние. **Атом сборки.** |
| **Идеальное** | **Abstract Graph Node** (узел гиперграфа) | Задаёт **место** и **связи** (гиперрёбра). Не хранит содержание — только положение и связи. |

**Правило синтеза:** **любой блок может стать узлом гиперграфа.** Материя (блок) получает идеальную форму (место и связи); система как целое — **гиперграф**, узлы которого содержат блоки, по гиперрёбрам передаётся поток (данные или state). **Гиперграф** — снятие (Aufhebung) двух начал в одном понятии.

**Контракт блока:** объявление портов (входы/выходы), выполнение **run**(входы) → выходы, идентификация (block_type, block_id). **Контракт узла:** положение в гиперграфе, входящие и исходящие гиперрёбра, семантика портов на уровне графа. Полная техническая спецификация фундамента: [docs/00_FOUNDATION.md](docs/00_FOUNDATION.md).

**Уровень над фундаментом:** абстрактные узлы-задачи (Agent, Backbone, Solver, Codec, Adapter, Conditioner, Tokenizer, Guidance и др.) — **двойное наследование** Block и Node; одна сущность как материя и форма. Спецификации: [../WorldGenerator_2.0/Abstract_Block_And_Node.md](../WorldGenerator_2.0/Abstract_Block_And_Node.md), [../WorldGenerator_2.0/Abstract_Task_Nodes.md](../WorldGenerator_2.0/Abstract_Task_Nodes.md).

--- 

## 3. Иерархия уровней: общая схема

На каждом уровне структура — **гиперграф**; различается **что является узлом** и **что течёт по связям**.

| Уровень | Узлы гиперграфа | Что течёт по связям | Описание |
|---------|------------------|----------------------|----------|
| **Граф (задача)** | Узлы-задачи (Backbone, Solver, Codec, Conditioner, …) | **Данные** между портами | **Одна цельная задача** (text-to-image, upscale, image-to-video и т.д.). Первый исполняемый уровень. |
| **Пайплайн** | Целые гиперграфы задач | **Данные** между графами | **Комбинированные задачи** (текст → картинка → апскейл → видео). Гиперграф гиперграфов. |
| **Переход (Stage)** | Пайплайны | **State** (в контексте мира) | **Одна метаморфоза** state. Stage = гиперграф пайплайнов. Реализует один переход цикла мира. |
| **Мир (World)** | **Переходы** (Философ, Автор, Среда, Архитектор, Творец) | **State** (пять блоков) | **Непрерывная цепь переходов.** Мир = гиперграф переходов; по рёбрам передаётся state; цикл фиксирован. |
| **Вселенная (Universe)** | **Миры** | **Обмен** (payload_spec: state snapshot, артефакты, сущности) | **Гиперграф миров.** Высший уровень. Эфир вселенной; сообщество; End Worlds. |

**Единая форма:** на всех уровнях — гиперграф, порты, run, контракт. Меняется только масштаб (узел = задача, граф, пайплайн, переход, мир). Подробно по уровням: [../WorldGenerator_2.0/Graph_Level.md](../WorldGenerator_2.0/Graph_Level.md), [../WorldGenerator_2.0/Pipeline_Level.md](../WorldGenerator_2.0/Pipeline_Level.md), [../WorldGenerator_2.0/Stage_Level.md](../WorldGenerator_2.0/Stage_Level.md), [../WorldGenerator_2.0/World_Level.md](../WorldGenerator_2.0/World_Level.md), [../WorldGenerator_2.0/EXPANSION_UNIVERSE_GRAPH_OF_WORLDS.md](../WorldGenerator_2.0/EXPANSION_UNIVERSE_GRAPH_OF_WORLDS.md).

---

## 4. Уровень графа задачи

**Гиперграф задачи** — первый уровень, на котором система **исполняется**. Узлы — узлы-задачи (Backbone, Solver, Codec, Conditioner, Tokenizer, …); по гиперрёбрам передаются **данные** между портами. Один гиперграф = **одна цельная задача** (например, text-to-image). Комбинирование нескольких задач — на уровне **пайплайна**. [../WorldGenerator_2.0/Graph_Level.md](../WorldGenerator_2.0/Graph_Level.md).

---

## 5. Уровень пайплайна

**Пайплайн** — **гиперграф, узлами которого являются целые гиперграфы задач**. По гиперрёбрам передаются **данные** между выходами одного графа и входами другого. Служит для **комбинированных сценариев** (цепочка или ветвление задач). Пайплайн может состоять из одного графа (вырожденный случай). [../WorldGenerator_2.0/Pipeline_Level.md](../WorldGenerator_2.0/Pipeline_Level.md).

---

## 6. Уровень перехода (Stage)

**Переход (transition)** — **метаморфоза**: фундаментальное изменение состояния (материя ↔ идея, объект в объект). **Stage** — уровень, на котором реализуется **один** такой переход: **Stage = гиперграф пайплайнов**. В контексте мира между переходами передаётся **state**; каждый переход читает и/или дополняет state. Каждое звено цикла мира (Философ, Автор, Среда, Архитектор, Творец) — **переход**, реализуемый одним Stage. [../WorldGenerator_2.0/Stage_Level.md](../WorldGenerator_2.0/Stage_Level.md).

---

## 7. Уровень мира: цикл, state, Среда

### 7.1 Мир как цепочка переходов

**Мир (World)** — **непрерывная цепь крупномасштабных переходов**. Структурно: **гиперграф, узлами которого являются переходы**; по рёбрам передаётся **state**. Порядок выполнения **фиксирован**; граф **циклический**.

**Цикл мира (порядок переходов):**

```
  Философ  →  Автор  →  Среда  →  Архитектор  →  Творец  →  …
```

После Творца state с блоком 3 снова попадает в Философ — цикл повторяется. Мир **один**; он обновляется применением state (World update при полном state); новый state порождается в **Development of the world** (часть Среды). **Мир может развиваться сам**, итеративно; Action пользователя **опционален**. [../WorldGenerator_2.0/World_Level.md](../WorldGenerator_2.0/World_Level.md).

### 7.2 State — пять блоков

**State** (состояние мира) задаётся **пятью блоками**:

| № | Блок | Смысл в цикле |
|---|------|----------------|
| **1** | Описание того, что должно было произойти | Намерение; порождается в Development of the world. Вход Архитектора. |
| **2** | Конфигурация для генерации артефактов | План воплощения; выход Архитектора, вход Творца. |
| **3** | Сгенерированные артефакты | Материальный результат; выход Творца, вход Философа. |
| **4** | Описание сгенерированных артефактов | Идеализация; выход Философа, вход Автора. |
| **5** | Описание того, что реально произошло в мире | Нарратив последствий; выход Автора. Вход World update. |

**World update** выполняется **только при полностью заполненном state** (все пять блоков): тогда state применяется к миру (контент мира обновляется), state сохраняется. Иначе World update не выполняется, state снимается с обработки.

### 7.3 Среда (Environment) — два узла подряд

**Среда** в графе мира — **два последовательных узла**:

| № | Узел | Вход | Условие / Действие | Выход |
|---|------|------|---------------------|--------|
| **1** | **World update** | State | Выполняется **только если state полностью заполнен** (все 5 блоков). Применить state к миру, обновить контент мира, сохранить state. Иначе — пропуск. | Завершение текущего витка. |
| **2** | **Development of the world** | Опционально **Action** (как контекст для LLM) | Выполняется **безусловно**. Читает мир; с учётом Action (если передан) или без него генерирует описание следующего шага; создаёт **новый state** с заполненным **только блоком 1**. | Новый state → вход в переход **Архитектор**. |

После Development новый state идёт в **Архитектор → Творец → Философ → Автор → Среда** — цикл повторяется.

### 7.4 Идеальные задачи пяти переходов

| Переход | Идеальная задача | Вход state | Выход state |
|---------|-------------------|------------|-------------|
| **Философ** | Описание и идеализация материального. Артефакты (блок 3) → описание (блок 4). | Блоки 1, 2, 3 заполнены | Блок 4 |
| **Автор** | Нарратив в контексте мира. Идеальное описание (блок 4) → «что реально произошло» (блок 5). Контекст — неизменённый мир. | Блоки 1–4 заполнены | Блок 5 |
| **Среда** | (1) World update — применение state к миру при полном state; (2) Development of the world — новый state с блоком 1. | State; опционально Action | Новый state с блоком 1 |
| **Архитектор** | Идея → техническая структура. Описание (блок 1) → конфигурация генерации (блок 2). Контекст — изменённый мир. | Блок 1 | Блок 2 |
| **Творец** | Конфигурация → материя. По конфигурации (блок 2) генерация артефактов (блок 3). | Блок 2 | Блок 3 |

**Условия выполнения:** Философ — только при заполненных 1, 2, 3; Автор — только при 1–4; World update — только при всех пяти блоках. Архитектор и Творец по потоку цикла всегда получают нужные блоки (1 и 2 соответственно).

### 7.5 Первая итерация и передача state пользователем

**Если пользователь не передал state** (или передал пустой): на **первой итерации** пропускаются **Философ**, **Автор** и **World update**. Цикл **начинается с Development of the world** — он создаёт **первый state** (блок 1); затем state идёт в Архитектор → Творец → Философ → Автор → Среда. Философски: мир способен породить первый шаг **из себя**, без обязательного внешнего толчка.

**Передача state пользователем** (первый вход в цикл): каждый переход выполняется только при заполненных нужных ему блоках. Например: только блок 1 или 1–2 — Философ и Автор пропускаются, World update не выполняется. Блоки 1–2–3 — Философ → блок 4, Автор → блок 5, затем World update при полном state. Подробные таблицы: [../WorldGenerator_2.0/Scheme.md](../WorldGenerator_2.0/Scheme.md) §4.8.

### 7.6 Action и артефакты

| Термин | Определение |
|--------|-------------|
| **Action** | **Опциональное** взаимодействие пользователя с миром в начале шага (реплика, команда, выбор). Поступает в **Development of the world** как **контекст для LLM**. При отсутствии Action Development выполняется безусловно и создаёт следующий эпизод по текущему состоянию мира. |
| **Артефакты** | Между Автором и Архитектором передаётся **один контейнер слотов** (images, videos, audios, …). В материальной форме — данные; в идеальной — описания. Формат задаётся каноном. |

### 7.7 Связь цикла мира с кругом Хармона

Цикл мира **структурно соответствует** кругу Дэна Хармона (Story Circle): статус-кво (You) → желание (Need = блок 1) → выход (Go = Архитектор) → поиск (Search = Творец) → обретение (Find = Философ) → цена (Take = Автор) → возврат (Return = World update) → изменение (Change = новый статус-кво). Один виток цикла мира = одна нарративная единица. Подробно: [docs/HARMON_CIRCLE_AND_WORLD_CYCLE.md](docs/HARMON_CIRCLE_AND_WORLD_CYCLE.md); философия связи — Philosophy.md п. 7.8.

---

## 8. Уровень вселенной

**Вселенная (Universe)** — **высший уровень проекта**. Выше вселенной в иерархии уровня **нет**. Вселенная представляема **гиперграфом миров**: узлы = миры (объектные или End Worlds), гиперрёбра = связи между мирами; по ним передаётся обмен (payload_spec: state snapshot, артефакты, контекст, сущности с состоянием — персонажи, агенты). **Единый «эфир вселенной»** — общая среда (контекст, поток трансляции, при необходимости общее хранилище). Уровень Вселенной предназначен **в первую очередь для сообщества**: сравнение миров, развитие через взаимодействие персонажей и миров, обмен, группы миров, влияние на экосистему. **End Worlds** — миры фиксированные, только чтение; к ним можно привязываться по гиперссылкам. [../WorldGenerator_2.0/EXPANSION_UNIVERSE_GRAPH_OF_WORLDS.md](../WorldGenerator_2.0/EXPANSION_UNIVERSE_GRAPH_OF_WORLDS.md).

---

## 9. Контракт, сериализация, расширяемость

- **Контракт:** на каждом уровне — объявление портов (входы/выходы), **run**, идентификация, сериализация (конфиг + чекпоинт). Новые сущности вводятся **без изменений движка** — только реализация контракта и регистрация в реестре.
- **Сериализация:** полностью на всех уровнях — блок, граф, пайплайн, переход, мир, вселенная. Конфиг структуры + чекпоинт весов; загрузка и сохранение по правилам канона. Мир: два крупных поля — (1) структура/исполняемая часть, (2) контент мира; End World — только контент.
- **Расширяемость только через контракт:** форк ядра не считается допустимым способом расширения. Любая модель, любой переход, любое взаимодействие миров реализуются через контракт и регистрацию.

---

## 10. Граница системы и внешние источники

**Внутри системы:** всё, что подчиняется единому контракту и реестру (блоки, узлы, гиперграфы, пайплайны, переходы, миры, вселенные). **Снаружи:** пользователь (Action), внешние API (LLM, VLM, сервисы), вики-ресурсы (Fandom, Wikipedia). Система **проницаема** на границе: внешнее входит через те же порты и контракт (блок через API, мир из вики). Онтология **заканчивается на вселенной**; выше — использование системы (сообщество, платформа, реальный мир). Уровень метавселенной **не вводится** (Philosophy 12.3).

---

## 11. Канон и документация: граф ссылок

### 11.1 Старый канон (референс)

| Документ | Назначение |
|----------|------------|
| [../WorldGenerator_2.0/CANON.md](../WorldGenerator_2.0/CANON.md) | Единый канон WG 2.0. |
| [../WorldGenerator_2.0/Scheme.md](../WorldGenerator_2.0/Scheme.md) | Операционная схема мира: цикл, state, Среда, жизненный цикл, первая итерация, передача state. |
| [../WorldGenerator_2.0/System.md](../WorldGenerator_2.0/System.md) | Система от основания до мира (сводка уровней). |
| [../WorldGenerator_2.0/Abstract_Block_And_Node.md](../WorldGenerator_2.0/Abstract_Block_And_Node.md) | Фундамент: Block, Node. |
| [../WorldGenerator_2.0/Abstract_Task_Nodes.md](../WorldGenerator_2.0/Abstract_Task_Nodes.md) | Узлы-задачи (Backbone, Solver, Codec, …). |
| [../WorldGenerator_2.0/Graph_Level.md](../WorldGenerator_2.0/Graph_Level.md) | Уровень графа задачи. |
| [../WorldGenerator_2.0/Pipeline_Level.md](../WorldGenerator_2.0/Pipeline_Level.md) | Уровень пайплайна. |
| [../WorldGenerator_2.0/Stage_Level.md](../WorldGenerator_2.0/Stage_Level.md) | Уровень перехода (Stage). |
| [../WorldGenerator_2.0/World_Level.md](../WorldGenerator_2.0/World_Level.md) | Уровень мира. |
| [../WorldGenerator_2.0/EXPANSION_UNIVERSE_GRAPH_OF_WORLDS.md](../WorldGenerator_2.0/EXPANSION_UNIVERSE_GRAPH_OF_WORLDS.md) | Уровень вселенной. |

Дополнительно в WG 2.0: сериализация мира, агенты, API, гиперграф и гиперссылки, End Worlds — см. [../WorldGenerator_2.0/README.md](../WorldGenerator_2.0/README.md).

### 11.2 Документация 3.0 (docs/)

| Документ | Назначение |
|----------|------------|
| [docs/README.md](docs/README.md) | Назначение папки docs и навигация. |
| [docs/00_FOUNDATION.md](docs/00_FOUNDATION.md) | Полная техническая спецификация фундамента: Block, Node, гиперграф, исполнитель, реестр, сериализация. |
| [docs/01_ABSTRACT_TASK_BLOCKS.md](docs/01_ABSTRACT_TASK_BLOCKS.md) | Уровень абстрактных блоков-задач: Backbone, Solver, Codec, Conditioner, Adapter, Tokenizer, Guidance, Agent; двойное наследование, контракты портов, реестр. |
| [docs/02_HYPERGRAPH_LEVEL.md](docs/02_HYPERGRAPH_LEVEL.md) | Уровень гиперграфа: гиперграф из блоков-задач, внешние входы/выходы, валидация, agent_loop, сериализация. |
| [docs/03_PIPELINE_LEVEL.md](docs/03_PIPELINE_LEVEL.md) | Уровень пайплайна: пайплайн = гиперграф гиперграфов (узлы = гиперграфы задач), данные между задачами, run(pipeline, inputs)→outputs, сериализация. |
| [docs/04_STAGE_LEVEL.md](docs/04_STAGE_LEVEL.md) | Уровень перехода (Stage): Stage = гиперграф пайплайнов, state (пять блоков), маппинг state↔пайплайн, условия выполнения, пять переходов мира. |
| [docs/05_WORLD_LEVEL.md](docs/05_WORLD_LEVEL.md) | Уровень мира: мир = гиперграф переходов, цикл (Философ→Автор→Среда→Архитектор→Творец), state, Среда (World update + Development), первая итерация, Action. |
| [docs/06_UNIVERSE_LEVEL.md](docs/06_UNIVERSE_LEVEL.md) | Уровень вселенной: вселенная = гиперграф миров, payload_spec, эфир, выполнение, End Worlds, сообщество. |
| [docs/PLAN_DEVELOPMENT_CANON.md](docs/PLAN_DEVELOPMENT_CANON.md) | План разработки нового канона (фазы 0–7). |
| [docs/EXAMPLE_ARITHMETIC_AT_GRAPH_LEVEL.md](docs/EXAMPLE_ARITHMETIC_AT_GRAPH_LEVEL.md) | Пример: арифметика на уровне графа (узлы Add/Mul, один проход). |
| [docs/EXAMPLE_ODES_AND_RECURSIVE_TASKS.md](docs/EXAMPLE_ODES_AND_RECURSIVE_TASKS.md) | Примеры: ОДУ (численные методы, цикл по времени) и рекуррентные задачи (Фибоначчи) через цикл в графе. |
| [docs/RECURSION_AND_HYPERGRAPH.md](docs/RECURSION_AND_HYPERGRAPH.md) | Рекурсия и гиперграф: структурная, по уровням, итерация до сходимости (run_until). |

По мере появления новых файлов в docs/ сюда добавляются ссылки; Scheme задаёт **граф гиперссылок** документации, соответствующий философии и канону.

---

## 12. Сводка: быстрый ориентир

| Вопрос | Ответ |
|--------|--------|
| **Основание?** | Два начала: блок (материя), узел гиперграфа (идея). Правило: блок → узел. Синтез = гиперграф. |
| **Уровни?** | Граф задачи → Пайплайн → Переход (Stage) → Мир → Вселенная. На каждом уровне — гиперграф; по связям — данные или state. |
| **Мир?** | Непрерывная цепь переходов: Философ → Автор → Среда → Архитектор → Творец. По рёбрам — state (пять блоков). Мир один; может развиваться сам. |
| **State?** | Пять блоков: (1) что должно произойти, (2) конфигурация, (3) артефакты, (4) описание артефактов, (5) что реально произошло. World update только при полном state. |
| **Среда?** | Два узла: (1) World update — при полном state применить к миру; (2) Development of the world — безусловно создать новый state с блоком 1 (опционально с учётом Action). |
| **Вселенная?** | Гиперграф миров; эфир вселенной; обмен по гиперрёбрам; сообщество; End Worlds. Высший уровень. |
| **Якорь?** | Philosophy.md — единственный идеологический ориентир; не меняется. Scheme и канон строятся по философии. |

---

**Итог.** Настоящий документ — **полная и детальная схема архитектуры фреймворка** Yggdrasil (Universe Generator 3.0). Он опирается на философию проекта и на весь канон (старый и новый), задаёт иерархию уровней, цикл мира, state, Среда, вселенную, контракт и граф документации. Дальнейшее построение канона и кода ведётся **от этой схемы** в соответствии с [Philosophy.md](Philosophy.md).
