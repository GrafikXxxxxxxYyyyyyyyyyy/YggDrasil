# 05. Уровень мира — полная техническая спецификация

**Назначение:** глубокая и детальная **техническая документация четвёртого исполняемого уровня** для Universe Generator 3.0 (Yggdrasil). Документ задаёт **мир (World)** как **гиперграф переходов**: узлы мира — **переходы (Stage)** (уровня перехода, фаза 4), по рёбрам мира передаётся **state** (контейнер из пяти блоков). Описаны **цикл мира** (порядок: Философ → Автор → Среда → Архитектор → Творец), **Среда** как два подузла (World update при полном state, Development of the world — безусловно, новый state с блоком 1), **условия выполнения** каждого перехода, **первая итерация** без предзаданного state, **передача state пользователем**, **Action** как опциональный контекст для Development, **контент мира** (что обновляется при World update), контракт run мира, построение и сериализация (два поля: исполняемая часть и контент), связь с кругом Хармона и с уровнем вселенной. Это **канонический источник** технических решений уровня мира в каноне 3.0.

**Якорь:** [Philosophy.md](../Philosophy.md) (Часть VII — мир как непрерывное становление, state, пять блоков, Среда, первая итерация, Action, круг Хармона); [Scheme.md](../Scheme.md) §7.

**Предыдущий уровень:** [04_STAGE_LEVEL.md](04_STAGE_LEVEL.md) — переход (Stage) = гиперграф пайплайнов, state на входах/выходах.

**Референс:** [../WorldGenerator_2.0/World_Level.md](../WorldGenerator_2.0/World_Level.md), [../WorldGenerator_2.0/World_Serialization.md](../WorldGenerator_2.0/World_Serialization.md).

**Язык:** русский.

**Связь с планом:** [PLAN_DEVELOPMENT_CANON.md](PLAN_DEVELOPMENT_CANON.md) — фаза 5.

---

## 1. Место уровня в иерархии

| Уровень | Сущность | Что течёт по связям | Описание |
|---------|----------|---------------------|----------|
| **Уровень перехода (Stage)** | Stage — гиперграф пайплайнов | **State** (вход/выход Stage) | Одна метаморфоза state. [04_STAGE_LEVEL.md](04_STAGE_LEVEL.md). |
| **Уровень мира** | **Мир (World)** — гиперграф переходов | **State** (пять блоков) | **Непрерывная цепь переходов.** Узлы = переходы (Философ, Автор, Среда, Архитектор, Творец); порядок фиксирован; граф **циклический**. |
| **Уровень вселенной** | Вселенная — гиперграф миров | Обмен (payload_spec) | Узлы = миры; по гиперрёбрам — state snapshot, артефакты, сущности. [06_UNIVERSE_LEVEL.md](06_UNIVERSE_LEVEL.md) (фаза 6). |

Мир — **верхний уровень онтологии** в рамках одного «реальма»: один мир = одна непрерывная цепь переходов с единым state на каждом шаге. Мир **обновляется** применением state при World update (при полном state); **новый state** порождается внутри цикла в Development of the world. Мир может **развиваться сам**, итеративно; Action пользователя **опционален**.

---

## 2. Определение мира: гиперграф переходов

**Мир (World)** — это **гиперграф, узлами которого являются переходы (Stage)**. Каждый узел мира — один **переход** (реализуемый как Stage — гиперграф пайплайнов по 04_STAGE_LEVEL). По **рёбрам мира** передаётся **state** (контейнер из пяти блоков). Порядок обхода узлов **фиксирован**; в каноне граф **циклический**: после последнего перехода (Творец) state снова попадает в первый по логике цикла (через Среда: Development создаёт новый state с блоком 1 → Архитектор → …).

- **Узлы мира** — **переходы**: Философ, Автор, Среда, Архитектор, Творец. Каждый переход — атомарная единица с **ролью** и **контрактом по state**, осуществляющая одну **метаморфозу** (материя ↔ идея, объект в объект).
- **Рёбра мира** — связи «выход перехода N → вход перехода N+1»; по ним передаётся **state**. Вход первого перехода на витке — state после предыдущего витка или после Development of the world (новый state с блоком 1); выход каждого перехода маппится в state и подаётся на вход следующего.
- **Выполнение мира** — последовательный вызов **run(Stage, state, context)** для каждого перехода в порядке цикла; после каждого перехода state обновляется и передаётся следующему. После Среды (если выполнился Development) новый state с блоком 1 идёт в Архитектор — цикл повторяется.

Таким образом, **мир = гиперграф переходов (цепочка переходов)**; структура мира — это структура этой цепочки (какие переходы, в каком порядке); state течёт по рёбрам, на каждом переходе претерпевая метаморфозу; цикл замыкается через **Среда** (Development of the world → новый state с блоком 1 → Архитектор → Творец → Философ → Автор → Среда → …).

---

## 3. Цикл мира: пять переходов и порядок

В каноне мир — **циклическая цепочка из пяти переходов**. Порядок выполнения **фиксирован**.

```
  Философ  →  Автор  →  Среда  →  Архитектор  →  Творец  →  …
```

После Творца state с блоком 3 на следующем витке попадает в Философ (при следующем проходе по циклу). **Среда** содержит два подузла: сначала **World update** (при полном state), затем **Development of the world** (безусловно) — Development создаёт **новый state** с заполненным только блоком 1, который передаётся в **Архитектор**; таким образом, логически цикл продолжается: Архитектор → Творец → Философ → Автор → Среда → …

| № в цикле | Переход (роль) | Краткая задача |
|-----------|----------------|----------------|
| 1 | **Философ** (Philosopher) | Идеализация материального. Артефакты (блок 3) → описание (блок 4). |
| 2 | **Автор** (Author) | Нарратив в контексте мира. Блок 4 → «что реально произошло» (блок 5). |
| 3 | **Среда** (Environment) | (1) World update — применение state к миру при полном state; (2) Development of the world — новый state с блоком 1. |
| 4 | **Архитектор** (Architect) | Идея → техническая структура. Блок 1 → конфигурация (блок 2). |
| 5 | **Творец** (Creator) | Конфигурация → материя. Блок 2 → артефакты (блок 3). |

Подробные таблицы входов/выходов по state и условий выполнения — в §5 и §6.

---

## 4. State: пять блоков и поток по переходам

**State** (состояние мира) задаётся **пятью блоками**. Полное описание и использование на уровне Stage — в [04_STAGE_LEVEL.md](04_STAGE_LEVEL.md) §2. Ниже — сводка и поток по переходам мира.

| № | Блок | Смысл в цикле |
|---|------|----------------|
| **1** | Описание того, что должно было произойти | Намерение; порождается в **Development of the world**. Вход **Архитектора**. |
| **2** | Конфигурация для генерации артефактов | Выход Архитектора, вход **Творца**. |
| **3** | Сгенерированные артефакты | Выход Творца, вход **Философа**. |
| **4** | Описание сгенерированных артефактов | Выход Философа, вход **Автора**. |
| **5** | Описание того, что реально произошло в мире | Выход Автора. Вход **World update**. |

По **рёбрам мира** между переходами передаётся один и тот же объект **state** (или его обновлённая копия после каждого перехода). Каждый переход **читает** нужные ему блоки и **записывает** результаты в указанные блоки; мир передаёт state по цепочке и при необходимости сохраняет его при World update.

---

## 5. Условия выполнения переходов

Не каждый переход выполняется при любом state. Условие **can_run(stage, state)** (04_STAGE_LEVEL) определяет, будет ли переход выполнен или **пропущен**. Логика мира: при вызове run(World, state, …) для каждого перехода в порядке цикла проверяется условие этого перехода; если оно не выполнено, переход **пропускается** — state передаётся следующему переходу без изменений.

| Переход | Условие выполнения | Примечание |
|---------|--------------------|------------|
| **Философ** | **Только если заполнены блоки 1, 2, 3.** | Иначе пропуск; state без изменений идёт в Автор. |
| **Автор** | **Только если заполнены блоки 1, 2, 3, 4.** | Иначе пропуск; state идёт в Среда. |
| **Среда: World update** | **Только если заполнены все 5 блоков.** | Иначе World update не выполняется. |
| **Среда: Development of the world** | **Безусловно.** | Всегда выполняется; создаёт новый state с блоком 1. |
| **Архитектор** | По потоку цикла **всегда** получает state с блоком 1 (после Development или от пользователя). | Условие можно задать как «блок 1 заполнен»; при каноническом порядке после Development блок 1 есть. |
| **Творец** | По потоку **всегда** получает state с блоком 2. | Аналогично: блок 2 заполнен после Архитектора. |

Итог: **Философ**, **Автор** и **World update** — условные (требуют заполненности части или всех блоков); **Development of the world**, **Архитектор** и **Творец** в нормальном проходе цикла выполняются при наличии нужных блоков по потоку (после Development блок 1 гарантирован для Архитектора).

---

## 6. Первая итерация: старт без предзаданного state

**Если пользователь не передал state** (или передал пустой/отсутствующий state) при первом запуске мира:

- **Философ** — пропускается (блоки 1, 2, 3 не заполнены).
- **Автор** — пропускается.
- **Среда: World update** — пропускается (state не полный).
- **Среда: Development of the world** — **выполняется безусловно**. Читает **контент мира** (и опционально Action); генерирует описание «что должно произойти» и создаёт **новый state** с заполненным **только блоком 1**.
- Далее новый state идёт в **Архитектор → Творец → Философ → Автор → Среда** — цикл идёт как обычно.

Таким образом, **первая итерация** может **начаться с Development of the world**: мир способен породить первый state **из себя** (из начального контента мира или пустоты), без обязательного внешнего state. Философски это — **начало без предзаданного состояния** (Philosophy 7.5).

---

## 7. Передача state пользователем

**Передача state пользователем** на вход мира (например, при первом шаге или при возобновлении) задаёт **начальное заполнение блоков**. Дальнейшая логика та же: каждый переход выполняется только при выполнении своего условия.

- **Только блок 1** (или 1 и 2): Философ и Автор пропускаются; World update не выполняется; после Development (если он в цикле) или при обходе Архитектор и Творец получают нужные блоки по потоку.
- **Блоки 1, 2, 3**: Философ выполняется → блок 4; Автор выполняется → блок 5; затем при проходе Среды World update выполняется при полном state.
- Подробные сценарии «какие переходы при каком state» задаются каноном и реализацией; принцип: **внешний ввод встраивается в ту же логику** «выполнять переход только при готовности входа» (Philosophy 7.5; Scheme §7.5).

---

## 8. Action: опциональный контекст для Development

**Action** — **опциональное** взаимодействие пользователя с миром в начале шага (реплика, команда, выбор). В контексте мира Action передаётся в **Development of the world** как **контекст для LLM** (или для другого реализатора Development): при генерации блока 1 («что должно произойти») модель может учитывать Action.

- При **отсутствии Action** Development выполняется **безусловно** и создаёт следующий эпизод по **текущему состоянию мира** (контент мира, история, глоссарий).
- Пользователь выступает как **опциональный со-автор**: мир может развиваться сам; участие пользователя обогащает контекст, но не является условием возможности цикла (Philosophy 7.5).

Контракт run мира может принимать опциональный аргумент **action** (или включать его в **context**), который передаётся в контекст при вызове Stage Среды (в подузел Development of the world).

---

## 9. Среда: два подузла

**Среда (Environment)** в графе мира — **два последовательных подузла** внутри одного перехода (одного Stage).

| № | Подузел | Вход | Условие / Действие | Выход |
|---|---------|------|---------------------|--------|
| **1** | **World update** | State | Выполняется **только если state полностью заполнен** (все 5 блоков). Применить state к миру: обновить **контент мира**, сохранить state (по правилам мира). Иначе — пропуск. | Завершение текущего витка; state сохранён. |
| **2** | **Development of the world** | Контент мира; опционально **Action** | Выполняется **безусловно**. Читает мир (контент); с учётом Action (если передан) или без него генерирует описание следующего шага; создаёт **новый state** с заполненным **только блоком 1**. | Новый state → передаётся в переход **Архитектор** (следующий узел по циклу). |

После Development новый state идёт в **Архитектор → Творец → Философ → Автор → Среда** — цикл повторяется. Реализация Среды может быть одним Stage с двумя внутренними пайплайнами/блоками (World update и Development) или двумя последовательными Stage в конфиге мира; канон задаёт **семантику** двух подузлов, конкретная сборка — по конфигу.

---

## 10. Контент мира

**Контент мира** — всё, что **наполняет** мир как субъект цикла: история, глоссарий, персонажи, правила, стиль, артефакты (в сохранённом виде), нарратив. Это **данные**, которые мир **читает** (например, в Development of the world и в переходах Автор/Архитектор при необходимости контекста) и **обновляет** при **World update** (когда state полностью заполнен и применяется к миру).

- **Минимальная реализация:** хранилище ключ–значение или структурированный документ (например, JSON/YAML): слоты под историю, глоссарий, персонажей, последний нарратив и т.д. При World update поля обновляются по правилу (например, дополнение истории блоком 5, обновление глоссария по блоку 4).
- **Расширенная:** контент мира может включать версионирование, снапшоты state, медиа-артефакты (ссылки или бинарные данные). Формат задаётся каноном и конфигом мира.

Сериализация мира разделяет **два крупных поля**: (1) **структура / исполняемая часть** — цикл, переходы, конфиги Stage и пайплайнов, чекпоинты; (2) **контент мира** — собственно наполнение (история, глоссарий, персонажи и т.д.). End World — мир, у которого в сериализации только контент (без исполняемой части).

---

## 11. Контракт run мира

- **Вход:** опционально **state** (начальное состояние; при отсутствии или пустом — первая итерация стартует с Development); опционально **action** (контекст для Development); опционально **context** (опции run, ссылка на мир, прочее).
- **Выход:** зависит от контракта реализации. Варианты: (1) **state** после одного витка цикла (или после N витков); (2) **результат витка** (например, обновлённый контент мира, флаг «был ли World update», последний state); (3) итератор/генератор по виткам. Канон задаёт, что мир **выполняет цикл** и передаёт state по переходам; конкретный формат возврата — в реализации.
- **Поведение:** обход переходов в порядке цикла; для каждого перехода проверка can_run(stage, state); при true — run(Stage, state, context) → state; при false — state без изменений к следующему. Среда: сначала World update (если state полный), затем Development (всегда) → новый state с блоком 1 в Архитектор. Цикл может выполняться один раз (один виток) или повторяться по условию (например, пока пользователь не остановит или N витков).

---

## 12. Построение мира

### 12.1 Узлы мира = переходы (Stage)

- Каждый **узел мира** — один **Stage** (гиперграф пайплайнов) с заданной **ролью** (Философ, Автор, Среда, Архитектор, Творец). Stage задаётся конфигом (04_STAGE_LEVEL: pipelines, state_input_map, state_output_map, condition).
- **Порядок обхода** задаётся **списком имён переходов** (или идентификаторов Stage) в конфиге мира. Канонический порядок: Философ → Автор → Среда → Архитектор → Творец.

### 12.2 Добавление переходов и порядок цикла

- **add_stage(stage_id, stage)** или **add_stage(stage_id, config)** — добавить переход (Stage) как узел мира.
- **set_cycle_order(order)** — задать порядок обхода (список stage_id в порядке выполнения). По умолчанию — канонический порядок пяти переходов.
- **Контент мира:** задаётся отдельно (начальное содержание, хранилище, схема слотов). При загрузке мира контент восстанавливается из сериализации (см. §14).

### 12.3 Построение из конфига

- **Конфиг мира:** **cycle** — список имён/идентификаторов переходов в порядке обхода; **stages** — словарь stage_id → конфиг Stage (или ref); **content** или **initial_content** — начальный контент мира (опционально); world_id, schema_version, metadata; опционально параметры сохранения (путь для state, версионирование).
- **from_config(config, registry?, validate?)** — для каждого stage_id из cycle построить Stage из конфига (04.from_config), собрать мир; восстановить порядок цикла и контент. При validate — проверить наличие всех Stage, совместимость контрактов по state.

---

## 13. Валидация мира

| Проверка | Описание |
|----------|----------|
| **Наличие переходов** | Все идентификаторы из cycle присутствуют в stages. |
| **Контракты по state** | Выходы одного перехода (блоки state) совместимы с ожидаемыми входами следующего (по state_input_map / state_output_map каждого Stage). |
| **Среда** | Stage «Среда» имеет два подузла (World update, Development) и корректные условия (World update — при 5 блоках; Development — безусловно). |
| **Схема state** | Пять блоков заданы; при расширенной схеме — согласованность с конфигами переходов. |

---

## 14. Сериализация уровня мира

### 14.1 Два крупных поля

Сериализация мира выделяет **два крупномасштабных поля**:

| Поле | Содержимое |
|------|------------|
| **Структура / исполняемая часть** | Конфиг цикла (порядок переходов), конфиги всех Stage (и вложенных пайплайнов, гиперграфов), схема state, пути к чекпоинтам, параметры запуска. Всё, что нужно для **сборки и запуска** мира. |
| **Контент мира** | История, глоссарий, персонажи, правила, стиль, артефакты (ссылки или данные), нарратив — всё, что **наполняет** мир и обновляется при World update. |

**End World** — мир, в сериализации которого присутствует **только контент** (без исполняемой части, без весов моделей и возможности запуска цикла); используется как справочный/только для чтения мир (см. уровень вселенной).

### 14.2 Конфиг мира (структура)

- **cycle** — список имён переходов в порядке обхода.
- **stages** — словарь stage_id → конфиг Stage (04: pipelines, edges, state_input_map, state_output_map, condition). Вложенные конфиги пайплайнов и гиперграфов — по 03, 02.
- **state_schema** — описание пяти блоков (и при необходимости расширенных слотов).
- **content_storage** или **initial_content** — путь/URI или вложенная структура начального контента мира.
- **world_id**, **schema_version**, **metadata**.

### 14.3 Чекпоинт мира

- **Чекпоинт мира** — совокупность чекпоинтов всех входящих в него Stage (каждый Stage — чекпоинты своих пайплайнов по 04, 03). Плюс при необходимости **последний сохранённый state** (после World update) и **снапшот контента мира**.
- Сохранение: конфиг мира + чекпоинты всех Stage (рекурсивно) + опционально state и контент. Загрузка: восстановление структуры из конфига, загрузка чекпоинтов в Stage, восстановление контента из сохранённого снапшота или initial_content.

---

## 15. Цикл мира и круг Хармона

Цикл мира **структурно соответствует** кругу Дэна Хармона (Story Circle): один виток цикла = **одна нарративная единица** (эпизод, дуга изменения). Соответствие фаз: статус-кво (You) → желание (Need = блок 1) → выход (Go = Архитектор) → поиск (Search = Творец) → обретение (Find = Философ) → цена (Take = Автор) → возврат (Return = World update) → изменение (Change = новый статус-кво). Подробная философия связи — Philosophy.md п. 7.8;

Для уровня мира практический вывод: **полнота витка** (все пять переходов при полном state до World update и затем Development) совпадает с **полнотой нарративной дуги**; при проектировании сценариев и тестов можно опираться на эту норму.

---

## 16. Связь с уровнем вселенной

- **Вселенная (Universe)** — гиперграф, узлами которого являются **миры** (06_UNIVERSE_LEVEL). По гиперрёбрам передаётся **обмен** (payload_spec: state snapshot, артефакты, сущности). Мир как узел вселенной может получать/отдавать данные по рёбрам; контент мира и state могут участвовать в обмене между мирами. Уровень мира не задаёт правила обмена — они задаются на уровне вселенной.

---

## 18. Сводные таблицы

### 18.1 Уровень мира (кратко)

| Понятие | Определение |
|---------|-------------|
| **Мир (World)** | Гиперграф переходов (Stage). Узлы = пять переходов (Философ, Автор, Среда, Архитектор, Творец); по рёбрам — **state** (пять блоков). Циклический граф с фиксированным порядком. |
| **Четвёртый исполняемый уровень** | run(World, state?, action?, context?) → результат витка; обход переходов, условия can_run, Среда (World update + Development). |
| **Среда** | Два подузла: World update (при полном state), Development of the world (безусловно, новый state с блоком 1). |
| **Первая итерация** | Без state — пропуск Философ, Автор, World update; старт с Development. |
| **Action** | Опциональный контекст для Development; мир может развиваться сам. |
| **Контент мира** | Наполнение мира (история, глоссарий, персонажи и т.д.); обновляется при World update. |
| **Выше** | Вселенная = гиперграф миров. [06_UNIVERSE_LEVEL.md](06_UNIVERSE_LEVEL.md). |

### 18.2 Stage и мир

| Аспект | Stage | Мир |
|--------|-------|-----|
| **Узлы** | Пайплайны. | Переходы (Stage). |
| **По рёбрам** | Данные между пайплайнами; вход/выход — state. | **State** между переходами. |
| **Масштаб** | Одна метаморфоза state. | Цепочка метаморфоз; один полный цикл. |

---

## 19. Критерии завершения фазы 5 (напоминание)

- Документ docs/05_WORLD_LEVEL.md создан. ✓
- Мир реализован: гиперграф из пяти переходов (Stage), state (пять блоков), Среда (World update + Development), условия выполнения переходов, первая итерация без state, Action опционален.
- Контракт run(World, state?, action?) и обход цикла с пропуском переходов по can_run.
- Пример мира с одним-двумя витками цикла выполняется; воспроизводимость.
- Соответствие Philosophy и Scheme (в т.ч. круг Хармона при наличии тематического документа).

---

## 20. Ссылки

| Документ | Назначение |
|----------|------------|
| [Philosophy.md](../Philosophy.md) | Часть VII — мир как непрерывное становление, state, пять блоков, Среда, первая итерация, Action, круг Хармона. |
| [Scheme.md](../Scheme.md) | §7 — уровень мира: цикл, state, Среда, условия, первая итерация, Action, артефакты. |
| [04_STAGE_LEVEL.md](04_STAGE_LEVEL.md) | Переход (Stage) как узел мира; state на входах/выходах; пять переходов. |
| [06_UNIVERSE_LEVEL.md](06_UNIVERSE_LEVEL.md) | Вселенная = гиперграф миров. |
| [PLAN_DEVELOPMENT_CANON.md](PLAN_DEVELOPMENT_CANON.md) | Фаза 5 — цели, документация, реализация, критерии. |

---

**Итог.** Настоящий документ — **полная и глубокая техническая спецификация уровня мира** для Universe Generator 3.0. В нём заданы **мир** как гиперграф переходов (цепочка из пяти переходов), **state** (пять блоков) и поток по переходам, **условия выполнения** каждого перехода (Философ, Автор, World update — по заполненности блоков; Development — безусловно), **первая итерация** без предзаданного state, **передача state пользователем**, **Action** как опциональный контекст для Development, **Среда** (два подузла: World update и Development of the world), **контент мира** и его обновление при World update, контракт run мира, построение и валидация, **сериализация** (два поля: исполняемая часть и контент), связь с кругом Хармона и с уровнем вселенной. Реализация фазы 5 и уровень вселенной (фаза 6) опираются на эту спецификацию.
