# 06. Уровень вселенной — полная техническая спецификация

**Назначение:** глубокая и детальная **техническая документация высшего исполняемого уровня** для Universe Generator 3.0 (Yggdrasil). Документ задаёт **вселенную (Universe)** как **гиперграф миров**: узлы вселенной — **миры (World)** (уровня мира, фаза 5), по гиперрёбрам передаётся **обмен** (payload_spec: state snapshot, артефакты, контекст, события, сущности с состоянием). Описаны **эфир вселенной** (общая среда, поток трансляции, общий контекст), **payload_spec** и направление влияния, **выполнение** (обход гиперграфа миров, run(world), маппинг по рёбрам), **взаимодействие между мирами и между сущностями** (переход сущностей, origin_world_id, кросс-мировое влияние), **End Worlds** (миры только для чтения, гиперссылки), **сообщество** как целевое назначение уровня (сравнение миров, обмен, группы миров, влияние на экосистему), построение и сериализация, граница онтологии (уровень метавселенной не вводится). Это **канонический источник** технических решений уровня вселенной в каноне 3.0.

**Якорь:** [Philosophy.md](../Philosophy.md) (Часть VIII — вселенная как гиперграф миров, эфир, сообщество, End Worlds, Иггдрасиль; п. 12.3 — метавселенная не вводится); [Scheme.md](../Scheme.md) §8.

**Предыдущий уровень:** [05_WORLD_LEVEL.md](05_WORLD_LEVEL.md) — мир = гиперграф переходов, state (пять блоков), цикл.

**Референс:** [../WorldGenerator_2.0/EXPANSION_UNIVERSE_GRAPH_OF_WORLDS.md](../WorldGenerator_2.0/EXPANSION_UNIVERSE_GRAPH_OF_WORLDS.md), [../WorldGenerator_2.0/END_WORLDS.md](../WorldGenerator_2.0/END_WORLDS.md).

**Язык:** русский.

**Связь с планом:** [PLAN_DEVELOPMENT_CANON.md](PLAN_DEVELOPMENT_CANON.md) — фаза 6.

---

## 1. Место уровня в иерархии

| Уровень | Сущность | Что течёт по связям | Описание |
|---------|----------|---------------------|----------|
| **Уровень мира** | Мир — гиперграф переходов | **State** (пять блоков) | Один мир = одна цепочка переходов, один цикл. [05_WORLD_LEVEL.md](05_WORLD_LEVEL.md). |
| **Уровень вселенной** | **Вселенная (Universe)** — гиперграф миров | **Обмен** (payload_spec) | **Высший уровень онтологии.** Узлы = миры (объектные или End Worlds); по гиперрёбрам — state snapshot, артефакты, контекст, сущности. Эфир вселенной; сообщество. |

**Выше вселенной в иерархии Yggdrasil уровня нет.** Онтология системы заканчивается на вселенной; то, что в массовой культуре именуют метавселенной, по замыслу проекта образуется из **взаимодействия пользователей в реальном мире** и **публикации вселенных на единой площадке** — без введения формального уровня «метавселенная» в онтологию (Philosophy 12.3).

---

## 2. Определение вселенной: гиперграф миров

**Вселенная (Universe)** — это **гиперграф, узлами которого являются миры (World)**. Каждый узел — один мир (идентифицируется **world_id**): либо **объектный мир** (развивается, цикл переходов, state обновляется), либо **End World** (фиксирован, только чтение). По **гиперрёбрам** между мирами передаётся **обмен** — содержимое которого задаётся **payload_spec** (state snapshot, артефакты, контекст, события, сущности с состоянием — персонажи, агенты). Вселенная одновременно есть **гиперграф миров** (структура связей) и **счёт миров** (множество узлов, count of worlds).

- **Узлы вселенной** — миры. Каждый мир — самостоятельная единица со своим циклом (Философ → Автор → Среда → Архитектор → Творец), своим state (пять блоков) и при необходимости своим контентом. Мир вызывается как run(World, state?, action?, context?) по контракту уровня мира.
- **Гиперрёбра вселенной** — связи между мирами. Каждое ребро (или гиперребро) задаёт: **источник** (world_id или множество миров), **назначение** (world_id или множество), **payload_spec** — что передаётся (тип данных, направление, момент синхронизации). По рёбрам не течёт «сырой» state одного мира как целое без соглашения: payload_spec описывает, какие части state, артефактов или сущностей передаются и как они маппятся на входы или контекст мира-назначения.
- **Выполнение вселенной** — обход гиперграфа миров (топологический порядок, фиксированный цикл или по правилу конфига); для каждого мира вызов run(World, …); выходы мира A по payload_spec маппятся на входы или контекст мира B по входящим гиперрёбрам. При переходе **сущностей** (персонаж, агент) из мира A в мир B обновляются state мира-источника и мира-назначения по правилам кросс-мирового влияния.

Канон **одного мира** не меняется: вселенная не подменяет мир, а добавляет уровень «над» ним — множество миров и связи между ними.

---

## 3. Узлы вселенной: миры (объектные и End Worlds)

### 3.1 Объектный мир (Object World)

- **Объектный мир** — мир, который **развивается**: имеет исполняемую часть (цикл переходов, Stage, пайплайны), state обновляется при run(World, …), контент мира может обновляться при World update. Сериализация объекта мира включает **два поля**: (1) структура/исполняемая часть, (2) контент мира (05_WORLD_LEVEL, WG2.0 World_Serialization).
- В гиперграфе вселенной объектный мир — узел, который может **получать** данные по входящим рёбрам (контекст, артефакты, сущности) и **отдавать** данные по исходящим рёбрам (state snapshot, артефакты, сущности) согласно payload_spec.

### 3.2 End World (мир-завершение)

- **End World** — мир, который **не изменяется** и **фиксирован**: только чтение контента, без исполняемой части (без весов моделей, без запуска цикла). В сериализации End World присутствует **только контент мира** (история, глоссарий, персонажи, сюжет — например, книга как законченный текст), без структуры выполнения. К End World можно **привязываться** по **гиперссылке** (end_world_id); объектные миры и персонажи могут **читать** его контекст (обогащение диалогов, цитирование, отсылки), при этом **End World не меняется**.
- В гиперграфе вселенной End World — узел **без исходящих рёбер с записью** в него: только входящие «ссылки» от других миров (чтение контента). Гиперрёбра типа «мир A → End World» семантически означают «мир A имеет доступ к контенту End World по чтению»; обратная запись в End World запрещена.
- Поддержка End Worlds — **возможность**, а не предписание: вселенная может состоять только из объектных миров (Philosophy 8.5; END_WORLDS.md).

---

## 4. Гиперрёбра вселенной и payload_spec

### 4.1 Назначение гиперрёбер

Гиперрёбра задают **связи между мирами** и **что передаётся** по каждой связи. Формат ребра (или гиперребра): (source_world_id, target_world_id, **payload_spec**) или при групповых гиперрёбрах — множества источников/назначений и общий payload_spec.

### 4.2 payload_spec

**payload_spec** — спецификация полезной нагрузки ребра: что именно передаётся от мира-источника к миру-назначению. Типичные элементы:

| Элемент | Описание |
|---------|----------|
| **state_snapshot** | Снимок state мира-источника (полный или подмножество блоков 1–5); мир-назначение может использовать его как контекст или для инициализации своего state. |
| **artifacts** | Артефакты (изображения, видео, текст, структурированные данные); передача по слоту артефактов state или по отдельному каналу. |
| **context** | Произвольный контекст (глоссарий, правила, описание сцены) для подстановки в мир-назначение. |
| **events** | События (например, «персонаж X перешёл в мир B»); триггеры для обновления state мира-назначения или мира-источника. |
| **entities** | **Сущности с состоянием** (персонажи, агенты): объект с идентификатором, состоянием и при необходимости **origin_world_id**. Передача сущности по ребру = «переход персонажа/агента из мира A в мир B»; в мире B сущность действует и влияет на историю B; обратная связь в мир A (отсутствие, возврат, отражение событий) обновляет историю в A. |

Направление влияния может быть **A → B**, **B → A** или **двунаправленное**; в payload_spec или в конфиге ребра задаётся **момент синхронизации** (после run(world_A), после run(world_B), после обхода подграфа).

### 4.3 Маппинг выходов мира на входы другого мира

При выполнении run(Universe, …) после run(world_A) выходы мира A (например, state, артефакты, список сущностей для передачи) **маппятся** на входы или контекст мира B по правилу, заданному payload_spec входящего ребра (B ← A). Конкретика: какие поля state A подаются в мир B (как начальный state, как контекст для Development, как блоки state) и как записываются сущности в мир B — задаётся конфигом вселенной и контрактом миров.

---

## 5. Эфир вселенной

**Эфир вселенной** («единый эфир вселенной») — **общая среда**, в которой миры существуют и взаимодействуют (Philosophy 8.1–8.2; миф Иггдрасиль — колодец Урд). В технической модели:

- **Общий контекст:** хранилище или каталог (глоссарий, правила, стиль), доступное всем мирам по гиперрёбрам или при инициализации. Миры могут читать из эфира при run (например, при Development of the world или при переходе персонажа).
- **Единый поток трансляции (single fluid broadcast):** поток событий/взаимодействий, затрагивающих экосистему; при необходимости вселенная или платформа обеспечивает доведение значимых событий (переход сущности, обновление мира) до заинтересованных миров или пользователей.
- **Реализация:** минимально — общий контекст-словарь или каталог, ключ–значение; расширенно — хранилище с версионированием, подписками, правилами доступа. Контракт вселенной допускает наличие эфира как опционального компонента; миры получают доступ к эфиру при run (через context или по ссылке из конфига вселенной).

---

## 6. Выполнение вселенной

### 6.1 Обход гиперграфа миров

- **run(Universe, world_inputs?, options?) → results.** Обход узлов (миров) в порядке, заданном топологией гиперграфа (если DAG) или фиксированным порядком/циклом из конфига. Для каждого мира: собрать **входы** из исходящих данных входящих рёбер (по payload_spec) и из world_inputs (если заданы); вызвать **run(World, state?, action?, context?)**; собрать **выходы** мира (state, артефакты, сущности для передачи) и записать их в буферы исходящих рёбер по payload_spec.
- **Последовательный режим:** частный случай — линейная цепочка миров; порядок задаётся списком world_id; рёбра (i → i+1); передача по payload_spec.
- **Параллельный запуск:** миры без рёбер между собой могут выполняться независимо (параллельно или в произвольном порядке); граф задаёт только связи там, где они есть.
- **Число раундов:** опция num_rounds или итерация до условия (например, один проход по всем мирам, или цикл по подмножеству миров).

### 6.2 Переход сущностей и кросс-мировое влияние

При передаче **сущностей** (entities) по payload_spec из мира A в мир B:

- Сущность помечается **origin_world_id** (мир A). В мире B она может участвовать в переходах (например, как персонаж или агент); её действия влияют на **историю мира B** и на state B.
- **Обратная связь в мир A:** при «отсутствии» сущности в A (она в B) state мира A может обновляться по правилам (например, слот «персонаж X в мире B»); при возврате сущности или при получении событий из B (отражение ключевых событий в биографию/state A) state мира A обновляется. Таким образом, **одна сущность, переместившаяся из A в B, влияет и на историю B, и на свою историю в A** (Philosophy 8.4; EXPANSION_UNIVERSE §1.2).
- Реализация правил обратной связи и момента синхронизации задаётся контрактом вселенной и конфигом payload_spec (например, «после run(world_B) отправить события в мир A и обновить state A»).

### 6.3 Контракт run(Universe)

- **Вход:** опционально **world_inputs** (словарь world_id → начальный state или входы для мира); опции (num_rounds, порядок обхода, фильтр миров, контекст эфира).
- **Выход:** зависит от реализации: например, словарь world_id → state (или результат витка каждого мира); агрегированный отчёт; итератор по раундам. Канон задаёт, что вселенная **выполняет обход миров и передаёт данные по гиперрёбрам**; точный формат возврата — в реализации.

---

## 7. Взаимодействие между мирами и между сущностями

### 7.1 Между мирами

По гиперрёбрам задаются **направление влияния** (A → B, B → A, двунаправленное) и **момент синхронизации** (когда мир B получает данные от A; когда обновляется state A при обратной связи). Контракт вселенной должен явно описывать эти правила (в конфиге рёбер или в payload_spec), чтобы выполнение было детерминированным и воспроизводимым в рамках заданной политики.

### 7.2 Между сущностями

- Сущности (персонажи, агенты) могут иметь **origin_world_id**. В мире-назначении правила могут по-разному обрабатывать **локальных** и **пришлых** сущностей (например, ограничения на действия, учёт в нарративе).
- **Агентные системы** на уровне вселенной (01_ABSTRACT_TASK_BLOCKS §11, AGENT_SYSTEMS_SUPPORT): агенты/персонажи как сущности с состоянием могут перемещаться между мирами; их действия в мире B влияют на мир B и через обратную связь — на историю в мире A. Реализация агентного цикла в мире B и правил отражения в A входит в контракт и конфиг.

---

## 8. End Worlds: детализация

### 8.1 Определение и сериализация

- **End World** — мир, в сериализации которого присутствует **только контент мира** (второе из двух крупных полей сериализации мира), **без** исполняемой части (без весов, без конфига запуска). End World идентифицируется (end_world_id); его контент доступен **только на чтение**.
- **Гиперссылки на End World:** в state объектного мира или в метаданных вселенной могут храниться ссылки на end_world_id. При выполнении этапов мира (Автор, Development, диалоги) контекст End World подставляется по ссылке (чтение). Запись в End World движком запрещена.

### 8.2 Роль в гиперграфе

- В гиперграфе вселенной вершина типа **End World** не имеет исходящих рёбер с записью; возможны **входящие** связи вида «объектный мир → End World» в смысле «доступ на чтение». End World может использоваться как общий канонический контекст (например, книга, фиксированный сюжет) для нескольких объектных миров.

---

## 9. Сообщество как целевое назначение уровня

Уровень вселенной предназначен **в первую очередь для сообщества пользователей** (Philosophy 8.3):

| Цель | Описание |
|------|----------|
| **Сравнение миров** | Пользователи могут сравнивать свои миры друг с другом (контент, state, сюжеты). |
| **Развитие через взаимодействие** | Развитие миров на основе взаимодействия персонажей с мирами других пользователей (переход сущностей, кросс-мировое влияние). |
| **Единая система взаимодействий** | Построение сложных интеграций между мирами (направление влияния, синхронизация, payload_spec). |
| **Обмен и совместное творчество** | Делиться результатами, обмениваться идеями, расширять миры за счёт взаимодействия. |
| **Группы миров** | Формирование групп миров по общим идеям или сюжету. |
| **Влияние на экосистему** | Творческое и деструктивное влияние: синтез новых миров из группы, аннигиляция миров по правилам сценария. |

На уровне вселенной как объединения миров должен существовать **единый поток трансляции** всех взаимодействий; важны **децентрализация** и **полная распределённость** при сохранении возможностей нижележащих уровней и удобстве для сообщества. Архитектура сознательно выводит **сообщество** в первый план: вселенная — не только следующий уровень абстракции, но и место **единого поля взаимодействия** множества авторов и миров.

---

## 10. Построение вселенной

### 10.1 Добавление миров

- **add_world(world_id, world)** — добавить мир (объектный или End World) как узел вселенной с заданным world_id. Уникальность world_id в рамках вселенной.
- **add_world(world_id, config, registry?)** — построить мир из конфига (05.from_config) и добавить как узел. Для End World конфиг задаёт только контент (и тип «End World»).

### 10.2 Добавление гиперрёбер

- **add_edge(source_world_id, target_world_id, payload_spec)** — добавить ребро между мирами; payload_spec задаёт, что передаётся (state_snapshot, artifacts, context, events, entities) и при необходимости направление и момент синхронизации.
- При **гиперрёбрах арности > 2** — add_hyperedge(sources, targets, payload_spec) для групповых связей.

### 10.3 Построение из конфига

- **Конфиг вселенной:** **worlds** — словарь world_id → конфиг мира (или ref) с опциональным типом (object / end_world); **edges** — список (source_world_id, target_world_id, payload_spec); опционально **ether** (общий контекст, путь к хранилищу); **order** или **topology** для порядка обхода; universe_id, schema_version, metadata.
- **from_config(config, registry?, validate?)** — построить миры из конфигов, добавить рёбра, восстановить эфир и порядок обхода. При validate — проверить наличие всех world_id в рёбрах, совместимость payload_spec с контрактами миров.

---

## 11. Валидация вселенной

| Проверка | Описание |
|----------|----------|
| **Наличие миров** | Все world_id в рёбрах существуют в множестве узлов (worlds). |
| **End World** | Узлы с типом End World не имеют исходящих рёбер с записью в другой мир; только чтение их контента. |
| **payload_spec** | Спецификации совместимы с контрактами миров (какие поля state/артефактов доступны, формат сущностей). |
| **Топология** | При заданном порядке обхода или DAG — достижимость и отсутствие неразрешимых циклов (или явная семантика цикла). |

---

## 12. Сериализация уровня вселенной

### 12.1 Конфиг вселенной

- **worlds** — словарь world_id → конфиг мира (вложенный по 05 или ref); для End World — конфиг только контента и тип end_world.
- **edges** — список (source_world_id, target_world_id, payload_spec).
- **ether** — опционально: конфиг или путь к общему контексту/хранилищу.
- **universe_id**, **schema_version**, **metadata**; опционально порядок обхода.

### 12.2 Чекпоинт вселенной

- **Чекпоинт вселенной** — совокупность чекпоинтов всех **объектных** миров (world_id → чекпоинт мира по 05). End Worlds не имеют исполняемого чекпоинта; их контент хранится в сериализации контента (одно поле). Эфир вселенной при необходимости сохраняется отдельно (контекст, каталог).
- Сохранение: конфиг вселенной + чекпоинты всех объектных миров + опционально снапшот эфира. Загрузка: восстановление миров из конфигов, загрузка чекпоинтов в объектные миры, восстановление эфира.

### 12.3 Полное сохранение/загрузка

- **Сохранить:** config.json (или config.yaml) вселенной + директории (или архивы) по world_id с конфигом и чекпоинтом каждого мира; для End World — только контент. **Загрузить:** прочитать конфиг вселенной, построить миры (05.from_config для каждого), загрузить чекпоинты в объектные миры, восстановить рёбра и эфир.

---

## 13. Вселенная и миф Иггдрасиль

Уровень вселенной сопоставляется с **мифом Иггдрасиль** — мировым древом, соединяющим несколько миров (реальмов). **Гиперграф миров** — структура: узлы = миры (девять реальмов в мифе — счёт миров в модели), гиперрёбра = корни и ветви. **Колодец Урд** — воплощение **эфира вселенной**: общий контекст или хранилище. **Обмен по гиперрёбрам** — движение сущностей и данных между мирами. Один мир в каноне — один «реальм» на древе; **вселенная** — целое древо таких миров и связей (Philosophy 8.6). Имя Yggdrasil закрепляет эту связь.

---

## 14. Граница онтологии: уровень метавселенной не вводится

**Уровень метавселенной в Yggdrasill не вводится** (Philosophy 12.3). То, что в массовой культуре именуют метавселенной, по замыслу проекта должно образовываться из **взаимодействия пользователей в реальном мире** и **публикации вселенных на единой площадке** (каталог, сообщество, платформа). Вселенная остаётся **высшим уровнем** онтологии; «мета» — не следующий ярус графа, а **способ использования** вселенных людьми. Документация и реализация не добавляют уровень «метавселенная» над вселенной.

---

## 15. Отличия от WG 2.0 и совпадения

| Аспект | WG 2.0 (EXPANSION_UNIVERSE) | Канон 3.0 (уровень вселенной) |
|--------|-----------------------------|--------------------------------|
| **Определение** | Граф миров (Graph of Worlds), счёт миров. | **Гиперграф** миров; терминология 3.0 — гиперграф везде. |
| **Узлы** | Миры (объектные, End Worlds). | То же; явно типы object / end_world. |
| **Рёбра** | payload_spec, направление, обмен. | То же; payload_spec, момент синхронизации. |
| **Эфир** | Общий контекст (колодец Урд). | Эфир вселенной — общая среда, поток трансляции, хранилище. |
| **End Worlds** | Фиксированные миры, только чтение, гиперссылки. | То же; сериализация только контент. |
| **Сообщество** | Этап для сообщества, сравнение, обмен, группы. | То же; заложенная ценность уровня. |

Итог: уровень вселенной 3.0 **совместим по духу и структуре** с WG 2.0 EXPANSION_UNIVERSE и END_WORLDS; унифицированы гиперграф, контракт run(Universe) и построение из конфига.

---

## 16. Сводные таблицы

### 16.1 Уровень вселенной (кратко)

| Понятие | Определение |
|---------|-------------|
| **Вселенная (Universe)** | Гиперграф миров. Узлы = миры (объектные или End Worlds); по гиперрёбрам — **обмен** (payload_spec: state snapshot, артефакты, контекст, сущности). |
| **Высший уровень** | Выше вселенной уровня в онтологии нет; метавселенная не вводится. |
| **Эфир вселенной** | Общая среда: общий контекст, поток трансляции, при необходимости хранилище. |
| **payload_spec** | Спецификация того, что передаётся по ребру (state_snapshot, artifacts, context, events, entities). |
| **End World** | Мир только для чтения (только контент в сериализации); гиперссылки; без изменений. |
| **Сообщество** | Уровень предназначен для сравнения миров, обмена, групп миров, кросс-мирового влияния. |

### 16.2 Мир и вселенная

| Аспект | Мир | Вселенная |
|--------|-----|-----------|
| **Узлы** | Переходы (Stage). | Миры (World). |
| **По рёбрам** | State (пять блоков). | Обмен (payload_spec). |
| **Масштаб** | Один цикл переходов. | Множество миров, связи между ними. |

---

## 17. Критерии завершения фазы 6 (напоминание)

- Документ docs/06_UNIVERSE_LEVEL.md создан. ✓
- Вселенная реализована: гиперграф миров, рёбра с payload_spec, исполнение (обход, run(world), маппинг по рёбрам), опционально эфир и End Worlds.
- Пример вселенной из двух миров с обменом по одному ребру выполняется; воспроизводимость.
- Онтология заканчивается на вселенной (уровень метавселенной не вводится).

---

## 18. Ссылки

| Документ | Назначение |
|----------|------------|
| [Philosophy.md](../Philosophy.md) | Часть VIII — вселенная, эфир, сообщество, End Worlds, Иггдрасиль; п. 12.3 — метавселенная не вводится. |
| [Scheme.md](../Scheme.md) | §8 — уровень вселенной. |
| [05_WORLD_LEVEL.md](05_WORLD_LEVEL.md) | Мир как узел вселенной; state, цикл. |
| [PLAN_DEVELOPMENT_CANON.md](PLAN_DEVELOPMENT_CANON.md) | Фаза 6 — цели, документация, реализация, критерии. |
| [../WorldGenerator_2.0/EXPANSION_UNIVERSE_GRAPH_OF_WORLDS.md](../WorldGenerator_2.0/EXPANSION_UNIVERSE_GRAPH_OF_WORLDS.md) | Расширение вселенной в WG 2.0. |
| [../WorldGenerator_2.0/END_WORLDS.md](../WorldGenerator_2.0/END_WORLDS.md) | End Worlds в WG 2.0. |

---

**Итог.** Настоящий документ — **полная и глубокая техническая спецификация уровня вселенной** для Universe Generator 3.0. В нём заданы **вселенная** как гиперграф миров (узлы = миры объектные и End Worlds), **обмен по гиперрёбрам** (payload_spec: state snapshot, артефакты, контекст, события, сущности), **эфир вселенной**, **выполнение** (обход миров, run(World), маппинг по рёбрам, переход сущностей и кросс-мировое влияние), **взаимодействие между мирами и между сущностями**, **End Worlds** (фиксированные миры, только чтение, гиперссылки), **сообщество** как целевое назначение уровня, построение и валидация, **сериализация**, связь с мифом Иггдрасиль и **граница онтологии** (метавселенная не вводится). Реализация фазы 6 опирается на эту спецификацию; онтология системы завершается на уровне вселенной.
