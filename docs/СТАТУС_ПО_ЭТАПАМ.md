# Статус по этапам (01–07)

**Канон проекта (всеобъемлющий):** [CANON.md](../WorldGenerator_2.0/CANON.md) — единый референс архитектуры; все операции и документация должны ему соответствовать.

Сводка по каждому этапу: **что реализовано**, **что не реализовано**, **что нужно реализовать**. Учтены канон [LLM_API_SUPPORT.md](../WorldGenerator_2.0/LLM_API_SUPPORT.md) (модели через API — любой блок), [MODEL_REUSE.md](../WorldGenerator_2.0/MODEL_REUSE.md), [TRAINING_REUSE_AND_API_SCENARIOS.md](../WorldGenerator_2.0/TRAINING_REUSE_AND_API_SCENARIOS.md), [AGENT_SYSTEMS_SUPPORT.md](../WorldGenerator_2.0/AGENT_SYSTEMS_SUPPORT.md) (полная поддержка агентных систем).

**Гибкость и классические сценарии:** агентные системы полностью интегрированы; применимы на любом этапе; полная гибкость в рамках канона. **Вселенная (расширение):** гиперграф миров, взаимодействие между мирами и сущностями, кросс-мировое влияние; этап Вселенной для сообщества ([EXPANSION_UNIVERSE_GRAPH_OF_WORLDS.md](../WorldGenerator_2.0/EXPANSION_UNIVERSE_GRAPH_OF_WORLDS.md) §0). **End Worlds:** фиксированные миры, к которым можно привязываться; объектный мир обогащает контекст и истории, End World не меняется ([END_WORLDS.md](../WorldGenerator_2.0/END_WORLDS.md)). **Гиперграф и гиперссылки:** вся архитектура — гиперграф; крупномасштабные гиперссылки для связывания контекстов ([HYPERGRAPH_AND_HYPERLINKS.md](../WorldGenerator_2.0/HYPERGRAPH_AND_HYPERLINKS.md)). **Роли этапов мира:** [Scheme.md](../WorldGenerator_2.0/Scheme.md) §1.1.

**Канон этапов:** [TODO_01_FOUNDATION.md](../WorldGenerator_2.0/TODO_01_FOUNDATION.md) … [TODO_07_FUTURE_AND_IMPROVEMENTS.md](../WorldGenerator_2.0/TODO_07_FUTURE_AND_IMPROVEMENTS.md).

---

## Этап 01 — Фундамент (Foundation)

### Что реализовано

- Abstract Base Block (порты, forward, block_type, block_id, state_dict, load_state_dict, trainable_parameters, train/eval, freeze/unfreeze).
- Порты (Port, направление, тип, optional, aggregation), совместимость при соединении.
- Abstract Graph Node, Edge, Graph: add_node, add_edge, expose_input/expose_output, get_input_spec/get_output_spec, to_config/from_config, state_dict/load_state_dict, load_from_checkpoint, индексы in/out edges.
- BlockRegistry, register_block, build(config).
- Подблоки (get_sub_blocks), сериализация с префиксами.
- Тесты по всем перечисленным пунктам.

### Что не реализовано

- Режим блока «только API»: конфиг с `backend: "api"`, `provider`, `model_id`; блок без локальных весов, forward через вызов API.
- Идентификация «одна модель» по checkpoint_ref/model_id при сборке; пул «один ref → один экземпляр блока» (задел в реестре или отдельный сервис).
- Агентный контракт блока: состояние между вызовами, tool_calls/tool_results, сохранение состояния агента в state_dict.

### Что нужно реализовать

- В конфиге блока: поддержка `backend: "api"`, `provider`, `model_id`; единый контракт для локальных и API-блоков.
- Реестр или пул по checkpoint_ref/model_id при сборке графа/пайплайна: один ref → один экземпляр блока в памяти.
- Задел для агентного блока: опциональное расширение контракта (state, tool_calls/tool_results) по [AGENT_SYSTEMS_SUPPORT.md](../WorldGenerator_2.0/AGENT_SYSTEMS_SUPPORT.md).
- Пункты из раздела «Пункты к реализации на этапе 01» в [TODO_01_FOUNDATION.md](../WorldGenerator_2.0/TODO_01_FOUNDATION.md).

**Детали:** [DONE_01_FOUNDATION.md](DONE_01_FOUNDATION.md).

---

## Этап 02 — Узлы-задачи и граф (Task Nodes and Graph)

### Что реализовано

- Роли, role rules, абстрактные узлы-задачи (Backbone, Solver, Codec, Conditioner, Tokenizer, Adapter, Guidance).
- add_node(block_or_type, auto_connect), auto_connect по ролям, стабы, from_template("text_to_image").
- trainable_parameters, set_trainable, validate, save_config/save_checkpoint, from_yaml, graph_kind, metadata.

### Что не реализовано

- Узлы LLM (и при необходимости VLM, эмбеддинги) в режиме «только API» (типы llm/api, llm/openai и т.д.).
- Пул при сборке графа: один checkpoint_ref/model_id → один экземпляр блока при add_node/from_config.
- Роль/тип **Agent** и узлы-инструменты (tools); контракт портов агента (context, tool_results → response, tool_calls).

### Что нужно реализовать

- Регистрация типов для моделей через API; конфиг узла с backend: "api", provider, model_id.
- Пул при add_node/from_config: не создавать второй блок для того же ref — возвращать один экземпляр.
- Сериализация checkpoint_ref/model_id в конфиге узла; при загрузке один ref → один load_state_dict.
- Узлы-задачи Agent и Tools по [AGENT_SYSTEMS_SUPPORT.md](../WorldGenerator_2.0/AGENT_SYSTEMS_SUPPORT.md) §2.2.
- Пункты из «Пункты к реализации на этапе 02» в [TODO_02_TASK_NODES_AND_GRAPH.md](../WorldGenerator_2.0/TODO_02_TASK_NODES_AND_GRAPH.md).

**Детали:** [DONE_02_TASK_NODES_AND_GRAPH.md](DONE_02_TASK_NODES_AND_GRAPH.md).

---

## Этап 03 — Движок графа (Graph Engine)

### Что реализовано

- Исполнитель run(graph, inputs, training, num_loop_steps, device, callbacks, dry_run), топология по SCC, буфер, опциональные порты (defaults), кэш плана.
- graph.run(), to(device), save(save_dir), load(save_dir), infer_exposed_ports.
- validate(strict) → ValidationResult, save_checkpoint(backend=), load_from_checkpoint(backend=, checkpoint_dir=), from_config(validate=), from_template(validate=).

### Что не реализовано

- Пул «checkpoint_ref → блок» при add_node и from_config: несколько узлов с одним ref должны использовать один экземпляр блока.
- trainable_parameters() с дедупликацией по блокам (один блок — один раз в оптимизаторе).
- state_dict/load_state_dict по уникальным ref (один раз на ref), а не по числу узлов.
- Режим **agent_loop**: цикл agent.forward → tool_calls → выполнение инструментов → agent.forward с tool_results до завершения.

### Что нужно реализовать

- Пул ref→блок при сборке графа; при создании узла с уже встречавшимся ref подставлять существующий блок.
- Дедупликация параметров в trainable_parameters(); сохранение/загрузка state по уникальным ref.
- Режим agent_loop в исполнителе графа по [AGENT_SYSTEMS_SUPPORT.md](../WorldGenerator_2.0/AGENT_SYSTEMS_SUPPORT.md) §2.2.
- Пункты из «Пункты к реализации на этапе 03» в [TODO_03_GRAPH_ENGINE.md](../WorldGenerator_2.0/TODO_03_GRAPH_ENGINE.md).

**Детали:** [DONE_03_GRAPH_ENGINE.md](DONE_03_GRAPH_ENGINE.md).

---

## Этап 04 — Пайплайн (Pipeline)

### Что реализовано

- Pipeline (узлы = Graph), PipelineEdge, add_graph, add_edge, expose_input/expose_output, get_input_spec/get_output_spec.
- validate (DAG, reachability, опционально по графам), run_pipeline (топология, буфер, graph.run).
- to_config/from_config, save/load, checkpoints по узлам, trainable_parameters/set_trainable, infer_exposed_ports, to(device).

### Что не реализовано

- Пул при add_graph/from_config: два графа-узла с одним checkpoint_ref → один экземпляр модели в памяти.
- trainable_parameters() с дедупликацией по блокам внутри графов пайплайна.
- Сериализация/загрузка с учётом уникальных ref (один раз на ref).
- Граф-агент как узел пайплайна (run графа в режиме agent_loop).

### Что нужно реализовать

- Пул checkpoint_ref при добавлении графов и при from_config/load_from_checkpoint.
- Дедупликация в trainable_parameters(); сохранение state по уникальным ref.
- Поддержка узла пайплайна как графа-агента по [AGENT_SYSTEMS_SUPPORT.md](../WorldGenerator_2.0/AGENT_SYSTEMS_SUPPORT.md) §2.3.
- Пункты из «Пункты к реализации на этапе 04» в [TODO_04_PIPELINE.md](../WorldGenerator_2.0/TODO_04_PIPELINE.md).

**Детали:** [DONE_04_PIPELINE.md](DONE_04_PIPELINE.md).

---

## Этап 05 — Этап (Stage)

### Что реализовано

- Ничего. Уровень этапа не реализован.

### Что не реализовано

- Всё из [TODO_05_STAGE.md](../WorldGenerator_2.0/TODO_05_STAGE.md): структура Stage (граф пайплайнов), рёбра по внешним портам пайплайнов, контракт по state (input_state_spec, output_state_spec, маппинг state↔порты), роль этапа, execution_condition, API (AddPipeline, add_edge, set_state_contract, set_execution_condition), валидация, исполнитель run(stage, state), сериализация/чекпоинт, from_config/from_template, trainable пайплайны.
- Пул по checkpoint_ref при сборке этапа; обучение этапа с дедупликацией и учётом API-узлов (промпт-адаптеры).
- **Этап-агент:** пайплайн этапа с узлом-агентом и инструментами; контракт по state сохраняется.

### Что нужно реализовать

- Реализовать уровень Stage по TODO_05 целиком; пул ref при сборке; контракт по state и условия по Scheme; run(stage, state); при обучении — дедупликация и сценарии из [TRAINING_REUSE_AND_API_SCENARIOS.md](../WorldGenerator_2.0/TRAINING_REUSE_AND_API_SCENARIOS.md).
- Поддержка этапа-агента по [AGENT_SYSTEMS_SUPPORT.md](../WorldGenerator_2.0/AGENT_SYSTEMS_SUPPORT.md) §2.4.
- Пункты из «Пункты к реализации на этапе 05» в [TODO_05_STAGE.md](../WorldGenerator_2.0/TODO_05_STAGE.md).

**Детали:** [DONE_05_STAGE.md](DONE_05_STAGE.md).

---

## Этап 06 — Мир (World)

### Что реализовано

- Ничего. Уровень мира не реализован.

### Что не реализовано

- Всё из [TODO_06_WORLD.md](../WorldGenerator_2.0/TODO_06_WORLD.md): World (узлы = Stage), цикл (cycle), state_schema, storage, initial_world, AddStage, SetCycle/set_canonical_cycle, set_state_schema, set_storage, set_initial_world, validate, run(world, state, action, num_steps), сохранение state при World update, конфиг/чекпоинт, save/load, from_config/from_template, trainable этапы, LoRA-world.
- Пул при загрузке мира (один ref на всей иерархии → один экземпляр); обучение мира с API-этапами (промпт-адаптеры, LoRA только к локальным блокам).
- **Мир с агентными этапами:** этапы как агенты с инструментами; action и контекст мира передаются в этапы (напр. Development of the world как агент).

### Что нужно реализовать

- Реализовать уровень World по TODO_06 целиком; пул при загрузке; run(world, state, action) по Scheme §4, §4.8; обучение и LoRA по [TRAINING_REUSE_AND_API_SCENARIOS.md](../WorldGenerator_2.0/TRAINING_REUSE_AND_API_SCENARIOS.md) и [LORA_WORLD_LIGHTWEIGHT_CUSTOM.md](../WorldGenerator_2.0/LORA_WORLD_LIGHTWEIGHT_CUSTOM.md).
- Поддержка мира с агентными этапами по [AGENT_SYSTEMS_SUPPORT.md](../WorldGenerator_2.0/AGENT_SYSTEMS_SUPPORT.md) §2.4.
- Пункты из «Пункты к реализации на этапе 06» в [TODO_06_WORLD.md](../WorldGenerator_2.0/TODO_06_WORLD.md).

**Детали:** [DONE_06_WORLD.md](DONE_06_WORLD.md).

---

## Этап 07 — Будущее и улучшения (Future)

### Что реализовано

- В каноне зафиксированы требования: модели через API — любой блок (раздел 1.6), повторное использование модели (раздел 1.7), ссылка на TRAINING_REUSE_AND_API_SCENARIOS; в TODO_07 добавлены «Пункты к реализации на этапе 07».

### Что не реализовано

- Реализация расширений: VLM, видео, аудио, мультимодальность, стриминг, бэкенды чекпоинтов (torch, safetensors), асинхронность, трейсинг, multi-endpoint, сухие прогоны пайплайна и т.д. — по приоритету.
- **Полная поддержка агентных систем** по [AGENT_SYSTEMS_SUPPORT.md](../WorldGenerator_2.0/AGENT_SYSTEMS_SUPPORT.md): блок-агент, роль Agent, инструменты, agent_loop, этапы и мир с агентами.

### Что нужно реализовать

- Сначала обязательные возможности: API для любого блока, пул повторного использования на всех уровнях, обучение по [TRAINING_REUSE_AND_API_SCENARIOS.md](../WorldGenerator_2.0/TRAINING_REUSE_AND_API_SCENARIOS.md), **поддержка агентных систем** по [AGENT_SYSTEMS_SUPPORT.md](../WorldGenerator_2.0/AGENT_SYSTEMS_SUPPORT.md).
- Далее по приоритету — пункты из [TODO_07_FUTURE_AND_IMPROVEMENTS.md](../WorldGenerator_2.0/TODO_07_FUTURE_AND_IMPROVEMENTS.md); при любых расширениях соблюдать один ref/model_id → один экземпляр; агент может использовать новые типы блоков (VLM и т.д.) как инструменты.

**Детали:** [DONE_07_FUTURE_AND_IMPROVEMENTS.md](DONE_07_FUTURE_AND_IMPROVEMENTS.md).

---

## Краткая таблица

| Этап | Реализован | Ключевое осталось |
|------|------------|-------------------|
| 01 Foundation | ✅ Да | API-режим блока, пул ref→блок |
| 02 Task Nodes | ✅ Да | LLM/др. API-узлы, пул при сборке графа |
| 03 Graph Engine | ✅ Да | Пул ref→блок, дедупликация в trainable_parameters/state_dict |
| 04 Pipeline | ✅ Да | Пул ref→блок для графов-узлов, дедупликация |
| 05 Stage | ❌ Нет | Вся реализация по TODO_05 + пул + обучение при API |
| 06 World | ❌ Нет | Вся реализация по TODO_06 + пул + обучение/LoRA при API |
| 07 Future | — | Обязательные (API, reuse, training); затем расширения по приоритету |

---

## Расширения, которые следует включить в проект

Эти возможности отражены в каноне и должны быть реализованы в рамках этапов 01–07 или сразу после ядра.

| Расширение | Описание | Где учитывать |
|------------|----------|----------------|
| **Модели через API (любой блок)** | Поддержка облачных/API-провайдеров для любого типа блока (LLM, VLM, эмбеддинги, генерация по API и т.д.), когда у провайдера есть API; без локальных весов. | TODO_01 (конфиг блока), TODO_02 (типы узлов), канон [LLM_API_SUPPORT.md](../WorldGenerator_2.0/LLM_API_SUPPORT.md). |
| **Повторное использование модели** | Один checkpoint_ref / model_id → один экземпляр блока в памяти на всех уровнях (граф, пайплайн, этап, мир). | TODO_01–06 (пул при сборке/загрузке), [MODEL_REUSE.md](../WorldGenerator_2.0/MODEL_REUSE.md). |
| **Обучение при повторном использовании и при API** | Дедупликация параметров в оптимизаторе; градиенты с нескольких мест; чекпоинт один раз на ref; LoRA при общем блоке; обучение мира с API-узлами (промпт-адаптеры, пост-обработка). | TODO_03–06 (trainable_parameters, state_dict), [TRAINING_REUSE_AND_API_SCENARIOS.md](../WorldGenerator_2.0/TRAINING_REUSE_AND_API_SCENARIOS.md). |
| **LoRA на весь мир** | Заморозка всех весов базового мира, подключение LoRA ко всем нужным локальным блокам, обучение только адаптеров; для API-блоков — только промпт/пост-адаптеры. | TODO_06, [LORA_WORLD_LIGHTWEIGHT_CUSTOM.md](../WorldGenerator_2.0/LORA_WORLD_LIGHTWEIGHT_CUSTOM.md), TRAINING_REUSE_AND_API_SCENARIOS §4. |
| **Поддержка агентных систем** | Агент как блок/узел (state, tool_calls/tool_results); роль Agent и узлы-инструменты; режим agent_loop в графе; граф-агент как узел пайплайна/этапа; мир с агентными этапами. | TODO_01–07, [AGENT_SYSTEMS_SUPPORT.md](../WorldGenerator_2.0/AGENT_SYSTEMS_SUPPORT.md). |

---

## Расширения, которые могут быть включены в проект

Опциональные направления из [TODO_07_FUTURE_AND_IMPROVEMENTS.md](../WorldGenerator_2.0/TODO_07_FUTURE_AND_IMPROVEMENTS.md); внедрение по приоритету и ресурсам.

| Расширение | Описание |
|------------|----------|
| **VLM (Vision–Language)** | Узлы-задачи для VLM (image + text → text); контракты портов; при наличии API у провайдера — режим «только API». |
| **Видео** | Узлы для видео (backbone, codec, conditioner); контракты портов; графы/пайплайны для video-to-video, text-to-video. |
| **Аудио** | Узлы для аудио (conditioner, codec); TTS, STT как графы. |
| **Мультимодальность** | Мультимодальные conditioner’ы (text+image+audio → embedding); расширение state в мире при необходимости. |
| **Стриминг** | Потоковый вывод (токены, чанки) на уровне блока и графа; run(..., stream=True). |
| **Бэкенды чекпоинтов** | torch, safetensors в дополнение к json; при сохранении/загрузке — один ref → одна запись. |
| **Бэкенды выполнения** | ONNX, OpenVINO, vLLM, TGI для блоков; конфиг `backend: "onnx"` и т.д. |
| **Асинхронность и батчинг** | run_async(...); батчинг вызовов на уровне графа; очереди и воркеры. |
| **Распределённое обучение** | DDP на уровне графа/пайплайна; pipeline parallelism для больших моделей. |
| **Наблюдаемость** | Трейсинг (OpenTelemetry), метрики, профилирование run(..., profile=True). |
| **Валидация и тесты** | JSON Schema для конфигов; контрактные и интеграционные тесты; визуализация графа/пайплайна. |
| **Multi-endpoint** | Развёртывание узлов графа/пайплайна на разные эндпоинты; endpoint_url на узел. |
| **dry_run для пайплайна** | run_pipeline(..., dry_run=True) без вызова graph.run, только проверка порядка и буфера. |
| **Pipeline.from_template** | Шаблоны пайплайнов по имени с подстановкой параметров. |
| **Ref в конфиге узла пайплайна** | Загрузка конфига графа по `ref: path` из конфига узла пайплайна. |

При внедрении любых из этих расширений соблюдать: один checkpoint_ref/model_id → один экземпляр; при обучении и LoRA следовать [TRAINING_REUSE_AND_API_SCENARIOS.md](../WorldGenerator_2.0/TRAINING_REUSE_AND_API_SCENARIOS.md).
