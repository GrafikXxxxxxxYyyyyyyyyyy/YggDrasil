# Отчёт аудита кода YggDrasil

**Дата:** 15 февраля 2025  
**Версия проекта:** 0.1.0  
**Объект:** полный аудит исходного кода фреймворка YggDrasil (Universal Lego Diffusion Framework).

---

## 1. Обзор проекта

### 1.1 Назначение

YggDrasil — универсальный модульный фреймворк для диффузионных моделей с поддержкой изображений, видео, аудио и других модальностей. Модели собираются из «блоков» (Lego-подход), конфигурируются через YAML, поддерживаются HuggingFace Diffusers, FastAPI и Gradio.

### 1.2 Структура репозитория

| Каталог / файл | Назначение |
|----------------|------------|
| `yggdrasil/` | Исходный код пакета |
| `yggdrasil/core/` | Ядро: блоки, граф, диффузия, движок, утилиты |
| `yggdrasil/blocks/` | Конкретные блоки (сольверы, бэкбоны, кодеки, кондиционеры, адаптеры) |
| `yggdrasil/plugins/` | Плагины модальностей (image, video, audio, 3d, molecular, timeseries, text, custom) |
| `yggdrasil/serving/` | API (FastAPI), Gradio UI, очереди, схема |
| `yggdrasil/training/` | Обучение: тренер, данные, потери, чекпоинты |
| `yggdrasil/integration/` | Интеграция с Diffusers, загрузка LoRA |
| `yggdrasil/deployment/` | Docker, облака (RunPod, Vast.ai, Modal), экспорт ONNX |
| `yggdrasil/configs/` | Пресеты и рецепты (YAML) |
| `tests/` | Юнит- и интеграционные тесты |
| `docs/` | Документация |
| `pyproject.toml` | Метаданные и зависимости |

### 1.3 Зависимости

- **Ядро:** Python ≥3.10, PyTorch ≥2.3, diffusers, transformers, accelerate, omegaconf, FastAPI, Gradio.
- **Опционально:** full (safetensors, peft, torchvision и др.), train (wandb, tensorboard), dev (pytest, ruff, mypy).
- **Примечание:** В `pyproject.toml` упоминается `requirements-klein.txt` для FLUX.2 [klein]; файл в репозитории удалён (D).

---

## 2. Архитектура и качество кода

### 2.1 Сильные стороны

- **Чёткое разделение слоёв:** блок (AbstractBlock) → граф (ComputeGraph) → исполнитель (GraphExecutor) → Pipeline / Runner.
- **Единый контракт блоков:** `declare_io()` + `process(**port_inputs)` и опциональная совместимость с legacy `_forward_impl()`.
- **Порты и рёбра:** типизированные порты (Port, TensorSpec), валидация соединений в графе.
- **Регистрация блоков:** декоратор `@register_block("category/name")`, авто-обнаружение в `yggdrasil.blocks` и `yggdrasil.plugins`.
- **Конфигурация:** OmegaConf, пресеты/рецепты в YAML, переопределение параметров.
- **Интеграция с Diffusers:** DiffusersBridge, маппинг моделей и планировщиков в блоки YggDrasil.
- **Hub:** MODEL_REGISTRY для разрешения model_id → шаблон + kwargs, кэш, `resolve_model()`.

### 2.2 Замечания по архитектуре

- **Двойной вызов инициализации в AbstractBlock** (`core/block/base.py`, строки 51–53):

  ```python
  nn.Module.__init__(self)
  super().__init__()
  ```

  Сначала явно вызывается `nn.Module.__init__(self)`, затем `super().__init__()` (по MRO — ABC). Это сделано осознанно (комментарий: чтобы `_modules` существовал до `_build_slots`), но выбивается из обычной практики наследования. Рекомендуется кратко задокументировать в docstring класса или в `docs/`, чтобы не воспринималось как ошибка.

- **Смешение API:** часть публичного API и docstring — на английском (например, `runner.py`, `pipeline.py`), часть — на русском (DEVELOP.md, комментарии в коде, сообщения CLI). Для «полностью на русском» проекте стоит унифицировать строки для пользователя (сообщения, помощь CLI, ключевые docstring) на русский.

---

## 3. Обработка ошибок и исключения

### 3.1 Широкие `except Exception` / `except:`

Обнаружено множество мест с перехватом `except Exception` или общим перехватом без указания типа. Основные зоны:

- **serving:** `api.py`, `gradio_ui.py`, `dynamic_ui.py`, `queue.py`, `contract_bridge.py` — при загрузке моделей, генерации, обработке запросов.
- **integration:** `diffusers.py`, `lora_loader.py` — при конвертации пайплайнов и загрузке LoRA.
- **core:** `graph.py`, `executor.py`, `block/base.py`, `block/registry.py` — при сборке графа, выполнении узлов, авто-дискавере.
- **plugins:** `__init__.py`, `base.py` — при загрузке плагинов.
- **blocks:** бэкбоны (unet_2d/3d, flux_transformer, sd3, wan, qwen_image и др.), кодеки, кондиционеры, адаптеры — часто в блоках try/except при опциональном импорте или инициализации зависимостей.
- **pipeline.py:** при разрешении модели (DiffusersBridge, hub, шаблоны).
- **runner.py:** при валидации workflow.
- **cli.py:** при выводе списка пресетов (`_cmd_presets`).
- **tools:** `block_inspector.py`, `benchmark.py`.
- **deployment/cloud:** `vastai.py`, `runpod.py`.
- **extensions/loader.py.**

Риски: маскирование конкретных ошибок (например, `KeyError`, `ImportError`), усложнение отладки. Рекомендации:

- В публичных API (API, UI, CLI) логировать полный traceback и при необходимости перевыбрасывать или оборачивать в свой тип с понятным сообщением.
- В блоках и интеграциях по возможности ловить только ожидаемые исключения (например, `ImportError` при опциональных зависимостях) и либо логировать, либо пробрасывать дальше.

---

## 4. Линтинг (Ruff)

Запуск: `ruff check yggdrasil/`.

- **E402** — импорт не в начале файла: в `yggdrasil/__init__.py` после патча TensorFlow идут импорты и вызов `_auto_discover()`. Для Ruff это нарушение; при необходимости для данного файла можно добавить исключение или вынести логику в отдельную функцию инициализации.
- **I001** — импорты не отсортированы/не отформатированы в ряде модулей (в т.ч. `__init__.py`, `assemblers/`, `adapter_assembler.py` и др.). Рекомендуется выполнить `ruff check --fix` и/или `ruff format` по проекту (с учётом текущих правил в `pyproject.toml`: line-length 120, select E, F, I, ignore E501).

Имеет смысл зафиксировать в CI единую конфигурацию Ruff и автоматическое исправление безопасных правил.

---

## 5. Типизация (mypy)

В проекте используется аннотация типов (в т.ч. `from __future__ import annotations`). Полная проверка `mypy yggdrasil/` может выявлять ошибки в сложных местах (граф, блоки, Pipeline). Рекомендуется:

- Включить пошаговую проверку mypy в CI.
- Для модулей с тяжёлыми зависимостями (torch, diffusers) при необходимости использовать `# type: ignore` или плагины с обоснованием в комментарии.

В рамках данного аудита полный прогон mypy не завершён; целесообразно провести его отдельно и зафиксировать результаты.

---

## 6. Тесты

- **Запуск:** `pytest tests/ -v`
- **Результат:** 92 теста пройдены успешно (test_assemblers, test_backbones, test_block_system, test_diffusion_processes, test_lego_constructor, test_plugins).
- **conftest.py:** отключение TensorFlow и переменные окружения (TF_CPP_MIN_LOG_LEVEL, TRANSFORMERS_OFFLINE, HF_HUB_OFFLINE) для стабильности на macOS и офлайн-среды.

Рекомендации: добавить тесты для критичных путей (например, Pipeline.from_pretrained для 1–2 моделей, Runner.execute по сохранённому workflow), а также тесты на обработку ошибок (некорректный конфиг, отсутствующий блок, неверные порты).

---

## 7. Документация и локализация

- **README.md, DEVELOP.md** — на русском, структура и быстрый старт описаны понятно.
- **Docstring и комментарии** — смесь русского и английского; в коде много русских комментариев (граф, блоки, движок), что хорошо для русскоязычной команды.
- **Сообщения пользователю:** CLI и часть API (например, «Запуск YggDrasil UI на …») уже на русском. Для «полностью на русском» стоит проверить все строки, отображаемые пользователю (в т.ч. ошибки и подсказки), и перевести оставшиеся на русский.

---

## 8. Безопасность и конфигурация

- **ServerConfig (serving/schema.py):** поддержка `api_key`, `cors_origins`; по умолчанию `cors_origins: ["*"]` — для продакшена стоит ограничивать список.
- **Загрузка моделей и выполнение графов:** загрузка по URL/путям (например, в pipeline для control_image, ip_image и т.д.) — убедиться, что в продакшене нет недоверенных путей/URL без лимитов.
- Секреты и токены не должны быть захардкожены; использование переменных окружения и конфигов вне репозитория — в порядке.

---

## 9. Итоговые рекомендации

| Приоритет | Рекомендация |
|-----------|---------------|
| Высокий | Унифицировать пользовательские сообщения и ключевые docstring на русский язык, если проект объявлен «полностью на русском». |
| Высокий | Сузить обработку исключений в API/serving и integration: логировать traceback, при необходимости перевыбрасывать или оборачивать в свой тип. |
| Средний | Привести импорты в соответствие с Ruff (E402, I001): либо исключения в конфиге для специальных файлов, либо рефакторинг; запустить `ruff check --fix` и `ruff format`. |
| Средний | Включить в CI проверки: `ruff check`, `ruff format`, `pytest`, при возможности — `mypy`. |
| Средний | Восстановить или убрать упоминание `requirements-klein.txt` в `pyproject.toml` и документации. |
| Низкий | Добавить в docstring AbstractBlock краткое пояснение двойного вызова инициализации (nn.Module + super). |
| Низкий | Расширить тесты: сценарии Pipeline.from_pretrained, Runner.execute, обработка ошибок при неверном графе/конфиге. |

---

## 10. Краткая сводка

- **Архитектура:** сильная, модульная, с чётким контрактом блоков и графов.
- **Код:** в целом поддерживаемый; есть смешение языков в документации и широкие `except` в нескольких слоях.
- **Линтинг:** есть замечания Ruff (импорты, E402); исправляемо автоматически или точечными исключениями.
- **Тесты:** 92 теста проходят; есть потенциал для добавления сценариев по Pipeline/Runner и ошибкам.
- **Локализация:** для «полностью на русском» стоит пройтись по всем пользовательским строкам и перевести оставшиеся.

Аудит выполнен по состоянию репозитория на дату отчёта.
