# Интерфейс обмена между Автором и Создателем

Документ задаёт **контракт взаимодействия** Автора и Создателя: какие данные они передают друг другу на каждом шаге цикла и как описывается **текущее состояние мира**, чтобы оба могли согласованно работать.

---

## 1. Цель интерфейса

- **Обмен на текущем шаге:** на одном шаге цикла Автор и Создатель должны обмениваться ровно той информацией, которая нужна для «материализации идей» (Автор → Создатель) или «идеализации материи» (Создатель → Автор).
- **Общее состояние мира:** оба должны иметь доступ к **текущему состоянию мира** (накопленные артефакты, глоссарий, стиль, правила, история шагов), чтобы генерация оставалась консистентной.

Интерфейс можно реализовать как **общую структуру данных (контекст мира)** + **сообщения на один шаг**, или как **явный API** с входными/выходными типами.

---

## 2. Состояние мира (World State)

**Состояние мира** — это снапшот всего, что накоплено к текущему моменту и доступно Автору и Создателю для чтения/записи.

Предлагаемая структура (логическая; в коде — класс, словарь или конфиг):

| Поле | Тип / содержание | Кто читает | Кто пишет | Назначение |
|------|------------------|------------|-----------|------------|
| **step_index** | целое число | оба | оркестратор цикла | Номер текущего шага (0, 1, 2, …). |
| **direction** | `"author_to_creator"` \| `"creator_to_author"` | оба | оркестратор | Направление текущего шага. |
| **glossary** | словарь (имена персонажей, мест, терминов, краткие описания) | оба | Автор | Глоссарий мира для консистентности имён и сущностей. |
| **style** | строка или структура (стиль визуала/аудио, тон, жанр) | оба | Автор | Стиль генерации (Создатель использует при генерации). |
| **rules** | список строк или структура (ограничения, запреты, форматы) | оба | Автор | Правила мира («без современной техники», «только из глоссария»). |
| **artifacts** | список записей `{ id, type, payload_ref, description?, created_at_step }` | оба | Создатель (payload), Автор (description) | Уже созданные артефакты (изображения, аудио, видео); при идеализации Автор может добавить текстовое описание. |
| **current_prompt** | строка (или структура: prompt + negative_prompt + params) | Создатель | Автор | Промпт/описание для текущей или последней генерации. |
| **narrative_context** | строка или структура (последние события, сцена, диалог) | оба | Автор | Краткий нарративный контекст для следующей реплики или сцены. |
| **last_author_output** | текст/структура (что выдал Автор на этом шаге) | Создатель, оркестратор | Автор | Выход Автора на текущем шаге (если направление author_to_creator). |
| **last_creator_output** | ссылка на артефакт или данные (что сгенерировал Создатель) | Автор, оркестратор | Создатель | Результат Создателя на текущем шаге (если направление creator_to_author — то вход для идеализации). |

Минимально для одного шага достаточно: **step_index**, **direction**, **current_prompt** (для Автор→Создатель), **last_creator_output** (для Создатель→Автор), плюс **glossary** и **style** для консистентности. Остальные поля расширяют контекст.

---

## 3. Обмен на шаге «Автор → Создатель» (материализация идей)

**Вход в Автора (чтение из состояния мира):**

- `step_index`, `direction = "author_to_creator"`
- `glossary`, `style`, `rules`, `narrative_context`
- при необходимости — последние артефакты и их описания (из `artifacts`), чтобы продолжать сюжет или сцену

**Выход Автора (запись в состояние мира и/или прямой вход в Создателя):**

- `current_prompt` — текст описания сцены/персонажа/действия (то, по чему Создатель будет генерировать)
- опционально: обновления `glossary`, `narrative_context`, `rules`

**Вход в Создателя:**

- `current_prompt` (из выхода Автора или из состояния мира)
- `style`, при необходимости выдержки из `glossary` или `rules` (например, для кондиционирования)

**Выход Создателя (запись в состояние мира):**

- новый артефакт: `type` (image | audio | video | …), `payload_ref` (ссылка на файл/тензор), опционально `description` (пустое до идеализации)
- обновление `artifacts` в состоянии мира
- опционально: `last_creator_output` для следующего шага

**Интерфейс одного шага (псевдо-сигнатуры):**

```text
Author:
  input:  WorldState (read-only для step_index, direction, glossary, style, rules, narrative_context, artifacts)
  output: AuthorStepOutput { prompt, optional_updates: { glossary?, style?, rules?, narrative_context? } }

Creator:
  input:  WorldState (read: current_prompt, style, …) или явно CreatorStepInput { prompt, style, world_context_snapshot? }
  output: CreatorStepOutput { artifact: { type, payload_ref }, optional_description? }
```

После шага оркестратор обновляет состояние мира: записывает `current_prompt`, добавляет артефакт в `artifacts`, увеличивает `step_index`.

---

## 4. Обмен на шаге «Создатель → Автор» (идеализация материи)

**Вход в Создателя:**  
На этом шаге Создатель может не вызываться (артефакт уже есть); или вызывается для доработки/вариации по уже существующему артефакту. Если шаг «идеализация», то **вход в Автора** — уже созданный артефакт.

**Вход в Автора (чтение из состояния мира):**

- `step_index`, `direction = "creator_to_author"`
- `last_creator_output` или последний артефакт из `artifacts` (то, что нужно описать/идеализовать)
- `glossary`, `style`, `rules`, `narrative_context` — для согласованного описания

**Выход Автора (запись в состояние мира):**

- текстовое описание артефакта (что на изображении/в аудио, кто персонаж, какое место)
- обновления: привязка описания к артефакту в `artifacts`, обновление `glossary` (если появился новый персонаж/место), `narrative_context`

**Интерфейс одного шага:**

```text
Author (idealization step):
  input:  WorldState (read: last_creator_output or last artifact, glossary, style, rules)
  output: AuthorStepOutput { artifact_description, optional_updates: { glossary?, narrative_context?, artifact_id → description } }
```

Оркестратор записывает описание в соответствующий артефакт в `artifacts` и обновляет `narrative_context` / `glossary`.

---

## 5. Единый контракт «шаг цикла»

Чтобы не плодить два разных протокола, можно ввести **единый формат шага**:

**WorldState** (вход/выход общий для обоих):

- Содержит все поля из п. 2.
- Передаётся **по ссылке** или как копия: Автор и Создатель читают нужные поля, оркестратор после вызова записывает выходы в состояние.

**StepRequest** (что передаётся в узел на одном шаге):

- `direction`: `"author_to_creator"` | `"creator_to_author"`
- `step_index`: int
- `world_state`: WorldState (или ссылка)
- опционально: `user_input` (если шаг инициирован пользователем — реплика, команда)

**StepResponse (Автор):**

- `prompt`: str (для материализации — промпт для Создателя; для идеализации не используется в том же виде)
- `artifact_description`: str | None (для идеализации — описание переданного артефакта)
- `updates`: dict (обновления для WorldState: glossary, style, rules, narrative_context)

**StepResponse (Создатель):**

- `artifact`: { `type`, `payload_ref`, `mime_type?` }
- опционально: `description` (если Создатель умеет подписывать артефакт)

Оркестратор после каждого вызова применяет `StepResponse` к `WorldState` (записывает промпт, артефакт, описания, обновления) и при необходимости передаёт обновлённое состояние в следующий узел или на следующий шаг.

---

## 6. Варианты реализации

1. **Общее хранилище (контекст мира):** один объект `WorldState` в памяти или в хранилище; Автор и Создатель получают его на вход и возвращают только свои «дельты» (что добавить/изменить); оркестратор применяет дельты к состоянию. Обмен «через состояние».
2. **Прямая передача на одном шаге:** оркестратор вызывает Автора, получает `AuthorStepOutput`, подставляет `prompt` во вход Создателя, вызывает Создателя, получает артефакт; затем обновляет общее состояние мира из обоих выходов. Обмен «по цепочке» + общее состояние.
3. **Очередь сообщений:** Автор и Создатель пишут в общую очередь (например, «запрос на генерацию», «результат генерации»); другой узел или оркестратор читает сообщения и обновляет состояние. Подходит для асинхронных или распределённых реализаций.

В любом варианте **интерфейс по данным** остаётся одним и тем же: структуры WorldState, StepRequest, StepResponse (Автор), StepResponse (Создатель) из п. 2 и 5.

---

## 7. Краткая сводка

| Элемент | Описание |
|--------|----------|
| **WorldState** | Текущее состояние мира: step_index, direction, glossary, style, rules, artifacts, current_prompt, narrative_context, last_author_output, last_creator_output. |
| **Шаг Автор → Создатель** | Автор по WorldState выдаёт prompt (и опционально обновления); Создатель по prompt и style генерирует артефакт; артефакт и prompt записываются в WorldState. |
| **Шаг Создатель → Автор** | Автор получает последний артефакт из WorldState и выдаёт artifact_description и обновления глоссария/нарратива; оркестратор привязывает описание к артефакту в WorldState. |
| **Интерфейс** | Единый контракт: WorldState + StepRequest на вход; StepResponse (с полями prompt / artifact_description / artifact / updates) на выход; оркестратор обновляет WorldState после каждого вызова. |

Этот документ можно использовать как спецификацию для реализации в коде (классы WorldState, AuthorStepOutput, CreatorStepOutput, оркестратор цикла).
