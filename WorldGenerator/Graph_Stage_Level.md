# Следующий уровень иерархии: граф как целое (Stage) и пайплайн (Pipeline)

**Детальное описание уровня, расположенного над абстрактными узлами-задачами:** этап как **целостный вычислительный граф** (Stage / ComputeGraph), пайплайн как **граф этапов** (Pipeline), а также модальность, домен и контекст. Документ раскрывает «промежуточные этапы» из [Philosophy.md](Philosophy.md) (раздел 7) и опирается на иерархию п. 8.6. Используются **физические аналогии** в духе фундаментального уровня (фермионы/бозоны) и уровня абстрактных узлов (типы частиц, вершины, процессы) — см. [Abstract_Nodes_Level.md](Abstract_Nodes_Level.md).

---

## 1. Место уровня в иерархии

Над уровнем **абстрактных узлов-задач** (Backbone, Solver, Codec, Adapter — типы «частиц»/вершин, из которых собирается граф) располагается уровень **целостного графа** и его композиций:

| Уровень (снизу вверх) | Сущность | Кратко |
|------------------------|----------|--------|
| **Ниже** | Абстрактные узлы-задачи (Abstract Backbone, Solver, Codec, Adapter, …) | Типы узлов; конкретные модели — экземпляры этих типов. |
| **Данный уровень** | **Stage (этап)** — граф как целостная единица | Один вычислительный граф (ComputeGraph): множество узлов-блоков, связанных рёбрами; **одна** «идея» одного шага пайплайна или одной подсистемы; одна исполняемая единица. |
| **Тот же слой, выше** | **Pipeline (пайплайн)** — граф этапов | Граф, узлами которого служат **этапы** (каждый этап — свой граф). Пайплайн = граф графов; последовательность или сеть этапов. |
| **Далее** | Модальность / домен, контекст | Слой «изображение», «текст», «звук», «инференс»; параметры, правила, глоссарий — рамка, в которой работают графы. |
| **Выше** | Автор и Создатель, World, Universe | Каждый из Автора и Создателя — граф пайплайнов; World — циклический граф из двух узлов; Universe — контейнер двух миров. |

Итог: **Stage** — первый уровень, на котором множество узлов (каждый уже «типизирован» как backbone, solver, codec, adapter) выступает как **одно целое** — один граф с едиными входами/выходами и одной семантикой выполнения. **Pipeline** — уровень, на котором такие целые (этапы) сами становятся узлами и соединяются в граф следующего ранга.

---

## 2. Stage (этап): граф как целостная единица

### 2.1 Определение

**Stage (этап)** — это **базовый граф** (basic graph): один вычислительный граф (ComputeGraph), элементарная единица внутри пайплайна.

- **Материальная сторона:** этап состоит из **множества блоков** (конкретных реализаций Backbone, Solver, Codec, Adapter, Conditioner, Guidance и т.д.), связанных **рёбрами** (потоки данных между портами). Каждый блок хранит параметры, тензоры, состояние; рёбра задают, какие тензоры куда передаются. То есть этап **материально** — это совокупность узлов-блоков и их связей: то, что занимает память и выполняется.
- **Идеальная сторона:** этап — **одна «идея»** одного вычисления: один шаг диффузии, один проход кодера, один сэмплинг и т.д. Топология графа (какие узлы, в каком порядке, какие порты соединены) задаёт **форму** этого шага. Целое не сводится к «просто списку блоков» — у целого есть **глобальные входы и выходы**, **контракт этапа** (что этап принимает и что отдаёт), **семантика** (например, «этап деноisingа», «этап кодирования»). Таким образом, этап соотносится с **идеальным** как «целая идея одного пайплайна или подсистемы» (Philosophy, п. 7).

Этап **исполняется как единица**: исполнитель (GraphExecutor) обходит узлы в порядке, заданном графом, передаёт данные по рёбрам; снаружи этап вызывается с некоторыми входами и возвращает некоторые выходы. Внутри — множество узлов; снаружи — один шаг.

### 2.2 Двойственная природа Stage: материя и идея

| Аспект | Содержание | Аналогия в физике (см. ниже) |
|--------|------------|------------------------------|
| **Материя этапа** | Совокупность блоков (узлов) с параметрами, тензорами, состоянием; рёбра как каналы передачи данных. | **Состав системы**: множество частиц (фермионов/бозонов) в заданной конфигурации; «что там есть» — поля, заряды, массы. |
| **Идея этапа** | Одна топология, один контракт (входы/выходы), одна семантика шага. Целое как «один процесс» или «одна подсистема». | **Один процесс / одна амплитуда**: диаграмма или процесс с заданными начальными и конечными состояниями; «как всё связано в одно целое». |

Граф как целое не противоречит разделению материя/идея: **узлы и их содержимое** — материя, **структура графа и его смысл как единого шага** — идея. Этап — минимальная единица, в которой эта двойственность проявляется на уровне «целого графа».

### 2.3 Физические аналогии для Stage (граф как целое)

#### A. Один процесс рассеяния / одна диаграмма Фейнмана

В квантовой теории поля **амплитуда процесса** (например, \( e^- + e^+ \to \gamma + \gamma \)) задаётся суммой диаграмм Фейнмана. **Одна диаграмма** — это набор вершин (взаимодействий) и линий (пропагаторов), образующих **один граф** с входящими и выходящими линиями.

- **Вершины диаграммы** ↔ **узлы этапа** (backbone, solver, codec, adapter и т.д.): типизированные «места», где происходит взаимодействие или преобразование.
- **Линии (пропагаторы)** ↔ **рёбра этапа**: перенос состояния (данных) от узла к узлу.
- **Вся диаграмма** ↔ **Stage**: один граф с заданными входами и выходами; **один процесс** с одной амплитудой (одним результатом вычисления). Исполнение этапа — аналог вычисления вклада этой «диаграммы» в амплитуду.

Таким образом, **Stage = один элементарный процесс** в смысле «один граф с заданной топологией и контрактом».

#### B. Связанная система (bound state) / составная система

В квантовой механике **атом** (ядро + электроны) или **молекула** — это **одна квантовая система** с многими степенями свободы. Внутри — много частиц (фермионы и бозоны), но система описывается **одной волновой функцией** и **одним гамильтонианом**; у системы есть **целостные характеристики** (энергия основного состояния, спектр, симметрии).

- **Частицы внутри системы** ↔ **узлы этапа** (блоки с параметрами и состоянием).
- **Взаимодействия между частицами** ↔ **рёбра этапа** (связи, потоки данных).
- **Система как целое** ↔ **Stage**: одна исполняемая единица с одним «гамильтонианом» (семантикой шага) и целостными входами/выходами.

Этап — не «мешок узлов», а **связанная конфигурация** с выделенной ролью в пайплайне (например, «этап деноisingа», «этап кодирования»).

#### C. Один «эксперимент» или одно рассеяние

В эксперименте по рассеянию заданы **начальное** и **конечное** состояния; **процесс** — то, что происходит между ними (промежуточные состояния, виртуальные частицы, вершины). **Один этап** можно уподобить **одному такому «эксперименту»** в рамках большего пайплайна: заданы входы (начальное состояние), задана топология (какие «приборы» — узлы — задействованы и как связаны), результат — выходы (конечное состояние этапа).

- **Начальное/конечное состояние** ↔ **входы/выходы этапа**.
- **Промежуточная эволюция** ↔ **выполнение графа** (обход узлов, передача данных по рёбрам).

Итог по аналогиям для Stage: этап — это **один процесс**, **одна составная система** или **один элементарный эксперимент** в вычислительном смысле: много узлов и рёбер, но **одна целостная единица** с одной семантикой и одним контрактом.

---

## 3. Pipeline (пайплайн): граф этапов

### 3.1 Определение

**Pipeline (пайплайн)** — это **граф этапов** (graph of stages). Узлами пайплайна служат **этапы** (каждый этап — свой вычислительный граф); рёбра пайплайна соединяют выходы одних этапов с входами других. Таким образом, пайплайн — это **граф графов**: уровень композиции выше, чем один Stage.

- **Материально:** пайплайн — совокупность этапов (каждый из которых сам — совокупность блоков) и связей между ними; данные «текут» от этапа к этапу.
- **Идеально:** пайплайн задаёт **последовательность или сеть шагов** — полный сценарий вычисления (например, encode → denoising loop → decode, или цепочка препроцессинга, генерации, постобработки). Один пайплайн — одна «идея» полного процесса.

Запуск пайплайна означает последовательный (или по топологии графа) запуск этапов и передачу выходов одного этапа на входы следующего.

### 3.2 Физические аналогии для Pipeline

#### A. Многошаговый процесс / каскад реакций

В ядерной или химической физике **каскад реакций** — последовательность процессов: продукт одной реакции служит входом для следующей (например, цепочка распадов или многостадийный синтез). **Пайплайн** — аналог такого каскада: этап 1 → этап 2 → … → этап N; каждый этап — отдельный «реакционный узел» со своими входами и выходами.

- **Один шаг каскада** ↔ **один Stage**.
- **Вся цепочка** ↔ **Pipeline**: полный сценарий от начальных данных до конечного результата.

#### B. Фазовое пространство / последовательность «фаз» процесса

В термодинамике или динамике системы можно выделять **фазы** процесса (нагрев, реакция, охлаждение). Каждая фаза — отдельная подсистема с своими уравнениями; вместе они образуют **один полный цикл**. Пайплайн аналогичен **последовательности фаз**: каждый этап — одна «фаза» вычисления; порядок этапов задаёт временную или логическую последовательность.

#### C. Несколько диаграмм в одном процессе

В КТП сложный процесс может требовать **несколько диаграмм** (например, дерево и петли) или **несколько подпроцессов** (например, рождение частицы, затем её распад). **Pipeline** можно уподобить **набору таких подпроцессов**, упорядоченных в один сценарий: сначала «подпроцесс 1» (этап 1), затем «подпроцесс 2» (этап 2) и т.д. Каждый подпроцесс — свой граф (Stage); вместе они образуют граф этапов (Pipeline).

Итог: **Pipeline** — уровень **композиции целостных единиц** (этапов); физически — каскад реакций, последовательность фаз или подпроцессов, образующих один полный сценарий.

---

## 4. Модальность и домен; контекст

Эти сущности в Philosophy заданы как заглушки (п. 7); здесь они кратко раскрываются в той же логике уровней и с физическими аналогиями.

### 4.1 Модальность / домен

**Модальность** — слой «изображение», «текст», «звук», «3D»; **домен** — «генерация», «обучение», «инференс». То есть **какой тип данных** или **какой режим** доминирует в графе (или в пайплайне).

**Физическая аналогия:**

- В Стандартной модели есть **секторы** (электромагнитный, сильный, слабый) и **типы полей** (поле электронов, поле кварков, поле фотонов). Модальность аналогична **выбору сектора или типа поля**: «в этом графе течёт изображение» как «в этом процессе участвуют только фотоны и заряженные лептоны». Домен («инференс» vs «обучение») аналогичен **режиму процесса** (рассеяние vs радиационная коррекция) — одна и та же топология, разная цель или фаза.
- **Разные модальности** могут использовать одни и те же типы узлов (Backbone, Codec, …), но с разными весами, кодеком или кондиционером — как разные **каналы** или **вкусы** в одном лагранжиане.

Модальность и домен задают **рамку**, в которой граф и пайплайн интерпретируются (какие данные, какой режим), не меняя саму иерархию Stage → Pipeline → … .

### 4.2 Контекст / среда мира

**Контекст** — параметры, правила, глоссарий, стиль: то, что задаёт «рамку» генерации или обучения, не будучи ещё полным миром (World).

**Физическая аналогия:**

- **Граничные условия** и **внешние параметры** (температура, объём, константы связи): они не входят в «граф процесса» как узлы, но задают, **в каких условиях** процесс идёт. Контекст — аналог таких условий: глоссарий и стиль задают «температуру» и «объём» мира.
- **Симметрия / калибровка**: группа симметрии фиксирует допустимые преобразования; контекст (правила, форматы) фиксирует допустимые преобразования данных и сценариев в графе.

Контекст можно считать **параметризацией окружения**, в котором работают Stage и Pipeline; при развитии философии он может быть оформлен как отдельная сущность (материальная — конфиг, идеальная — правила и ограничения) или как часть World.

---

## 5. Сводная таблица уровней и физических аналогий

| Уровень в Yggdrasil | Сущность | Материя | Идея | Аналогия в физике |
|---------------------|----------|--------|------|---------------------|
| **Фундамент** | Block, Node | Block: параметры, тензоры | Node: положение, связи | Фермионы (содержимое), бозоны (взаимодействие) |
| **Над фундаментом** | Abstract Backbone, Solver, Codec, Adapter | Блок в узле | Тип узла, задача | Типы частиц, типы вершин |
| **Граф как целое** | **Stage (этап)** | Множество узлов-блоков и рёбер | Один граф, один контракт, одна семантика шага | Один процесс / одна диаграмма Фейнмана; одна связанная система (атом, молекула); один «эксперимент» |
| **Граф этапов** | **Pipeline** | Множество этапов и связей между ними | Последовательность или сеть шагов, полный сценарий | Каскад реакций; последовательность фаз; набор подпроцессов в одном сценарии |
| **Рамка** | Модальность, домен, контекст | Конфиг, данные, правила | Сектор, режим, граничные условия | Сектор теории, тип поля; граничные условия, внешние параметры |

---

## 6. Схема иерархии (фрагмент)

```
Pipeline (граф этапов)
    │  узлы = Stage; рёбра = потоки между этапами
    │  Аналогия: каскад реакций, последовательность фаз
    ▼
Stage (базовый граф / граф как единица)
    │  узлы = Backbone, Solver, Codec, Adapter, …; рёбра = потоки между портами
    │  Аналогия: один процесс, одна диаграмма, одна связанная система
    ▼
Узлы графа (типизированные: Abstract Backbone, Solver, Codec, Adapter, …)
    │  см. Abstract_Nodes_Level.md
    ▼
Abstract Base Block  +  Abstract Graph Node (фермионы + бозоны)
```

---

## 7. Связь с другими документами

- **Философия:** [Philosophy.md](Philosophy.md) — раздел 7 (промежуточные этапы), раздел 8.6 (иерархия уровней: Stage = уровень 5, Pipeline = уровень 4).
- **Уровень абстрактных узлов:** [Abstract_Nodes_Level.md](Abstract_Nodes_Level.md) — типы узлов и физические аналогии (типы частиц, вершины).
- **План работ:** [To_do.md](To_do.md) — этапы, в которых задействованы графы, пайплайны, модальности.

При добавлении новых сущностей на уровне Stage или Pipeline (например, новых видов этапов или правил композиции пайплайнов) их следует согласовывать с двойственной природой графа (материя = узлы и данные, идея = топология и семантика целого) и с физическими аналогиями: этап — один процесс/одна система; пайплайн — каскад таких процессов.
