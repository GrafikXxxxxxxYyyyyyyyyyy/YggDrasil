# TODO — задачи для разработки YggDrasil

Список задач, которые необходимо решить в порядке приоритета.

---

## 1. Проверка согласованности пайплайна генерации YggDrasil и Diffusers

Сравнить выход пайплайна генерации YggDrasil с эталонным Diffusers на одинаковых входах (prompt, seed, steps, guidance_scale). Убедиться, что результаты визуально и метрически близки.

- [ ] SD 1.5
- [ ] SDXL
- [ ] SD3
- [ ] FLUX (если поддерживается)

---

## 2. Проверка работы всех high-level пайплайнов

Проверить, что все высокоуровневые пайплайны (InferencePipeline, TrainingPipeline) работают корректно:

- [ ] InferencePipeline.from_template(...)
- [ ] InferencePipeline.from_pretrained(...)
- [ ] InferencePipeline.from_diffusers(...)
- [ ] InferencePipeline.from_combined(...)
- [ ] TrainingPipeline.from_template(...)
- [ ] TrainingPipeline.from_graph(...)

---

## 3. Сборка своего пайплайна: добавление узлов в граф

Написать руководство и реализовать механизм «сборки своего пайплайна» путём добавления узлов в граф. Узлы должны автоматически понимать, куда подключаться (auto-attach).

- [ ] Документация: как добавлять узлы в ComputeGraph
- [ ] Реализация/проверка add_node(type=..., auto_connect=True) с role_rules
- [ ] Пример: сборка простого txt2img из пустого графа

---

## 4. Сборка сложных многостадийных пайплайнов

Продумать и реализовать создание сложных многостадийных пайплайнов: как добавлять стадии (stages) и заполнять каждую стадию узлами.

- [ ] Механизм add_stage() / AbstractStage
- [ ] Связывание выходов одной стадии с входами следующей
- [ ] Пример: pipeline из нескольких стадий

---

## 5. Пример: трёхстадийный пайплайн (детекция → инпейнтинг → видео)

Собрать и проверить пайплайн из трёх стадий:

**Стадия 1.** Изображение → модель детекции человека → маска человека; остальное изображение зашумляется.

**Стадия 2.** Inpainting-пайплайн: дорисовка фона по маске.

**Стадия 3.** Image-to-video: анимация полученного изображения.

- [ ] Стадия 1: детекция + маска + подготовка для инпейнтинга
- [ ] Стадия 2: inpainting (замена фона)
- [ ] Стадия 3: image-to-video (анимация)
- [ ] Связка стадий в один combined pipeline

---

## 6. Создание многостадийного пайплайна из пустого графа

Продумать и проверить создание многостадийного пайплайна «с нуля» (из пустого ComputeGraph) и запуск через высокоуровневый InferencePipeline.

- [ ] API для построения multi-stage графа с нуля
- [ ] Валидация: граф корректен и выполним
- [ ] Проверка: InferencePipeline(graph).__call__(...) успешно выполняется

---

## 7. Обучение любого компонента графа через TrainingPipeline

Проверить и доработать обучение любого узла графа через TrainingPipeline (train_nodes, train_stages).

- [ ] Обучение одного узла (например, LoRA, ControlNet)
- [ ] Обучение нескольких узлов с разными LR
- [ ] Обучение стадий (train_stages)
- [ ] Сохранение и загрузка чекпоинтов

---

## 8. Документация

- [ ] Восстановить или создать структуру `docs/` (API reference, туториалы, custom_blocks)
- [ ] Руководство «Сборка своего пайплайна» (см. задачу 3)
- [ ] Описать двойную инициализацию AbstractBaseBlock (nn.Module + super) в docstring — см. AUDIT_REPORT
- [ ] Унифицировать docstring и сообщения пользователю (русский/английский) — см. AUDIT_REPORT

---

## 9. Тесты и CI

- [ ] E2E-тесты: `Pipeline.from_pretrained` для 1–2 моделей (с моком/кешем HF при необходимости)
- [ ] E2E-тесты: `Runner.execute` по сохранённому workflow
- [ ] Тесты на обработку ошибок: некорректный конфиг, отсутствующий блок, неверные порты
- [ ] CI: `ruff check`, `ruff format`, `pytest`; по возможности — `mypy`
- [ ] Исправить замечания Ruff (E402, I001): `ruff check --fix`, `ruff format`

---

## 10. Развёртывание и API

- [ ] Проверить работу Modal, RunPod, Vast.ai (деплой InferencePipeline)
- [ ] Docker: проверить `docker-compose.yaml`, образ собирается и запускается
- [ ] FastAPI: валидация схем, обработка ошибок, логирование traceback — см. AUDIT_REPORT
- [ ] Gradio UI: интеграция с dynamic UI, проверка всех модальностей
- [ ] CORS и безопасность: ограничить `cors_origins` для продакшена

---

## 11. Плагины и расширения

- [ ] Проверить работу плагинов: image, audio, video, molecular, timeseries, text, threed
- [ ] Extensions loader: интеграция в основной flow (CLI/API загрузка внешних блоков)
- [ ] Пример кастомного плагина (plugins/custom): документация и рабочий пример
- [ ] Регистрация своей модальности через плагин — сквозной пример

---

## 12. Интеграции (по ТЗ)

- [ ] ComfyUI: импорт/экспорт workflow (если реализуемо)
- [ ] ONNX export: проверить `deployment/export/onnx.py`, работоспособность
- [ ] Hub / MODEL_REGISTRY: полнота маппинга model_id → шаблон для SD 1.5, SDXL, SD3, FLUX

---

## 13. Качество кода (по AUDIT_REPORT)

- [ ] Сузить `except Exception` в API, serving, integration: логировать traceback, перевыбрасывать при необходимости
- [ ] Убрать или обновить упоминание `requirements-klein.txt` в pyproject.toml/документации
- [ ] Пошаговая проверка mypy в CI (с исключениями для тяжёлых модулей)

---

## 14. Примеры и туториалы

- [ ] Примеры для аудио (Stable Audio и др.) — восстановить или создать
- [ ] Примеры для видео (AnimateDiff, CogVideoX и др.) — восстановить или создать
- [ ] Туториал: регистрация своего блока, сборка графа, обучение
- [ ] Обновить generation_guide.ipynb и YggDrasil_Guide.ipynb под актуальный API

---

## Порядок выполнения

1. **Задачи 1–2** — базовая проверка (согласованность с Diffusers, работа high-level API).
2. **Задачи 3–4** — основы кастомной сборки и многостадийности.
3. **Задачи 5–6** — сложный пример и сквозная проверка.
4. **Задача 7** — обучение.
5. **Задачи 8–9** — документация и CI (параллельно с основными).
6. **Задачи 10–14** — развёртывание, плагины, интеграции, качество кода, примеры.
