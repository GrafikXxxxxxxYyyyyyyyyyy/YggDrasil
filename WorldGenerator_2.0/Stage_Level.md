# Уровень перехода (Stage): граф пайплайнов и метаморфоза state

**Единый канон проекта:** [CANON.md](CANON.md). Модель гиперграфа и гиперссылки: [HYPERGRAPH_AND_HYPERLINKS.md](HYPERGRAPH_AND_HYPERLINKS.md).

**Переход (transition)** в широком смысле — фундаментальное изменение состояния системы, **метаморфоза** (один объект в другой, материя ↔ идея; см. [Scheme.md](Scheme.md) §1.0). **Уровень перехода** — уровень, на котором такие метаморфозы реализуются. В архитектуре этот уровень называется **Stage (этап):** **Stage — граф пайплайнов**, реализующий **один переход** в цикле мира. Цикл мира ([Scheme.md](Scheme.md), [World_Level.md](World_Level.md)) — непрерывная цепь переходов (Философ → Автор → Среда → Архитектор → Творец); каждое звено — переход, реализуемый одним Stage. Ниже: суть уровня перехода (Stage), компоненты, какие задачи решает.

---

## 1. Положение уровня перехода в иерархии. State как поток по уровням

Иерархия: **граф** (узлы = узлы-задачи) → **пайплайн** (узлы = графы; пайплайн может состоять из одного графа) → **уровень перехода (Stage)** (узлы = пайплайны, «**граф пайплайнов**»; между переходами передаётся **state**). **State** течёт по цепочке: на уровне графа — данные между узлами, на уровне пайплайна — данные между графами, на уровне перехода и мира — **state** между переходами (в цикле мира — пять блоков по [System.md](System.md) и [Scheme.md](Scheme.md)).

| Уровень | Состоит из | Что передаётся по связям |
|---------|------------|---------------------------|
| **Граф** ([Graph_Level.md](Graph_Level.md)) | Узлов-задач (Backbone, Solver, Codec, Conditioner, Tokenizer, …) | Данные между портами узлов. Одна цельная задача. |
| **Пайплайн** ([Pipeline_Level.md](Pipeline_Level.md)) | Целых графов (один или несколько; пайплайн может состоять из **одного графа**) | Данные между графами. «Граф графов». |
| **Переход (Stage)** | **Пайплайнов** (узлы = пайплайны) | **Stage — граф пайплайнов**, реализующий **один переход** (метаморфозу state). Между переходами в мире передаётся **state**. |
| **Выше** | **Мир (World)** ([World_Level.md](World_Level.md), [System.md](System.md)) | **Мир — цепочка переходов:** узлами мира являются переходы (Философ, Автор, Среда, Архитектор, Творец); между переходами передаётся state. Циклический граф. |

Итого: **граф** — одна задача; **пайплайн** — граф графов; **Stage (уровень перехода)** — **граф пайплайнов**, осуществляющий одну **метаморфозу** state. Мир собран из **переходов**, каждое звено цикла — переход со своей ролью.

---

## 2. Суть уровня перехода (Stage): граф пайплайнов, реализующий один переход

**Stage (уровень перехода)** — это **граф, узлами которого являются пайплайны** ([Pipeline_Level.md](Pipeline_Level.md)); пайплайн может состоять из одного графа ([Graph_Level.md](Graph_Level.md)). Stage реализует **один переход** в цикле мира — одну **метаморфозу state** (фундаментальное преобразование: материя → идея, идея → материя, объект в объект; [Scheme.md](Scheme.md) §1.0).

- **Узлы Stage** — пайплайны (один или несколько). Рёбра соединяют выходы одного пайплайна с входами другого (или с внешним входом/выходом). При одном пайплайне Stage имеет одну вершину — вырожденный случай.
- **Роль перехода** в процессе: какая метаморфоза осуществляется (например, артефакты → идеализированное описание; описание → конфигурация; конфигурация → артефакты; state → обновление мира по [Scheme.md](Scheme.md)).
- **Входы и выходы:** часть общего **state**, передаваемый между переходами (например, state с блоком 1 → переход Архитектор → state с блоком 2).

**Суть уровня перехода** — **граф пайплайнов**, осуществляющий одну метаморфозу: задаёт, какие пайплайны выполняются и как данные (state) преобразуются. Один и тот же тип перехода (например, Творец) в разных мирах может быть реализован разным графом пайплайнов; Stage задаёт **место** в цепочке переходов и **контракт** входа/выхода.

---

## 3. Из чего состоит уровень перехода: компоненты

На уровне перехода основная сущность — **Stage** (реализация одного **перехода**). Компонентами уровня являются:

### 3.1 Stage = граф пайплайнов (один переход)

- **Идентификация:** имя или `stage_id` (например, `creator`, `idealizer`, `author`, `materializer` в цикле мира по [Scheme.md](Scheme.md)).
- **Узлы Stage** — **пайплайны**. Каждый узел — пайплайн (может состоять из одного графа). Рёбра соединяют выходы одного пайплайна с входами другого (или с внешним входом/выходом).
- **Контракт перехода:** входы и выходы (что принимает из state от предыдущего перехода, что отдаёт дальше). Часто блоки state: «вход — state с блоком 1», «выход — state с блоком 2».
- **Выполнение:** по топологии графа пайплайнов выполняются пайплайны; результат мапится в выход перехода (блоки state).

### 3.2 Связь Stage с пайплайнами и миром

- **Пайплайн** ([Pipeline_Level.md](Pipeline_Level.md)) — узел Stage; пайплайн может состоять из **одного графа**.
- **Stage** — **граф пайплайнов**, реализующий **один переход** (метаморфозу state). То, что течёт между переходами в мире, — **state**.

Уровень перехода **состоит из Stage**; каждый Stage — **граф пайплайнов**, осуществляющий одну метаморфозу. Между переходами в цикле мира течёт **state** ([System.md](System.md), [Scheme.md](Scheme.md)).

---

## 4. Какие задачи позволяет решать уровень перехода

Уровень перехода (Stage) даёт возможность:

1. **Разбить процесс на переходы (фазы).** Цикл мира (Философ → Автор → Среда → Архитектор → Творец) по [Scheme.md](Scheme.md) представляется как последовательность **переходов**. Каждый переход — метаморфоза state с чёткой целью; **state** переходит от перехода к переходу (течёт по «графу переходов»). Без уровня перехода пришлось бы описывать весь цикл одним графом или пайплайном, что размывает границы метаморфоз.

2. **Подставлять разные реализации в один переход.** Один и тот же переход (например, Творец) в разных мирах может использовать **разные пайплайны или графы**. Stage фиксирует **роль** (какая метаморфоза) и **контракт** (вход/выход), а не единственную реализацию — поддерживается вариативность и переиспользование.

3. **Чётко ограничить «что происходит на этом шаге».** Входы и выходы перехода явные; отладка, логирование и мониторинг можно привязывать к переходам. Удобно рассуждать по фазам: «на переходе Творец выполняется такой-то пайплайн», «на переходе Автор — такой-то граф».

4. **Переиспользовать переходы в разных мирах и сценариях.** Описание Stage (имя, контракт, ссылка на пайплайн/граф) можно выносить в шаблоны и подставлять в разные циклы мира или в нециклические процессы с фазами.

5. **Комбинировать пайплайны внутри одного перехода.** Поскольку Stage — **граф пайплайнов**, в одном переходе может быть несколько пайплайнов (например, быстрая проверка, основная генерация, постобработка); рёбра задают порядок и потоки; результат мапится в state.

---

## 5. Пример: переходы в цикле мира

В каноне World Generator 2.0 мир — **циклическая цепочка из пяти переходов**. Каждое звено — **переход**, реализуемый одним Stage:

| Переход | Вход (state) | Условие выполнения / Действие | Выход (state) |
|------|----------------|-------------------------------|----------------|
| **Философ** (Philosopher) | Блоки 1, 2, 3 | **Только если заполнены 1, 2, 3.** Описывает блок 3 → блок 4 | Блок 4 |
| **Автор** (Author) | Блоки 1–4 | **Только если заполнены 1, 2, 3, 4.** В ядре LLM; контекст = неизменённый мир, state. Генерирует **описание** → блок 5 | Блок 5 |
| **Среда** (Environment) (World update + Development) | State, опционально Action | **World update — только при полностью заполненном state (все 5 блоков).** Development — безусловно → новый эпизод | Новый state с блоком 1 |
| **Архитектор** (Architect) | Блок 1 | По потоку **всегда state в нужном виде.** В ядре LLM; контекст = изменённый мир. Генерирует **конфигурацию** → блок 2 | Блок 2 |
| **Творец** (Creator) | Блок 2 | По потоку **всегда state в нужном виде.** Генерация артефактов | Блок 3 |

На переходе **Творец** (или **Философ**) узлами Stage являются **пайплайны** ([Pipeline_Level.md](Pipeline_Level.md)) — например, пайплайн «текст → картинка → апскейл» или один граф text-to-image ([Graph_Level.md](Graph_Level.md)). На переходе **Автор** — пайплайн, формирующий описание. Stage задаёт **переход** (метаморфозу) и **контракт по state**; конкретный граф пайплайнов задаётся конфигурацией.

---

## 6. Сводка

| Понятие | Определение |
|---------|-------------|
| **Уровень перехода** | Уровень выше пайплайна и графа; основная сущность — **Stage**. Реализует **один переход** (метаморфозу state) в цикле мира; цикл собран из переходов. |
| **Переход (Stage)** | **Граф пайплайнов**, осуществляющий одну **метаморфозу** state (материя ↔ идея; [Scheme.md](Scheme.md) §1.0). Контракт — вход/выход по state. Каждое звено цикла мира — переход со своей ролью. |
| **Компоненты уровня** | Stage; каждый Stage — граф пайплайнов (узлы = пайплайны), один переход. |
| **Задачи уровня** | Разбиение процесса на переходы; подстановка разных пайплайнов/графов в один переход; чёткая граница метаморфозы; переиспользование переходов; комбинирование пайплайнов внутри одного перехода. |
| **State** | То, что передаётся между переходами (в цикле мира — пять блоков) и претерпевает метаморфозы. По цепочке граф → пайплайн → переход: данные, затем **state** между переходами. |

Подробнее: [Graph_Level.md](Graph_Level.md), [Pipeline_Level.md](Pipeline_Level.md). Уровень мира (мир как цепочка переходов): [World_Level.md](World_Level.md). Канон цикла и state: [System.md](System.md), [Scheme.md](Scheme.md).
