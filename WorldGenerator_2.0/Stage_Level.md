# Уровень этапа (Stage): графы, пайплайны и фазы процесса

Описание **уровня этапа (Stage)** как уровня выше пайплайна ([Pipeline_Level.md](Pipeline_Level.md)) и графа ([Graph_Level.md](Graph_Level.md)). **Этап — это граф пайплайнов:** узлами этапа являются пайплайны (пайплайн может состоять из одного графа). Рёбра этапа соединяют выходы одного пайплайна с входами другого; по рёбрам передаётся то, что на уровне мира становится **state**. **Этап как фаза — первая сущность, которая исполняет свою роль в цикле мира:** цикл мира ([Scheme.md](Scheme.md), [System.md](System.md)) собран из этапов (Философ, Автор, Среда, Архитектор, Творец); каждое звено цикла — это этап со своей ролью; граф мира есть граф этапов, и именно этап (фаза) является той единицей, которая «играет» в этом цикле. Ниже: суть этапа, компоненты, какие задачи решает.

---

## 1. Положение этапа в иерархии. State как поток по уровням

Иерархия: **граф** (узлы = узлы-задачи) → **пайплайн** (узлы = графы, «граф графов»; пайплайн может состоять из одного графа) → **этап** (узлы = пайплайны, «**граф пайплайнов**»; между этапами передаётся **state**). То есть **state** — то, что течёт по этой цепочке: на уровне графа — данные между узлами, на уровне пайплайна — данные между графами, на уровне этапа и мира — **state** между этапами (в цикле мира — пять блоков по [System.md](System.md) и [Scheme.md](Scheme.md)).

| Уровень | Состоит из | Что передаётся по связям |
|---------|------------|---------------------------|
| **Граф** ([Graph_Level.md](Graph_Level.md)) | Узлов-задач (Backbone, Solver, Codec, Conditioner, Tokenizer, …) | Данные между портами узлов. Одна цельная задача. |
| **Пайплайн** ([Pipeline_Level.md](Pipeline_Level.md)) | Целых графов (один или несколько; пайплайн может состоять из **одного графа**) | Данные между графами. «Граф графов». |
| **Этап (Stage)** | **Пайплайнов** (узлы этапа = пайплайны) | **Этап — граф пайплайнов.** По рёбрам этапа — данные между пайплайнами; между этапами в мире передаётся **state**. |
| **Выше** | **Мир (World)** ([World_Level.md](World_Level.md), [System.md](System.md)) | **Мир — граф этапов:** узлами мира являются этапы; между этапами передаётся state. Циклический граф (Философ → Автор → Среда → Архитектор → Творец). |

Итого: **граф** — одна задача; **пайплайн** — граф графов (в т.ч. из одного графа); **этап** — **граф пайплайнов**. По этапам течёт **state**. **В цикле мира этап (фаза) — первая сущность, которая исполняет свою роль:** мир собран из этапов, каждое звено цикла — этап со своей ролью (Философ, Автор, Среда, Архитектор, Творец).

---

## 2. Суть этапа (Stage): этап — граф пайплайнов

**Этап (Stage)** — это **граф, узлами которого являются пайплайны** ([Pipeline_Level.md](Pipeline_Level.md)); пайплайн может состоять из одного графа ([Graph_Level.md](Graph_Level.md)), так что узлом этапа может быть и «один граф в обёртке пайплайна». У этапа есть:

- **Узлы этапа** — пайплайны (один или несколько). Рёбра этапа соединяют выходы одного пайплайна с входами другого (или с внешним входом/выходом этапа). При одном пайплайне этап имеет одну вершину — вырожденный случай «графа пайплайнов».
- **Роль (назначение) этапа** в процессе: что на этом шаге делается в рамках целого (например, «генерация артефактов», «идеализация», «обновление мира», «материализация конфигурации» по [Scheme.md](Scheme.md)).
- **Входы и выходы этапа:** как правило, часть общего **state** или контейнер данных, передаваемый между этапами (например, state с блоком 1 → этап Архитектор → state с блоком 2).

**Суть этапа** — **граф пайплайнов**: задаёт, какие пайплайны выполняются на этой фазе и как данные (и в итоге state) передаются между ними. Один и тот же тип этапа (например, Творец) в разных мирах может быть реализован разным графом пайплайнов (разные пайплайны, разный порядок); этап задаёт **место** в процессе и **контракт** входа/выхода.

---

## 3. Из чего состоит уровень этапа: компоненты

На уровне этапа основная сущность — **Stage (этап)**. Компонентами уровня являются:

### 3.1 Этап (Stage) = граф пайплайнов

- **Идентификация:** имя или `stage_id` (например, `creator`, `idealizer`, `author`, `materializer` в цикле мира по [Scheme.md](Scheme.md)).
- **Узлы этапа** — **пайплайны**. Каждый узел этапа есть пайплайн (который может состоять из одного графа). Рёбра этапа соединяют выходы одного пайплайна с входами другого (или с внешним входом/выходом этапа).
- **Контракт этапа:** входы и выходы этапа (что принимает из state или от предыдущего этапа, что отдаёт дальше). Часто блоки state: «вход — state с блоком 1», «выход — state с блоком 2».
- **Выполнение этапа:** по топологии графа пайплайнов выполняются пайплайны; данные передаются по рёбрам этапа; результат мапится в выход этапа (в т.ч. в блоки state).

### 3.2 Связь этапа с пайплайнами и графами

- **Пайплайн** ([Pipeline_Level.md](Pipeline_Level.md)) — узел этапа; у пайплайна есть входы и выходы. Пайплайн может состоять из **одного графа** — тогда узел этапа по сути одна задача в обёртке пайплайна.
- **Этап** — **граф пайплайнов**: узлы = пайплайны, рёбра = связи между выходами и входами пайплайнов. Входы/выходы этапа мапятся на входы/выходы пайплайнов на границе этапа; то, что течёт между этапами в мире, — **state**.

Уровень этапа **состоит из этапов**; каждый этап — **граф пайплайнов** (в вырожденном случае — один пайплайн). Между этапами в цикле мира течёт **state** ([System.md](System.md), [Scheme.md](Scheme.md)).

---

## 4. Какие задачи позволяет решать уровень этапа

Уровень этапа даёт возможность:

1. **Разбить процесс на фазы.** Цикл мира (Философ → Автор → Среда → Архитектор → Творец) по [Scheme.md](Scheme.md) естественно представляется как последовательность **этапов**. Каждый этап — чётко названный шаг с понятной целью; **state** переходит от этапа к этапу (state и есть то, что течёт по «графу этапов»). Без уровня этапа пришлось бы описывать весь цикл одним графом или одним пайплайном, что размывает границы фаз.

2. **Подставлять разные реализации в одну фазу.** Один и тот же этап (например, Творец) в разных мирах или конфигурациях может использовать **разные пайплайны или графы** (разные модели генерации, разный порядок графов). Этап фиксирует **роль** (что на этом шаге делается) и **контракт** (вход/выход), а не единственную реализацию — это поддерживает вариативность и переиспользование.

3. **Чётко ограничить «что происходит на этом шаге».** Входы и выходы этапа явные; отладка, логирование и мониторинг можно привязывать к этапам. Удобно рассуждать о процессе по фазам: «на этапе Творец выполняется такой-то пайплайн», «на этапе Автор — такой-то граф».

4. **Переиспользовать этапы в разных мирах и сценариях.** Описание этапа (имя, контракт, ссылка на пайплайн/граф) можно выносить в шаблоны и подставлять в разные циклы мира или в нециклические процессы с фазами.

5. **Комбинировать пайплайны внутри одной фазы.** Поскольку этап — **граф пайплайнов**, на одном этапе может быть несколько пайплайнов (например, пайплайн «быстрая проверка» из одного графа, пайплайн основной генерации, пайплайн постобработки); рёбра этапа задают порядок и потоки данных; результат мапится в state.

---

## 5. Пример: этапы в цикле мира

В каноне World Generator 2.0 мир — **циклический граф из пяти переходов** (звеньев). Каждое звено можно рассматривать как **этап**:

| Этап | Вход (state) | Условие выполнения / Действие | Выход (state) |
|------|----------------|-------------------------------|----------------|
| **Философ** (Philosopher) | Блоки 1, 2, 3 | **Только если заполнены 1, 2, 3.** Описывает блок 3 → блок 4 | Блок 4 |
| **Автор** (Author) | Блоки 1–4 | **Только если заполнены 1, 2, 3, 4.** В ядре LLM; контекст = неизменённый мир, state. Генерирует **описание** → блок 5 | Блок 5 |
| **Среда** (Environment) (World update + Development) | State, опционально Action | **World update — только при полностью заполненном state (все 5 блоков).** Development — безусловно → новый эпизод | Новый state с блоком 1 |
| **Архитектор** (Architect) | Блок 1 | По потоку **всегда state в нужном виде.** В ядре LLM; контекст = изменённый мир. Генерирует **конфигурацию** → блок 2 | Блок 2 |
| **Творец** (Creator) | Блок 2 | По потоку **всегда state в нужном виде.** Генерация артефактов | Блок 3 |

На этапе **Творец** (или **Философ**) узлами графа этапа являются **пайплайны** ([Pipeline_Level.md](Pipeline_Level.md)) — например, пайплайн «текст → картинка → апскейл» или один пайплайн из одного графа text-to-image ([Graph_Level.md](Graph_Level.md); пайплайн может состоять из одного графа). На этапе **Автор** — пайплайн (или один граф в обёртке пайплайна), формирующий описание по артефактам. Этап задаёт **фазу** и **контракт по state**; конкретный **граф пайплайнов** (какие пайплайны, как соединены) задаётся конфигурацией этапа.

---

## 6. Сводка

| Понятие | Определение |
|---------|-------------|
| **Уровень этапа** | Уровень выше пайплайна и графа; основная сущность — **Stage (этап)**. В цикле мира **этап как фаза — первая сущность, исполняющая свою роль** (цикл собран из этапов). |
| **Этап (Stage)** | **Граф пайплайнов:** узлами этапа являются пайплайны (пайплайн может состоять из одного графа). Рёбра этапа соединяют выходы одного пайплайна с входами другого. Контракт этапа — вход/выход по state. Каждое звено цикла мира — этап со своей ролью. |
| **Компоненты уровня** | Этапы; каждый этап — граф пайплайнов (узлы = пайплайны). |
| **Задачи уровня** | Разбиение процесса на фазы; подстановка разных пайплайнов/графов в одну фазу; чёткая граница шага; переиспользование этапов; комбинирование графов и пайплайнов внутри одной фазы. |
| **State** | То, что передаётся между этапами (в цикле мира — пять блоков). По цепочке граф → пайплайн → этап: данные между узлами графа, данные между графами в пайплайне, **state** между этапами. |

Подробнее о графе и пайплайне: [Graph_Level.md](Graph_Level.md), [Pipeline_Level.md](Pipeline_Level.md). Уровень мира (мир как граф этапов): [World_Level.md](World_Level.md). Канон цикла и state: [System.md](System.md), [Scheme.md](Scheme.md).
