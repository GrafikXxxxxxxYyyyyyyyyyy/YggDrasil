# Схема мира (канон World Generator 2.0)

**Единый источник правды** по операционной модели мира: цикл, state, обновление и развитие. Философская основа — [Philosophy.md](Philosophy.md). Уровень мира (мир как граф этапов) описан подробно в [World_Level.md](World_Level.md).

---

## 1. Мир: один цикл, пять переходов

**Мир (World)** — **граф этапов** ([World_Level.md](World_Level.md)): узлами мира являются этапы, по рёбрам передаётся state. На каждом шаге выполняется **в одном и том же порядке**. Двух направлений графа нет.

**Порядок выполнения:**

```
  Философ  →  Автор  →  Среда  →  Архитектор  →  Творец  →  …
```

Между переходами передаётся **state**; каждый переход читает и/или дополняет state.

- **Вход шага:** опционально **Action** (действие пользователя), опционально **State**. **Action** поступает в **Development of the world** как контекст для языковой модели. **State** пользователь может передать в цикл на первом шаге (см. ниже); иначе state попадает в цикл после Development of the world. **Без Action мир тоже развивается:** Development выполняется безусловно и создаёт следующий эпизод по текущему состоянию мира (и при необходимости по переданному Action как контексту).

---

## 2. Среда — два последовательных узла

**Среда (Environment)** в графе мира — **два узла подряд**:

| № | Узел | Вход | Действие | Выход |
|---|------|------|----------|--------|
| **1** | **World update (обновление мира)** | **State** | Выполняется **только при полностью заполненном state** (все 5 блоков). Тогда **обновляет внутреннее содержание мира**: применяет state к миру, меняет контент мира; state сохраняется в директорию. Иначе — обновление не выполняется, state снимается с обработки. | Завершение текущего цикла state. |
| **2** | **Development of the world (развитие мира)** | **Опционально Action** (как контекст для языковой модели) | **Читает содержание мира** и генерирует **описание того, что должно произойти дальше** — с учётом Action (если передан) как контекста для LLM или **без него**. Создаёт **новый state** с заполненным только блоком 1. Выполняется **безусловно** (даже без Action). | Новый state — вход в следующий цикл. |

Итого:

- **Обновление мира** выполняется **только при полностью заполненном state** (все 5 блоков); тогда меняет **внутреннее пространство мира** (контент) на основе state.
- **Развитие мира** читает контент мира и создаёт описание следующего шага (блок 1). **Action опционален:** при отсутствии действия пользователя Development всё равно создаёт следующий эпизод — от начального или текущего состояния мира. **Мир может развиваться сам**, итеративно, без участия пользователя.

После Development of the world новый state идёт в **Архитектор** → **Творец** → **Философ** → **Автор** → **Среда** (World update → Development of the world) → и так далее.

---

## 3. State: пять блоков

State задаётся **пятью блоками**:

| № | Блок |
|---|------|
| **1** | Описание того, что должно было произойти |
| **2** | Конфигурация для генерации артефактов |
| **3** | Сгенерированные артефакты |
| **4** | Описание сгенерированных артефактов |
| **5** | Описание того, что реально произошло в мире |

**World update** выполняется **только при полностью заполненном state** (все пять блоков 1–5). При обновлении мира передаются все параметры state; к изменению контента мира применяется state; state сохраняется в директорию/хранилище.

---

## 4. Жизненный цикл state (по переходам)

**Правило выполнения этапов:** каждый этап выполняется **только если заполнены все нужные ему блоки state**. Философ — только при заполненных 1, 2, 3; Автор — только при 1, 2, 3, 4; World update — **только при полностью заполненном state** (все 5 блоков). Архитектор и Творец по потоку цикла всегда получают state в нужном виде (блок 1 и блок 2 соответственно).

### 4.1 Development of the world (до входа в граф)

- **Вход:** опционально **Action** (действие пользователя); опционально текущее состояние мира (на начальном шаге может не быть state или state неизменён).
- **Действие:** чтение мира (начальное состояние или уже обновлённое); генерация описания того, что должно произойти в следующем state — **с учётом Action, если он есть, или без него**. Даже при отсутствии Action следующий эпизод создаётся — мир развивается по собственной логике.
- **Выход:** новый state с заполненным **только блоком 1**. → передаётся в **Архитектор**.

### 4.2 Архитектор (Architect)

- **В ядре** — языковая модель (LLM).
- **Вход:** state с блоком 1.
- **Условие выполнения:** этап выполняется **только если заполнен блок 1**. По потоку цикла Архитектор всегда получает state в нужном виде (блок 1 от Development).
- **Контекст:** **изменённый мир** (мир уже обновлён на предыдущем шаге цикла через World update). **Контекст задаётся state** (и состоянием мира).
- **Действие:** в этом контексте генерирует **конфигурацию** для генерации артефактов (блок 2) по описанию (блок 1).
- **Выход:** state с **блоком 2**. → **Творец**.

### 4.3 Творец (Creator)

- **Вход:** state с блоком 2.
- **Условие выполнения:** этап выполняется **только если заполнен блок 2**. По потоку цикла Творец всегда получает state в нужном виде (блок 2 от Архитектора).
- **Действие:** по конфигурации генерирует артефакты.
- **Выход:** state с **блоком 3**. → **Философ**.

### 4.4 Философ (Philosopher)

- **Вход:** state с блоками 1, 2, 3 (блок 3 — артефакты от Творца).
- **Условие выполнения:** этап **выполняется только если заполнены блоки 1, 2 и 3**. Если блок 3 отсутствует или пуст — Философ **пропускается** (см. §4.8).
- **Задача Философа:** взять **данные из блока 3** (сгенерированные артефакты) и **описать их содержимое** (что на них изображено/записано, что происходит) — **не** генерировать данные по описаниям из блока 2 (это делает Творец). Результат записывается в **блок 4**.
- **Выход:** state с блоками 1–4. → **Автор**.

### 4.5 Автор (Author)

- **В ядре** — языковая модель (LLM).
- **Вход:** state с блоками 1, 2, 3, 4.
- **Условие выполнения:** этап **выполняется только если заполнены блоки 1, 2, 3 и 4**. Если хотя бы один из них отсутствует или пуст — Автор **пропускается** (см. §4.8).
- **Контекст:** **неизменённый мир** (мир ещё не обновлён в текущем цикле — World update выполняется после Автора). **Контекст задаётся state** (и состоянием мира).
- **Задача Автора:** в этом контексте сформировать **описание** — нарратив «что реально произошло в мире» по блокам 1–4; результат записать в **блок 5**.
- **Особый случай:** если бы к Автору пришёл state только с блоком 1 (без 2–4), по правилу выше этап пропускается; в иных конфигурациях при единственном блоке 1 Автор может копировать блок 1 в блок 5 без генерации.
- **Выход:** state со всеми пятью блоками. → **Среда**.

### 4.6 Среда (Environment): World update и Development of the world

- **World update:** выполняется **только если state полностью заполнен** — то есть заполнены **все пять блоков** (1, 2, 3, 4, 5). Тогда применить state к миру, сохранить state. Иначе — пропустить, state снять с обработки (отбросить).
- **Development of the world:** по Action (если есть) или **без него** создать новый state с блоком 1; цикл повторяется. Мир развивается итеративно и может продолжать циклы **без участия пользователя**.

### 4.7 Development of the world выполняется безусловно

- **Action** не обязателен: если пользователь не передал Action, **Development of the world** всё равно выполняется и создаёт следующий эпизод (блок 1) по текущему состоянию мира. Action, если передан, идёт в Development of the world **как контекст для языковой модели**.

### 4.8 Первая итерация и передача state пользователем

Пользователь на первом шаге может **не передавать state** и **не передавать action**. Если **action не передан** — Development of the world выполняется безусловно.

**Если пользователь не передал state** (или передал пустой state): на **первой итерации цикла** этапы **Философ**, **Автор** и **World update (обновление мира)** **пропускаются** — нет state для их обработки. Цикл **фактически начинается с Development of the world**: выполняется только Development of the world, который создаёт **первый state** в мире (блок 1). Этот state затем идёт в Архитектор → Творец → Философ → Автор → Среда; World update выполнится только когда в одной из следующих итераций state будет полностью заполнен (все 5 блоков).

**Передача state пользователем** (вход в цикл на первой итерации или при «внешнем» state). Каждый этап выполняется **только при заполненных нужных ему блоках**; World update — **только при полностью заполненном state** (все 5 блоков):

| Что передал пользователь | Что выполняется | Обновление мира (World update) |
|--------------------------|-----------------|--------------------------------|
| **Только блок 1** | Философ **пропускается** (нет блоков 2, 3), Автор **пропускается** (нет блоков 2–4). State попадает в Среда. | **Не выполняется** — state не полный (нет блоков 2–5). |
| **Блоки 1 и 2** | Философ **пропускается** (нет блока 3), Автор **пропускается** (нет блоков 3, 4). | **Не выполняется** — state не полный. |
| **Блоки 1, 2, 3** | **Философ** выполняется (блоки 1–3 заполнены) → блок 4; **Автор** выполняется (блоки 1–4 заполнены) → блок 5; state в Среда. | **Выполняется** — после Автора state полный (все 5 блоков). |
| **Блоки 1, 2, 3, 4** | Философ **пропускается**. **Автор** выполняется (блоки 1–4 заполнены) → блок 5. State в Среда. | **Выполняется** — state полный. |
| **Блоки 1, 2, 3, 4, 5** | Философ **пропускается**, Автор **пропускается**. Полный state в Среда. | **Выполняется** — state полный. |

**Без передачи state** (начиная со второй итерации или когда state уже есть): после Development of the world state с блоком 1 идёт в Архитектор → Творец → Философ → Автор → Среда; Философ получает state с блоками 1, 2, 3 и только описывает блок 3 → блок 4; Автор получает state с блоками 1–4 и генерирует блок 5.

---

## 5. Мир один; мир может развиваться сам

**Мир один.** Обновляется применением **state** (World update при блоке 5). Новый state для следующего цикла создаётся в **Development of the world** (чтение мира → описание того, что должно произойти дальше). **Action не обязателен:** при отсутствии действия пользователя Development создаёт следующий эпизод по текущему состоянию мира. Таким образом, мир может **развиваться по собственной логике**, итеративно — артефакты генерируются, описываются, записывается «что реально произошло», применяется к миру; затем Development снова создаёт следующий state, и цикл повторяется без участия пользователя.

---

## 6. Action и State

| | Определение |
|---|-------------|
| **Action** | **Опционально.** Взаимодействие пользователя с миром в начале шага: реплика, команда, выбор. Поступает в **Development of the world** как **контекст для языковой модели**. Не содержит описаний для генерации — они в state. При отсутствии Action Development of the world выполняется **безусловно** и создаёт следующий эпизод по текущему состоянию мира. |
| **State** | Состояние мира (пять блоков). Пользователь может передать state при первом входе в цикл (только блок 1; блоки 1–2; 1–2–3; 1–2–3–4; 1–2–3–4–5) — от этого зависит, какие этапы (Философ, Автор) выполняются или пропускаются и как обновляется мир (см. §4.8). В расширенной форме state может включать идеальную часть (описания, глоссарий, стиль, правила) и материальное представление (метаинформация для генерации артефактов). |

Вход **Development of the world** — опционально Action (как контекст для LLM); при отсутствии — только текущее состояние мира. Development выполняется безусловно. Вход **World update** — State (после прохода по циклу или переданный пользователем).

---

## 7. Одна структура слотов (артефакты)

Между Автором и Архитектором передаётся **один и тот же контейнер слотов** (images, videos, audios, …). В **материальной** форме в слотах — данные (payload); в **идеальной** — описания (description). Автор принимает материальную форму и выдаёт инструкцию для LLM; Архитектор принимает идеальную форму и выдаёт конфиги для генерации. На уровне представления мира в «материи» могут храниться **метаинформация для генерации** (параметры, пайплайн, конфиг), а не сами медиа. Формат артефактов будет задан отдельно.

---

## 8. Сводка

| Вопрос | Ответ |
|--------|--------|
| **Структура мира?** | Один цикл: **Философ → Автор → Среда → Архитектор → Творец**. |
| **Среда?** | Два узла: **(1) World update** (State → обновление контента мира при блоке 5), **(2) Development of the world** (опционально Action → чтение мира → новый state с блоком 1). |
| **Мир?** | Мир один. Обновляется state; новый state создаётся в Development of the world. **Мир может развиваться сам**, итеративно, без Action. |
| **State?** | Пять блоков. World update только при заполненном блоке 5; state сохраняется в директорию. |
| **Вход шага?** | Опционально Action (Development of the world); State (World update после прохода по циклу). При отсутствии Action Development создаёт следующий эпизод по текущему миру. |

**Сериализация мира:** мир как верхняя абстракция **полностью сериализуем**: конфигурационный файл (или шаблон) описывает структуру цикла, узлы, конфиги блоков, схему state, хранилище; из конфига мир можно загрузить, из шаблона + параметров — сгенерировать, с чекпоинтом — загрузить обученный мир. Подробно: [World_Serialization.md](World_Serialization.md).

Дальнейшее расширение (контракты API, иерархия уровней, обучение) опирается на эту схему и не противоречит ей.
