# Сериализация мира: конфигурация и шаблон

**Мир (World)** — верхняя абстракция системы. Он должен быть **полностью сериализуемым** и представляться в виде **конфигурационного файла или шаблона**, из которого мир можно затем загрузить, сгенерировать или восстановить (в т.ч. обученный мир). Документ задаёт, что входит в сериализацию и как устроен конфиг/шаблон.

Схема мира: [Scheme.md](Scheme.md). Блоки и узлы: [Abstract_Block_And_Node.md](Abstract_Block_And_Node.md). **End Worlds** (только контент, без исполняемой части): [END_WORLDS.md](END_WORLDS.md) §4. **Формирование мира по внешнему источнику:** поддержка Fandom.com — заполнение мира в сериализованной форме по ссылке на вики ([FANDOM_COM_SUPPORT.md](FANDOM_COM_SUPPORT.md)).

---

## 1. Принцип: мир — одна единица сериализации. Два крупномасштабных поля

- **Мир** на верхнем уровне — это **одна единица**, которую можно:
  - **сохранить** в виде конфигурации (и при необходимости чекпоинта весов/состояния);
  - **загрузить** из конфигурации (и опционально из чекпоинта);
  - **задать шаблоном** и сгенерировать из него конкретный мир (подстановка параметров, выбор реализаций узлов);
  - **восстановить обученный мир** (конфиг + сохранённые веса и состояние мира).
- В сериализации мира выделяются **два крупномасштабных поля**: (1) **структура / исполняемая часть** — как мир собирается и запускается (локально, на inference-сервере и т.д.): цикл, этапы, пайплайны, конфиги блоков, ссылки на чекпоинты, параметры запуска; (2) **контент мира** — всё, что наполняет мир: описания, история, фото, видео, звуки, артефакты, глоссарий, нарратив. **End World** ([END_WORLDS.md](END_WORLDS.md)) — объект, в сериализации которого присутствует **только контент** (поле 2), без исполняемой части (без весов моделей и возможностей запуска).
- Всё, что определяет мир: структура цикла, узлы, типы блоков, их конфиги, схема state, пути сохранения, начальное содержание мира — **сериализуемо** и входит в конфиг или шаблон.

---

## 2. Что входит в сериализацию мира

Полная сериализация мира охватывает перечисленное ниже. Всё это должно быть представимо в конфигурационном файле (или в наборе связанных файлов: основной конфиг + конфиги узлов, плюс при необходимости чекпоинты).

| Категория | Содержимое |
|-----------|------------|
| **Структура цикла** | Фиксированный порядок: Философ → Автор → Среда → Архитектор → Творец. В конфиге может быть задан как список имён узлов и порядок обхода (или ссылка на канонический шаблон «мир 2.0»). |
| **Узлы графа мира** | Имя каждого узла (Философ, Автор, Среда, Архитектор, Творец; Среда = два подузла: World update, Development of the world). Для каждого узла — тип блока (block_type) и ссылка на конфиг блока. |
| **Конфиги блоков** | Для каждого узла: конфигурация соответствующего блока (гиперпараметры, архитектура, пути к ресурсам, опционально идентификатор чекпоинта). Всё, что нужно для инстанцирования блока при загрузке. |
| **Схема state** | Описание пяти блоков state (и при необходимости расширенной структуры: глоссарий, стиль, правила, слоты артефактов). Достаточно для создания пустого state и для валидации сохраняемых state. |
| **Начальное содержание мира** | Опционально: начальный контент мира (initial story, стартовый глоссарий, правила, стиль), от которого Development of the world может породить первый state. Может быть пустым, заданным в конфиге/отдельном файле или **сформирован по ссылке на вики Fandom.com** ([FANDOM_COM_SUPPORT.md](FANDOM_COM_SUPPORT.md)) — описание мира, персонажи, глоссарии, истории. |
| **Хранилище и пути** | Директория (или URI) для сохранения state при World update; опционально шаблон имён файлов, политика версионирования снапшотов мира. |
| **Метаданные мира** | Идентификатор мира (world_id), версия схемы/конфига, опционально метка времени, теги (например, «обученный», «шаблон»). |

Итого: из конфига можно **однозначно восстановить** структуру мира, типы и конфиги всех блоков, схему state и параметры сохранения. При наличии чекпоинта — также веса блоков и при необходимости последнее сохранённое состояние мира.

---

## 3. Формат конфигурации (конфиг мира)

Конфиг мира — файл (например, YAML или JSON), который описывает мир как единое целое. Ниже — логическая структура; конкретный синтаксис (ключи, вложенность) может быть реализационно выбран (YAML/JSON/TOML).

### 3.1 Верхний уровень

```yaml
# Пример логической структуры (YAML)

world_id: "my_world_001"
schema_version: "2.0"
description: "Мир для сторителлинга в стиле фэнтези"

# Порядок узлов в цикле (канонический порядок мира 2.0)
cycle:
  - Философ
  - Автор
  - Среда
  - Архитектор
  - Творец

# Узлы: имя узла → тип блока и конфиг
nodes:
  Философ:
    block_type: "creator"
    config: { ... }  # или ref: "configs/creator_default.yaml"
  Автор:
    block_type: "idealizer"
    config: { ... }
  Среда:
    block_type: "author"
    # Среда = два подузла: world_update, development_of_the_world
    subnodes:
      world_update: { ... }
      development_of_the_world: { ... }
    config: { ... }
  Архитектор:
    block_type: "materializer"
    config: { ... }
  Творец:
    block_type: "creator"
    config: { ... }

# Схема state (пять блоков; опционально расширенная структура)
state_schema:
  blocks: 5
  # опционально: поля расширенной структуры

# Начальное содержание мира (опционально)
initial_world:
  # initial_story, glossary, style, rules — тексты или ссылки на файлы
  initial_story: "..."
  glossary: { }
  style: ""

# Куда сохранять state при World update
storage:
  state_dir: "./worlds/my_world_001/states"
  # опционально: naming_template, max_snapshots, etc.

# Опционально: чекпоинт обученного мира (веса блоков)
checkpoint_ref: null  # или путь/URI к чекпоинту
```

### 3.2 Узлы и блоки

- Каждый узел цикла задаётся именем и конфигом блока (`block_type` + `config`). Конфиг блока содержит всё необходимое для создания экземпляра (параметры модели, пути, устройство и т.д.).
- **Среда (Environment)** задаётся как узел с двумя подузлами (World update, Development of the world); их поведение может быть в одном блоке с двумя фазами или в двух блоках — в конфиге это фиксируется.
- Конфиги блоков могут быть встроены в конфиг мира или вынесены в отдельные файлы (`ref: "path/to/block_config.yaml"`).

### 3.3 State и хранилище

- **state_schema** задаёт структуру state (пять блоков; при необходимости типы/схемы полей для валидации и сериализации).
- **storage** задаёт, куда при World update сохранять state (директория, шаблон имени, опционально политика ротации).

### 3.4 Метаданные и версия

- **world_id**, **schema_version** позволяют однозначно идентифицировать мир и версию формата конфига. При загрузке можно проверять совместимость версий.
- **checkpoint_ref** — опциональная ссылка на чекпоинт (обученные веса, состояние блоков). Если задана, при загрузке мира веса подтягиваются из чекпоинта.

---

## 4. Шаблон мира (template)

**Шаблон** — конфигурация мира с **параметрами-заполнителями** (placeholders) или с **вариантами выбора** (какой блок использовать для Философа, Автора, Среда, Архитектора, Творца и т.д.). Из шаблона **генерируется** конкретный конфиг мира.

| Аспект | Описание |
|--------|----------|
| **Цель** | Задать «тип» мира (например, «сторителлинг», «генерация артов») и породить из него множество конкретных миров с подставленными параметрами. |
| **Параметры** | В шаблоне вместо конкретных значений — переменные (например, `{{ style }}`, `{{ creator_backbone }}`). При генерации мира передаётся словарь параметров; шаблон рендерится в конфиг. |
| **Варианты** | Опционально: в шаблоне перечислены допустимые реализации узлов (например, несколько типов Творца (или Философа)); при генерации выбирается одна из них по параметру. |
| **Результат** | Конкретный конфиг мира (YAML/JSON), готовый к загрузке. |

Итого: **шаблон** + **параметры** → **конфиг мира** → загрузка → **экземпляр мира**.

---

## 5. Загрузка мира

- **Вход:** конфиг мира (файл или структура в памяти); опционально `checkpoint_ref` или отдельный чекпоинт.
- **Действие:** разбор конфига; создание графа (узлы в порядке цикла); для каждого узла инстанцирование блока по `block_type` и `config`; при наличии чекпоинта — загрузка весов в блоки; инициализация схемы state и при необходимости начального содержания мира; задание путей сохранения.
- **Выход:** объект **World**, готовый к запуску (выполнению цикла). Мир можно запускать (launch) и при необходимости дообучать (train); при следующем сохранении мир снова сериализуется в конфиг + чекпоинт.

---

## 6. Обученный мир (trained world)

- **Обученный мир** — мир, у которого веса блоков (и опционально состояние мира) прошли обучение и сохранены в чекпоинт.
- **Сериализация обученного мира:** тот же **конфиг мира** (структура, типы блоков, конфиги) плюс **чекпоинт** (файл или директория с весами и опционально последним state мира).
- **Загрузка обученного мира:** загрузить конфиг мира; загрузить чекпоинт в блоки (и при необходимости восстановить состояние мира из чекпоинта). Дальше мир работает как обычный, но с обученными весами.

Таким образом, **один и тот же формат конфига** используется и для «пустого» мира, и для сгенерированного из шаблона, и для обученного мира; различие — наличие и содержание чекпоинта и опционально начального состояния.

---

## 7. Сводка

| Вопрос | Ответ |
|--------|--------|
| **Что сериализуется?** | Вся верхняя абстракция мира: структура цикла, узлы, типы и конфиги блоков, схема state, начальное содержание (опционально), пути сохранения, метаданные. |
| **В каком виде?** | Конфигурационный файл (YAML/JSON или аналог); при необходимости набор файлов (главный конфиг + конфиги блоков). Обученный мир = конфиг + чекпоинт. |
| **Шаблон?** | Конфиг с параметрами-заполнителями или вариантами; из шаблона + параметров генерируется конкретный конфиг мира. |
| **Загрузка?** | По конфигу (и опционально чекпоинту) создаётся экземпляр World: граф, блоки, state, хранилище. |
| **Обученный мир?** | Тот же конфиг + чекпоинт (веса, опционально state); загрузка конфига с подгрузкой чекпоинта. |

Связь: [Scheme.md](Scheme.md) (операционная схема мира), [Abstract_Block_And_Node.md](Abstract_Block_And_Node.md) (сериализация блоков и графа).
