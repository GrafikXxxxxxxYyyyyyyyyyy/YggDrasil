# Уровень мира (World): граф этапов

Подробное описание **уровня мира (World)** как верхнего уровня системы. **Мир — это граф этапов:** узлами мира являются этапы (стадии), рёбра задают порядок перехода и поток **state** между этапами. В каноне World Generator 2.0 этот граф **циклический** и имеет фиксированный порядок выполнения.

Ниже: [Stage_Level.md](Stage_Level.md) (этап = граф пайплайнов; этап как фаза — первая сущность, исполняющая роль в цикле мира). Операционный канон цикла и state: [Scheme.md](Scheme.md), [System.md](System.md). Сериализация: [World_Serialization.md](World_Serialization.md).

---

## 1. Положение мира в иерархии

| Уровень | Состоит из | Описание |
|---------|------------|----------|
| **Граф** ([Graph_Level.md](Graph_Level.md)) | Узлов-задач | Одна задача (text-to-image, upscale и т.д.). |
| **Пайплайн** ([Pipeline_Level.md](Pipeline_Level.md)) | Графов | Граф графов; комбинированные задачи. |
| **Этап (Stage)** ([Stage_Level.md](Stage_Level.md)) | Пайплайнов | Граф пайплайнов; этап как фаза — первая сущность, исполняющая роль в цикле мира. |
| **Мир (World)** | **Этапов** | **Мир — граф этапов.** Узлами мира являются этапы; по рёбрам между этапами передаётся **state**. В каноне — **циклический граф** с фиксированным порядком. |

Итого: **граф** (узлы = узлы-задачи) → **пайплайн** (узлы = графы) → **этап** (узлы = пайплайны) → **мир** (узлы = этапы). **Мир — граф этапов;** каждое звено цикла мира — этап со своей ролью.

---

## 2. Определение уровня мира: мир как граф этапов

**Мир (World)** — это **граф, узлами которого являются этапы (Stage)**. Не «граф пайплайнов» и не «граф графов» — на уровне мира единицей является **этап**. Рёбра мира соединяют выход одного этапа с входом другого; по рёбрам передаётся **state** (в каноне — контейнер из пяти блоков). Порядок обхода графа задаёт, в какой последовательности выполняются этапы; в каноне World Generator 2.0 граф **циклический** и порядок **фиксирован**.

- **Узлы мира** — этапы (Философ, Автор, Среда, Архитектор, Творец в одном цикле). Каждый этап — граф пайплайнов ([Stage_Level.md](Stage_Level.md)); внутри этапа выполняются пайплайны, но с точки зрения мира этап — атомарная единица с ролью и контрактом по state.
- **Рёбра мира** — переходы между этапами; по ним передаётся **state**. Вход мира (на шаге цикла) — state после предыдущего прохода или после Development of the world; выход этапа мапится в state и подаётся на вход следующего этапа.
- **Выполнение мира** — последовательное выполнение этапов в порядке, заданном графом; после последнего этапа цикла выполнение повторяется (новый state создаётся в Среда (Development of the world) и снова идёт по циклу).

Таким образом, **мир — граф этапов:** структура мира есть структура этого графа (какие этапы, в каком порядке, как соединены); state течёт по рёбрам; цикл замыкается через Среда (Development of the world создаёт новый state с блоком 1 → Архитектор → … → Среда).

---

## 3. Цикл мира: пять звеньев (пять этапов)

В каноне ([Scheme.md](Scheme.md), [System.md](System.md)) мир — **циклический граф из пяти звеньев**. Каждое звено — **этап** со своей ролью:

```
  Философ  →  Автор  →  Среда  →  Архитектор  →  Творец  →  …
```

| № в цикле | Этап | Вход (state) | Условие выполнения / Роль | Выход (state) |
|-----------|------|----------------|----------------------------|----------------|
| 1 | **Философ** (Philosopher) | Блоки 1, 2, 3 | **Только если заполнены 1, 2, 3.** Описывает блок 3 → блок 4 | Блок 4 |
| 2 | **Автор** (Author) | Блоки 1–4 | **Только если заполнены 1, 2, 3, 4.** В ядре LLM; контекст = неизменённый мир, state. Генерирует **описание** (блок 5) | Блок 5 |
| 3 | **Среда** (Environment) (World update + Development of the world) | State, опционально Action | **World update — только при полностью заполненном state (все 5 блоков).** Development — безусловно → новый эпизод | Новый state с блоком 1 |
| 4 | **Архитектор** (Architect) | Блок 1 | При блоке 1; по потоку **всегда state в нужном виде.** В ядре LLM; контекст = изменённый мир. Генерирует **конфигурацию** (блок 2) | Блок 2 |
| 5 | **Творец** (Creator) | Блок 2 | При блоке 2; по потоку **всегда state в нужном виде.** Генерация артефактов | Блок 3 |

После пятого звена state с блоком 3 (и далее по циклу) снова попадает в Философ, затем Автор, Среда, Архитектор, Творец — цикл повторяется. **Этап как фаза — первая сущность, исполняющая свою роль в этом цикле:** мир собран из этапов, каждое звено — этап.

---

## 4. State: что течёт по графу мира

По рёбрам графа мира между этапами передаётся **state**. В каноне state задаётся **пятью блоками** ([Scheme.md](Scheme.md), [System.md](System.md)):

| № | Блок |
|---|------|
| 1 | Описание того, что должно было произойти |
| 2 | Конфигурация для генерации артефактов |
| 3 | Сгенерированные артефакты |
| 4 | Описание сгенерированных артефактов |
| 5 | Описание того, что реально произошло в мире |

- **World update** (внутри этапа Среда) выполняется только при заполненном блоке 5: state применяется к миру (контент мира обновляется), state сохраняется. Иначе обновление не выполняется, state отбрасывается.
- **Development of the world** (внутри этапа Среда) создаёт **новый state** с заполненным только блоком 1; этот state передаётся по ребру мира в этап Архитектор — цикл продолжается.

Таким образом, **state** — это то, что течёт по **графу этапов** (миру); на уровне графа и пайплайна по связям текут данные, на уровне этапов и мира — state.

---

## 5. Выполнение мира: порядок и один цикл

- **Порядок выполнения** задаётся графом мира. В каноне порядок **фиксирован**: Философ → Автор → Среда → Архитектор → Творец → снова Философ → … Двух направлений графа нет; на каждом шаге мир выполняется в одном и том же порядке.
- **Один проход цикла:** state последовательно проходит этапы; каждый этап читает и/или дополняет state; после Среда (Development of the world) новый state с блоком 1 идёт в Архитектор, и цикл повторяется.
- **Action** поступает в Development of the world как контекст для LLM; опционален. Development выполняется **безусловно**. **Если пользователь не передал state** (или пустой state): на **первой итерации** пропускаются **Философ**, **Автор** и **World update**; цикл **начинается с Development of the world**, который создаёт **первый state** в мире (блок 1). Передача state пользователем (блок 1; 1–2; …; 1–2–3–4–5) определяет, какие этапы пропускаются и как применяется обновление мира. Подробно: [Scheme.md](Scheme.md) §4.8.

---

## 6. Компоненты уровня мира

- **Мир (World)** — единственная сущность уровня: граф этапов. Идентифицируется как верхняя абстракция системы (конфиг мира, имя мира, хранилище).
- **Узлы мира** — этапы. Каждый этап имеет роль (Философ, Автор, Среда, Архитектор, Творец), контракт входа/выхода по state и внутреннюю реализацию (граф пайплайнов).
- **Рёбра мира** — связи «выход этапа → вход следующего этапа»; по ним передаётся state.
- **State** — контейнер данных (пять блоков в каноне), передаваемый между этапами; при необходимости расширяется (идеальная/материальная часть, слоты артефактов и т.д. по [Scheme.md](Scheme.md)).

Сериализация мира (конфиг, шаблон, загрузка, чекпоинт): [World_Serialization.md](World_Serialization.md).

---

## 7. Сводка

| Понятие | Определение |
|---------|-------------|
| **Уровень мира** | Верхний уровень системы. Основная сущность — **World (мир)**. |
| **Мир (World)** | **Граф этапов:** узлами мира являются этапы (Философ, Автор, Среда, Архитектор, Творец в цикле). По рёбрам между этапами передаётся **state**. В каноне — циклический граф с фиксированным порядком. |
| **Этап в мире** | Каждое звено цикла — этап со своей ролью. Этап как фаза — первая сущность, исполняющая роль в цикле мира ([Stage_Level.md](Stage_Level.md)). |
| **State** | То, что течёт по графу мира между этапами (пять блоков в каноне). |
| **Выполнение** | Последовательное выполнение этапов в порядке графа; цикл повторяется; Action опционален, мир может развиваться сам. |

Граф и пайплайн: [Graph_Level.md](Graph_Level.md), [Pipeline_Level.md](Pipeline_Level.md). Этап: [Stage_Level.md](Stage_Level.md). Канон цикла и state: [Scheme.md](Scheme.md), [System.md](System.md). Сериализация: [World_Serialization.md](World_Serialization.md).
