# Расширение выше мира: Вселенная как граф миров (Graph of Worlds)

Краткие **приблизительные подсказки** по расширению Yggdrasil от верхнего уровня **Мир (World)** к уровню выше — **Вселенная (Universe)** как **граф миров** (Graph of Worlds). Граф миров — это **счёт миров** (count of worlds): множество миров, связанных в одну структуру (узлы = миры, рёбра = связи между мирами). Один мир — один цикл этапов и один state; вселенная — граф из нескольких миров с опциональным обменом по рёбрам.

**Текущий верхний уровень:** [World_Level.md](World_Level.md) — мир = граф этапов; по рёбрам передаётся state; цикл Философ → Автор → Среда → Архитектор → Творец.  
**Ниже:** [Stage_Level.md](Stage_Level.md), [Scheme.md](Scheme.md), [TODO_06_WORLD.md](TODO_06_WORLD.md).

Этот документ **не входит в канон** Scheme/Philosophy; он задаёт лишь направление расширения без изменения уже описанной иерархии.

---

## 1. Идея уровня «над миром»: граф миров и счёт миров

| Уровень | Состоит из | Что передаётся |
|---------|------------|----------------|
| **Мир (World)** | Этапов | **State** (пять блоков в каноне); один цикл. |
| **Вселенная (Universe)** | **Миров** | **Граф миров (Graph of Worlds)** = счёт миров (count of worlds): узлы — миры, рёбра — переходы или обмен (артефакты, контекст, события). |

**Вселенная** — это **граф миров**: узлы графа = отдельные миры (world_id → World), рёбра = связи между мирами. Таким образом, вселенная есть одновременно и **граф миров** (структура связей), и **счёт миров** (количество узлов графа — множество миров). Выполнение — обход графа (топологический порядок или фиксированный цикл по подмножеству миров); по рёбрам может передаваться state snapshot, артефакты или контекст.

- **Граф миров (Graph of Worlds):** явная структура: какие миры связаны с какими, что течёт по рёбрам (payload_spec). Поддержка DAG, циклических подграфов или «древа» (дерево миров).
- **Счёт миров (Count of Worlds):** число миров в графе; идентификация по world_id; каждый мир — самостоятельная единица с собственным циклом и state.

---

## 2. Сопоставление с мифологией Иггдрасиля (Yggdrasil)

В скандинавской мифологии **Иггдрасиль** (Yggdrasill) — **мировое древо**, которое соединяет и поддерживает **несколько миров (реальмов)**. Расширение «Вселенная = граф миров» напрямую сопоставляется с этой картиной.

### 2.1 Древо как граф миров

| Мифология Иггдрасиль | Уровень «Вселенная» (Graph of Worlds) |
|----------------------|---------------------------------------|
| **Мировое древо** — ось и каркас, соединяющий миры | **Граф миров** — структура данных: узлы = миры, рёбра = связи (переходы, обмен). Древо — частный случай графа (дерево с корнем и ветвями). |
| **Девять миров** (девять реальмов: Асгард, Мидгард, Хель, Альвхейм и др.) | **Счёт миров (count of worlds):** множество миров в графе; каждый world_id — один «реальм» со своим циклом (Философ → Автор → Среда → Архитектор → Творец) и своим state. |
| **Корни и ветви** соединяют миры | **Рёбра графа** (AddWorldEdge): что передаётся между мирами (артефакты, снимок state, контекст). Направление ребра = направление потока (от одного мира к другому). |
| **Три корня** Иггдрасиля уходят в разные миры (Хель, инеистые великаны, люди) | Три (или более) «корневых» мира или три направления обхода графа; либо три типа связей по рёбрам (payload_spec: state / артефакты / события). |
| **Ветви** простираются над мирами | Подграф «верхних» миров (например, миры-приёмники контекста от «нижних»); порядок обхода или иерархия по уровням графа (корень → листья). |

### 2.2 Источники и хранилища в мифе и в модели

| Мифология Иггдрасиль | Уровень «Вселенная» |
|----------------------|---------------------|
| **Источник Урд (Urðarbrunnr)** — колодец у корня, где живут норны (судьба, прошлое, будущее) | **Общий контекст вселенной** или хранилище, доступное всем мирам: глоссарий, правила, стиль, «судьба» мира (начальное содержание, политика Development). Данные из «колодца» могут подаваться в миры по рёбрам или через общий initial_world. |
| **Норны** ткут судьбы | Опционально: глобальные политики выполнения (какой мир когда запускать, условия перехода по рёбрам). Конфиг вселенной задаёт «правила обхода» графа. |
| **Орёл на вершине** и **змей Нидхёгг у корней** — противоположные силы | Два направления обхода графа (например, «вверх» по ветвям и «вниз» по корням) или два типа миров (производители артефактов vs потребители контекста). Либо метафора двух типов рёбер: восходящий / нисходящий поток. |
| **Белка Рататоск** снуёт между орлом и змеем — переносит сообщения | **Обмен по рёбрам графа:** передача артефактов или событий между мирами по payload_spec; «снуёт» = выполнение run(universe) с обходом рёбер и передачей данных. |
| **Листья Иггдрасиля** — миры или существа в мирах | Листовые узлы графа (миры без исходящих рёбер) как «конечные» миры в обходе; либо миры, которые только потребляют контекст и не отдают в другие миры. |

### 2.3 Имя и семантика

- **Yggdrasil** в проекте уже используется как имя фреймворка/древа. Уровень **Universe (Вселенная)** можно отождествить с **самим Иггдрасилем**: не один мир, а **граф миров** — древо, на котором растут миры (узлы), связанные корнями и ветвями (рёбра). Счёт миров (count of worlds) — это число «реальмов» на древе.
- **Один мир** в каноне — один цикл (Философ → Автор → Среда → Архитектор → Творец); он соответствует **одному из миров Иггдрасиля** (например, Мидгард или Асгард). **Вселенная** — целое древо: граф таких миров и связей между ними.

---

## 3. Приблизительные подсказки по реализации

### 3.1 Структура данных

- **Universe** хранит: отображение `world_id → World` (счёт миров: каждый мир — сущность с циклом, state_schema, storage). Плюс **граф миров:** рёбра (source_world_id, target_world_id, payload_spec) — что передаётся по ребру (state snapshot, артефакты, событие). Опционально порядок обхода (список world_id) для последовательного режима или для обхода «по древу».
- **Контекст вселенной (опционально):** аналог «источника Урд» — общее хранилище или каталог (глоссарий, стиль, правила); миры читают его при инициализации или по рёбрам. Либо один «корневой» мир, из которого контекст распространяется по рёбрам в остальные миры.

### 3.2 Выполнение

- **Обход графа миров:** run(universe, ...) в топологическом порядке (если DAG) или по фиксированному порядку/циклу; после run(world_A) выходы мира A по payload_spec мапятся на входы мира B по входящим рёбрам. Результат — dict[world_id, state] или агрегированный вывод.
- **Последовательный режим:** частный случай графа — линейная цепочка миров; порядок задаётся списком world_id. Рёбра (i → i+1); передача по payload_spec.
- **Параллельный запуск:** миры без рёбер между собой выполняются независимо; счёт миров сохраняется, граф задаёт только связи там, где они есть.

### 3.3 Сериализация и чекпоинт

- **Конфиг вселенной:** граф миров — список миров (world_id, конфиг мира) и список рёбер (source, target, payload_spec); опционально общий контекст. Чекпоинт = агрегация чекпоинтов всех миров (каталог по world_id). Соответствие [SERIALIZATION_AT_ALL_LEVELS.md](SERIALIZATION_AT_ALL_LEVELS.md).

### 3.4 Контракт и API

- **AddWorld(world_or_config, world_id):** добавить мир в граф (увеличить счёт миров); уникальность world_id.
- **AddWorldEdge(source_id, target_id, payload_spec):** добавить ребро графа миров; задать, что передаётся между мирами.
- **run(universe, world_inputs=None, *, num_rounds=1, ...) → results:** выполнить обход графа миров; при необходимости передать начальные входы по world_id; вернуть состояния миров или агрегированный результат.

---

## 4. Что не менять

- **Канон одного мира** ([Scheme.md](Scheme.md), [World_Level.md](World_Level.md)) остаётся без изменений: один мир = один цикл этапов, state из пяти блоков. Вселенная не заменяет мир; она — **граф миров**, т.е. счёт миров и связи между ними.
- **Философия** ([Philosophy.md](Philosophy.md)): узел вселенной = мир (целое); рёбра вселенной = связи между мирами. Граф миров согласуется с иерархией блок/узел и Lego.

---

## 5. Краткая сводка

| Вопрос | Ответ |
|--------|--------|
| **Что такое уровень выше мира?** | **Вселенная (Universe)** — **граф миров (Graph of Worlds)**, т.е. **счёт миров (count of worlds):** узлы = миры, рёбра = связи между мирами; обмен по payload_spec. |
| **Как хранить?** | world_id → World; рёбра (source_world_id, target_world_id, payload_spec); опционально общий контекст («источник Урд»). |
| **Как выполнять?** | Обход графа миров (топология или фиксированный порядок); run(universe, ...) вызывает run(world, ...) для каждого мира и передаёт данные по рёбрам. |
| **Связь с Yggdrasil?** | Иггдрасиль = мировое древо с **несколькими мирами** (девять реальмов); корни и ветви = рёбра графа; колодец Урд = общий контекст; счёт миров = число реальмов на древе. Вселенная в модели — **граф миров**, прямой аналог древа Иггдрасиль. |

Детальную реализацию (TODO уровня вселенной, валидация, обучение, multi-endpoint) можно вынести в отдельный TODO после стабилизации уровня мира (TODO_06).
