# Расширение выше мира: Вселенная как граф миров (Graph of Worlds)

**Единый канон проекта:** [CANON.md](CANON.md). Краткие **приблизительные подсказки** по расширению Yggdrasil от верхнего уровня **Мир (World)** к уровню выше — **Вселенная (Universe)** как **граф миров** (Graph of Worlds). Граф миров — это **счёт миров** (count of worlds): множество миров, связанных в одну структуру (узлы = миры, рёбра = связи между мирами). Один мир — одна цепочка переходов (один цикл) и один state; вселенная — граф из нескольких миров с опциональным обменом по рёбрам. Концепция вселенной **углублена**: проработано взаимодействие **между мирами** и **между сущностями внутри каждого мира**; на уровне вселенной **агентные системы** обеспечивают обмен данными между мирами и кросс-мировое влияние (см. п. 1.2 и [AGENT_SYSTEMS_SUPPORT.md](AGENT_SYSTEMS_SUPPORT.md)).

**Текущий верхний уровень:** [World_Level.md](World_Level.md) — мир = цепочка переходов (граф переходов); по рёбрам передаётся state; цикл Философ → Автор → Среда → Архитектор → Творец.  
**Ниже:** [Stage_Level.md](Stage_Level.md), [Scheme.md](Scheme.md), [TODO_06_WORLD.md](TODO_06_WORLD.md).  
**Структура:** [HYPERGRAPH_AND_HYPERLINKS.md](HYPERGRAPH_AND_HYPERLINKS.md) (гиперграф как движок, гиперссылки). **Фиксированные миры:** [END_WORLDS.md](END_WORLDS.md).

Этот документ задаёт направление расширения без изменения уже описанной иерархии одного мира; тезисы о вселенной, агентных системах, End Worlds и гиперграфе входят в **расширенный канон** ([AGENT_SYSTEMS_SUPPORT.md](AGENT_SYSTEMS_SUPPORT.md) §0.4, [END_WORLDS.md](END_WORLDS.md), [HYPERGRAPH_AND_HYPERLINKS.md](HYPERGRAPH_AND_HYPERLINKS.md)).

---

## 0. Этап Вселенной создан прежде всего для сообщества

Уровень **Вселенная (Universe)** предназначен в первую очередь для **сообщества пользователей**:

- **Сравнение миров:** пользователи получают возможность **сравнивать свои миры** друг с другом.
- **Развитие миров через взаимодействие:** развитие миров на основе **взаимодействия персонажей пользователей с мирами других пользователей**.
- **Единая система взаимодействий миров:** построение **единой системы мировых взаимодействий**, сложных интеграций между мирами.
- **Обмен и совместное творчество:** возможность **делиться результатами с сообществом**, обмениваться идеями, **расширять свои миры** за счёт взаимодействия с мирами других пользователей.
- **Группы миров:** формирование **групп миров** по общим идеям или сюжету.
- **Влияние на экосистему:** возможность **творчески влиять на всю экосистему** и в определённом смысле **деструктивно влиять** на неё: например, **синтезировать новые миры** из взаимодействия группы миров или, наоборот, **аннигилировать миры** в результате тех или иных взаимодействий.

На уровне Вселенной как объединения миров должен существовать **единый поток трансляции (single fluid broadcast)** всех взаимодействий, затрагивающих всю экосистему.

Для этапа Вселенной важны **децентрализация** и **полная распределённость** при сохранении всех возможностей и всех архитектурных решений нижележащих уровней, а также **полная интеграция и удобство для сообщества**.

---

## 1. Идея уровня «над миром»: граф миров и счёт миров

| Уровень | Состоит из | Что передаётся |
|---------|------------|----------------|
| **Мир (World)** | Переходов | **State** (пять блоков в каноне); один цикл (цепочка переходов). |
| **Вселенная (Universe)** | **Миров** | **Граф миров (Graph of Worlds)** = счёт миров (count of worlds): узлы — миры, рёбра — переходы или обмен (артефакты, контекст, события, сущности). |

**Вселенная** — это **граф миров**: узлы графа = отдельные миры (world_id → World), рёбра = связи между мирами. Таким образом, вселенная есть одновременно и **граф миров** (структура связей), и **счёт миров** (количество узлов графа — множество миров). Выполнение — обход графа (топологический порядок или фиксированный цикл по подмножеству миров); по рёбрам может передаваться state snapshot, артефакты, контекст, а также **сущности** (персонажи, агенты), способные действовать в другом мире и влиять на историю обоих миров.

- **Гиперграф миров:** вселенная как **гиперграф** ([HYPERGRAPH_AND_HYPERLINKS.md](HYPERGRAPH_AND_HYPERLINKS.md)): вершины = миры (в т.ч. **End Worlds** — фиксированные, неизменяемые миры); гиперрёбра = связи между мирами и групповые связи; **гиперссылки** — связывание контекстов и взаимодействие (в т.ч. ссылки на End Worlds). Граф миров — представление при гиперрёбрах размера 2.
- **Граф миров (Graph of Worlds):** явная структура: какие миры связаны с какими, что течёт по рёбрам (payload_spec). Поддержка DAG, циклических подграфов или «древа». Семантика: передача данных, **взаимодействие между мирами**, **взаимодействие между сущностями** внутри каждого мира; поддержка **End Worlds** и **гиперссылок** на них.
- **Счёт миров (Count of Worlds):** число миров в графе/гиперграфе; идентификация по world_id; каждый мир — самостоятельная единица. Миры могут быть **объектными** (развиваются, state обновляется) или **End Worlds** (фиксированы, только чтение; см. [END_WORLDS.md](END_WORLDS.md)).

### 1.1 Взаимодействие между мирами и между сущностями

- **Между мирами:** по рёбрам графа задаётся не только тип передаваемых данных (payload_spec), но и **условия и порядок взаимодействия**: когда мир B получает входы от мира A; как обновляется state мира A после «раунда» во вселенной (например, при возврате сущности или отражении событий из B). Контракт вселенной должен явно описывать **направление влияния** (A → B, B → A, двунаправленное) и **момент синхронизации** (после run(world_A), после run(world_B), после полного обхода подграфа).
- **Между сущностями внутри мира:** канон мира (Scheme, state) определяет, как сущности (персонажи, агенты, артефакты) участвуют в переходах и в state. При расширении до вселенной сущности могут быть **помечены происхождением** (например, entity.origin_world_id); правила мира могут по-разному обрабатывать «локальных» и «пришлых» сущностей. Взаимодействие между сущностями разных миров происходит через **переход сущности по ребру** (из мира A в мир B) и обратное отражение событий в мир A.

### 1.2 Агентные системы на уровне вселенной: обмен данными и кросс-мировое влияние

- **Агентные системы** на уровне вселенной обеспечивают **обмен данными и информацией между мирами** в контексте действий в отдельном мире ([AGENT_SYSTEMS_SUPPORT.md](AGENT_SYSTEMS_SUPPORT.md) §0.4). То есть сущности (агенты, персонажи), способные к действиям и имеющие состояние, могут «перемещаться» между мирами (по рёбрам графа); их действия в целевом мире влияют на этот мир, а связь с миром исхода — на историю в мире исхода.
- **Пример (канон):** персонаж (character) принадлежит миру A. Персонаж **переходит** в мир B (по ребру A → B, с передачей сущности в payload_spec). В мире B действия персонажа влияют на **ход истории мира B** и меняют его state. Одновременно, поскольку персонаж пришёл из мира A, **история персонажа в мире A также меняется**: например, факт отсутствия в A, последствия возврата, отражение ключевых событий из B в биографии/state, привязанной к A. Итого: одна сущность, переместившаяся из мира A в мир B, влияет и на историю мира B (где она действует), и на свою историю в мире A (откуда пришла). Реализация предполагает: (1) payload_spec для рёбер, допускающий передачу сущностей с состоянием и origin_world_id; (2) правила обновления state мира A при «отсутствии» сущности и при получении обратной связи с мира B; (3) согласованность с агентными системами (персонаж может быть агентом с инструментами, действующим в контексте мира B).

### 1.3 End Worlds (миры-завершения): фиксированные миры и связь с объектными мирами

- **End Worlds** должны поддерживаться: это миры, которые **не изменяются** и **фиксированы**, но к ним можно **привязываться** и с ними можно **взаимодействовать** со стороны объектных миров (миров, которые развиваются). End World сам **не меняется**; объектный мир (Near World), связываясь с End World по **гиперссылке**, обогащает свой контекст и истории своих персонажей. Подробно: [END_WORLDS.md](END_WORLDS.md).
- **Пример:** персонаж A из объектного мира (Mirror World / Near World) в **диалоге с персонажем B** отсылает к End World — например, к **книге** (книга = фиксированный, неизменяемый мир). Диалог обогащается контекстом книги; истории персонажей A и B в объектном мире обогащаются. **Книга (End World) не меняется.** End World существует как сущность в мировом классе; связь с ним — через **крупномасштабные гиперссылки** ([HYPERGRAPH_AND_HYPERLINKS.md](HYPERGRAPH_AND_HYPERLINKS.md)). В гиперграфе миров вершины могут быть типа «объектный мир» или «End World»; гиперссылки из мира/персонажа на End World разрешаются при выполнении (чтение контекста).

---

## 2. Сопоставление с мифологией Иггдрасиля (Yggdrasil)

В скандинавской мифологии **Иггдрасиль** (Yggdrasill) — **мировое древо**, которое соединяет и поддерживает **несколько миров (реальмов)**. Расширение «Вселенная = граф миров» напрямую сопоставляется с этой картиной.

### 2.1 Древо как граф миров

| Мифология Иггдрасиль | Уровень «Вселенная» (Graph of Worlds) |
|----------------------|---------------------------------------|
| **Мировое древо** — ось и каркас, соединяющий миры | **Граф миров** — структура данных: узлы = миры, рёбра = связи (переходы, обмен). Древо — частный случай графа (дерево с корнем и ветвями). |
| **Девять миров** (девять реальмов: Асгард, Мидгард, Хель, Альвхейм и др.) | **Счёт миров (count of worlds):** множество миров в графе; каждый world_id — один «реальм» со своим циклом (Философ → Автор → Среда → Архитектор → Творец) и своим state. |
| **Корни и ветви** соединяют миры | **Рёбра графа** (AddWorldEdge): что передаётся между мирами (артефакты, снимок state, контекст). Направление ребра = направление потока (от одного мира к другому). |
| **Три корня** Иггдрасиля уходят в разные миры (Хель, инеистые великаны, люди) | Три (или более) «корневых» мира или три направления обхода графа; либо три типа связей по рёбрам (payload_spec: state / артефакты / события). |
| **Ветви** простираются над мирами | Подграф «верхних» миров (например, миры-приёмники контекста от «нижних»); порядок обхода или иерархия по уровням графа (корень → листья). |

### 2.2 Источники и хранилища в мифе и в модели

| Мифология Иггдрасиль | Уровень «Вселенная» |
|----------------------|---------------------|
| **Источник Урд (Urðarbrunnr)** — колодец у корня, где живут норны (судьба, прошлое, будущее) | **Общий контекст вселенной** или хранилище, доступное всем мирам: глоссарий, правила, стиль, «судьба» мира (начальное содержание, политика Development). Данные из «колодца» могут подаваться в миры по рёбрам или через общий initial_world. |
| **Норны** ткут судьбы | Опционально: глобальные политики выполнения (какой мир когда запускать, условия перехода по рёбрам). Конфиг вселенной задаёт «правила обхода» графа. |
| **Орёл на вершине** и **змей Нидхёгг у корней** — противоположные силы | Два направления обхода графа (например, «вверх» по ветвям и «вниз» по корням) или два типа миров (производители артефактов vs потребители контекста). Либо метафора двух типов рёбер: восходящий / нисходящий поток. |
| **Белка Рататоск** снуёт между орлом и змеем — переносит сообщения | **Обмен по рёбрам графа:** передача артефактов или событий между мирами по payload_spec; «снуёт» = выполнение run(universe) с обходом рёбер и передачей данных. |
| **Листья Иггдрасиля** — миры или существа в мирах | Листовые узлы графа (миры без исходящих рёбер) как «конечные» миры в обходе; либо миры, которые только потребляют контекст и не отдают в другие миры. |

### 2.3 Имя и семантика

- **Yggdrasil** в проекте уже используется как имя фреймворка/древа. Уровень **Universe (Вселенная)** можно отождествить с **самим Иггдрасилем**: не один мир, а **граф миров** — древо, на котором растут миры (узлы), связанные корнями и ветвями (рёбра). Счёт миров (count of worlds) — это число «реальмов» на древе.
- **Один мир** в каноне — один цикл (Философ → Автор → Среда → Архитектор → Творец); он соответствует **одному из миров Иггдрасиля** (например, Мидгард или Асгард). **Вселенная** — целое древо: граф таких миров и связей между ними.

---

## 3. Приблизительные подсказки по реализации

### 3.1 Структура данных

- **Universe** хранит: отображение `world_id → World` (счёт миров: каждый мир — сущность с циклом, state_schema, storage). Плюс **граф миров:** рёбра (source_world_id, target_world_id, payload_spec) — что передаётся по ребру (state snapshot, артефакты, событие). Опционально порядок обхода (список world_id) для последовательного режима или для обхода «по древу».
- **Контекст вселенной (опционально):** аналог «источника Урд» — общее хранилище или каталог (глоссарий, стиль, правила); миры читают его при инициализации или по рёбрам. Либо один «корневой» мир, из которого контекст распространяется по рёбрам в остальные миры.

### 3.2 Выполнение

- **Обход графа миров:** run(universe, ...) в топологическом порядке (если DAG) или по фиксированному порядку/циклу; после run(world_A) выходы мира A по payload_spec мапятся на входы мира B по входящим рёбрам. Результат — dict[world_id, state] или агрегированный вывод.
- **Последовательный режим:** частный случай графа — линейная цепочка миров; порядок задаётся списком world_id. Рёбра (i → i+1); передача по payload_spec.
- **Параллельный запуск:** миры без рёбер между собой выполняются независимо; счёт миров сохраняется, граф задаёт только связи там, где они есть.

### 3.3 Сериализация и чекпоинт

- **Конфиг вселенной:** граф миров — список миров (world_id, конфиг мира) и список рёбер (source, target, payload_spec); опционально общий контекст. Чекпоинт = агрегация чекпоинтов всех миров (каталог по world_id). Соответствие [SERIALIZATION_AT_ALL_LEVELS.md](SERIALIZATION_AT_ALL_LEVELS.md).

### 3.4 Контракт и API

- **AddWorld(world_or_config, world_id):** добавить мир в граф (увеличить счёт миров); уникальность world_id.
- **AddWorldEdge(source_id, target_id, payload_spec):** добавить ребро графа миров; задать, что передаётся между мирами.
- **run(universe, world_inputs=None, *, num_rounds=1, ...) → results:** выполнить обход графа миров; при необходимости передать начальные входы по world_id; вернуть состояния миров или агрегированный результат.

---

## 4. Что не менять

- **Канон одного мира** ([Scheme.md](Scheme.md), [World_Level.md](World_Level.md)) остаётся без изменений: один мир = одна цепочка переходов (один цикл), state из пяти блоков. Вселенная не заменяет мир; она — **граф миров**, т.е. счёт миров и связи между ними.
- **Философия** ([Philosophy.md](Philosophy.md)): узел вселенной = мир (целое); рёбра вселенной = связи между мирами. Граф миров согласуется с иерархией блок/узел и Lego.

---

## 5. Краткая сводка

| Вопрос | Ответ |
|--------|--------|
| **Что такое уровень выше мира?** | **Вселенная (Universe)** — **граф миров (Graph of Worlds)**, т.е. **счёт миров (count of worlds):** узлы = миры, рёбра = связи между мирами; обмен по payload_spec (в т.ч. сущности с состоянием). Глубоко проработано **взаимодействие между мирами** и **между сущностями** каждого мира; агентные системы обеспечивают обмен данными и кросс-мировое влияние (§1.1–1.2). |
| **Как хранить?** | world_id → World; рёбра (source_world_id, target_world_id, payload_spec); опционально общий контекст («источник Урд»). payload_spec может включать передачу сущностей (entity, origin_world_id). |
| **Как выполнять?** | Обход графа миров (топология или фиксированный порядок); run(universe, ...) вызывает run(world, ...) для каждого мира и передаёт данные по рёбрам; при переходе сущностей — обновление state мира-источника и мира-назначения по правилам кросс-мирового влияния. |
| **Связь с Yggdrasil?** | Иггдрасиль = мировое древо с **несколькими мирами** (девять реальмов); корни и ветви = рёбра графа; колодец Урд = общий контекст; счёт миров = число реальмов на древе. Вселенная в модели — **граф миров**, прямой аналог древа Иггдрасиль. |
| **Роль агентных систем?** | На уровне вселенной агенты/персонажи могут перемещаться между мирами; их действия в мире B влияют на историю B и на свою историю в мире A (§1.2, [AGENT_SYSTEMS_SUPPORT.md](AGENT_SYSTEMS_SUPPORT.md) §0.4). |
| **Для чего этап Вселенной?** | **Прежде всего для сообщества:** сравнение миров, развитие миров через взаимодействие персонажей с мирами других пользователей, единая система мировых взаимодействий, обмен результатами и идеями, группы миров (общие идеи/сюжет), творческое и деструктивное влияние на экосистему (синтез новых миров, аннигиляция миров). **Единый поток трансляции** всех взаимодействий; **децентрализация** и **полная распределённость** при сохранении возможностей нижележащих уровней и удобстве для сообщества (§0). |
| **End Worlds?** | **Поддержка End Worlds:** фиксированные, неизменяемые миры; к ним можно привязываться и с ними взаимодействовать (читать контекст); объектный мир обогащает свои истории и контекст, End World не меняется. Гиперссылки на End Worlds. См. [END_WORLDS.md](END_WORLDS.md), §1.3. |
| **Гиперграф и гиперссылки?** | Вселенная и вся структура фреймворка — **гиперграф**; **крупномасштабные гиперссылки** для связывания контекстов и взаимодействия. См. [HYPERGRAPH_AND_HYPERLINKS.md](HYPERGRAPH_AND_HYPERLINKS.md). |

Детальную реализацию (TODO уровня вселенной, валидация, обучение, multi-endpoint) можно вынести в отдельный TODO после стабилизации уровня мира (TODO_06).
