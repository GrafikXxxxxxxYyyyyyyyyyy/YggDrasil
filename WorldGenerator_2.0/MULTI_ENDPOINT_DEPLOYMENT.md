# Развёртывание на нескольких эндпоинтах

**Требование:** система должна давать возможность **запуска проекта на нескольких эндпоинтах**. Идеально — **каждый граф всего проекта может быть развёрнут на своём эндпоинте** при **полном сохранении корректной работы всей системы** (поведение, поток state, семантика цикла не меняются).

Канон: [WorldGenerator_2.0/](../WorldGenerator_2.0/) (Scheme, Graph_Level, Pipeline_Level, Stage_Level, World_Level). Сериализуемость: [SERIALIZATION_AT_ALL_LEVELS.md](SERIALIZATION_AT_ALL_LEVELS.md).

---

## 1. Цель

- **Масштабирование:** тяжёлые графы (например, диффузия, кодек) вынести на отдельные сервисы/машины.
- **Гибкость развёртывания:** один граф — один эндпоинт; пайплайн/этап/мир могут объединять вызовы нескольких эндпоинтов.
- **Эквивалентность:** поведение системы при распределённом развёртывании (каждый граф на своём эндпоинте) **эквивалентно** поведению при запуске всего в одном процессе — без потери корректности и без изменения семантики.

---

## 2. Принцип: каждый граф — свой эндпоинт

Необходимо обеспечить **реализацию системы инференса** так, чтобы **каждый граф проекта мог быть реализован (развёрнут) на своём эндпоинте**:

- **Граф** (одна задача: text-to-image, upscale, encode/decode и т.д.) — естественная единица развёртывания: сериализуем, имеет чёткие входы/выходы, один вызов = один run.
- **Пайплайн** при распределённом запуске: узлы пайплайна = графы; каждый такой граф может быть сервисом на своём URL; оркестратор передаёт выход одного эндпоинта на вход следующего.
- **Этап / мир:** этап — граф пайплайнов; пайплайн может вызывать удалённые графы; между этапами передаётся state (сериализуемый), поэтому state можно передавать между эндпоинтами (другой сервис или тот же).

Итого: **каждый граф в проекте** (на уровне графа, внутри пайплайна или внутри этапа) **может быть вынесен на отдельный эндпоинт**; остальная система строится как оркестрация вызовов этих эндпоинтов с сохранением порядка и контрактов.

---

## 3. Сохранение работы системы

При разнесении графов по эндпоинтам необходимо **полностью сохранить**:

- **Порядок выполнения:** топология графа/пайплайна/этапа/цикла мира не меняется; данные и state передаются в том же порядке.
- **Контракты:** входы/выходы каждого графа (порты, типы, схема state) те же, что и при локальном выполнении; сериализация данных при передаче между эндпоинтами (например, JSON, бинарные артефакты по ссылкам или base64).
- **Семантика цикла мира:** если мир развёрнут распределённо (этапы или графы внутри этапов на разных эндпоинтах), цикл Философ → Автор → Среда → Архитектор → Творец и правила выполнения этапов (условия по блокам state, World update только при полном state, Development безусловно) сохраняются; state передаётся между эндпоинтами как единый сериализуемый объект.

Таким образом, **распределённое развёртывание не меняет наблюдаемого поведения** системы — только способ вызова (локальный вызов vs HTTP/gRPC к эндпоинту).

---

## 4. Следствия для реализации

- **Интерфейс графа как сервиса:** у каждого графа — контракт вход/выход (имена и типы портов); при развёртывании на эндпоинте граф экспонирует API (например, POST с входными данными → ответ с выходными). Конфиг графа и контракт сериализуемы ([SERIALIZATION_AT_ALL_LEVELS.md](SERIALIZATION_AT_ALL_LEVELS.md)).
- **Оркестратор пайплайна/этапа/мира:** при выполнении пайплайна (или этапа, мира) оркестратор для каждого узла-графа знает: локальный граф или URL эндпоинта; если URL — выполняет запрос к эндпоинту, передаёт выход предыдущего шага на вход следующего; при необходимости сериализует/десериализует state.
- **Реестр эндпоинтов:** в конфиге пайплайна/этапа/мира можно задать для каждого графа либо локальную реализацию, либо `endpoint_url`; загрузка и запуск графа на этом URL — отдельная задача развёртывания (контейнер, сервер функции и т.д.).

Итого: необходимо иметь **возможность реализации инференса** так, чтобы **каждый граф проекта мог быть развёрнут на своём эндпоинте**, а система в целом работала корректно за счёт оркестрации вызовов и единого контракта (и сериализуемости) на всех уровнях.
